name: Extract DSM
on:
    push:
        branches:
            - RAC-202
        # paths:
        #     - 'akeneo-design-system/**'
jobs:
    build:
        name: Create a lib build
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout current branch
                uses: actions/checkout@v2
            -   name: Use Node.js 13
                uses: actions/setup-node@v1
                with:
                    node-version: 13.13
            -   name: Install Packages
                run: cd akeneo-design-system && yarn install
            -   name: Build library
                run: cd akeneo-design-system && yarn run lib:build:prod
            -   uses: actions/upload-artifact@v1
                with:
                    name: Lib
                    path: akeneo-design-system/lib
    bump:
        name: Bump package version
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout current branch
                uses: actions/checkout@v2
            -   name: Checkout external repo
                uses: actions/checkout@v2
                with:
                    repository: 'samirboulil/dsm'
                    path: external
            -   name: Bump package version
                run: cd akeneo-design-system && node .github/workflows/bump-version.js $GITHUB_EVENT_PATH ../external/package.json
            -   uses: actions/upload-artifact@v1
                with:
                    name: package
                    path: akeneo-design-system/package.json
    extract:
        name: Extract to DSM dedicated repo
        needs:
            - build
            - bump
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout the current branch
                uses: actions/checkout@v2.3.2
            -   name: Download the lib artifact
                uses: actions/download-artifact@v1
                with:
                    name: Lib
                    path: akeneo-design-system/lib
            -   name: Bump package version
                run: rm akeneo-design-system/package.json
            -   name: Download the package.json artifact
                uses: actions/download-artifact@v1
                with:
                    name: package
                    path: akeneo-design-system
            -   name: Pushes to dsm repository
                uses: ./.github/actions/extract
                env:
                    API_TOKEN_GITHUB: ${{ secrets.API_TOKEN_GITHUB }}
                with:
                    source-directory: akeneo-design-system
                    destination-github-username: 'samirboulil'
                    destination-repository-name: 'dsm'
                    user-email: contact@akeneo.com
                    destination-branch: 'master'
