ServerRoot "/usr/local/apache2"

Listen 80

LoadModule allowmethods_module modules/mod_allowmethods.so
LoadModule access_compat_module modules/mod_access_compat.so
LoadModule auth_basic_module modules/mod_auth_basic.so
LoadModule authn_core_module modules/mod_authn_core.so
LoadModule authn_file_module modules/mod_authn_file.so
LoadModule authz_core_module modules/mod_authz_core.so
LoadModule authz_groupfile_module modules/mod_authz_groupfile.so
LoadModule authz_host_module modules/mod_authz_host.so
LoadModule authz_user_module modules/mod_authz_user.so
LoadModule autoindex_module modules/mod_autoindex.so
LoadModule deflate_module modules/mod_deflate.so
LoadModule env_module modules/mod_env.so
LoadModule expires_module modules/mod_expires.so
LoadModule filter_module modules/mod_filter.so
LoadModule headers_module modules/mod_headers.so
LoadModule log_config_module modules/mod_log_config.so
LoadModule mime_module modules/mod_mime.so
LoadModule mpm_prefork_module modules/mod_mpm_prefork.so
LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_fcgi_module modules/mod_proxy_fcgi.so
LoadModule reqtimeout_module modules/mod_reqtimeout.so
LoadModule rewrite_module modules/mod_rewrite.so
LoadModule setenvif_module modules/mod_setenvif.so
LoadModule unixd_module modules/mod_unixd.so
LoadModule version_module modules/mod_version.so

ServerTokens ProductOnly
ServerSignature Off
TraceEnable Off

<IfModule unixd_module>
    User daemon
    Group daemon
</IfModule>

ServerAdmin you@example.com

<Files ".ht*">
    Require all denied
</Files>

ErrorLogFormat "{ \"time\" : \"[%{u}t]\", \"function\" : \"[%-m:%l]\" , \"process\" : \"[pid %P:tid %T]\" , \"message\" : \"%M\" ,\ \"referer\"\ : \"%{Referer}i\" },"

ErrorLog /proc/self/fd/2

LogLevel warn

<IfModule log_config_module>
    # Simple common: LogFormat "%h %l %u %t \"%r\" %>s %b" common
    # CustomLog /proc/self/fd/1 common

    # Note also that httpd will escape " to \", plus various others... (see the docs),
    # which (almost) matches up with JSON's requirements, with the exception of
    # \xXX (should be \x00XX in JSON) and \v (should be \u0013 in JSON)
    #
    # THINGS TO NOTE/CHECK/ADD/REMOVE:
    #    Any particular HTTP request headers (particularly for servers behind a reverse proxy)
    #       The REMOTE_USER example shows this (for things protected by a type of web SSO)
    # Need mod_logio
    # \"bytes_in\":\"%I\", \
    # \"bytes_out\":\"%O\", \

    LogFormat "{ \"http\": { \"@timestamp\":\"%{%FT%T%z}t\", \
\"client_ip\":\"%a\", \
\"client_port\":\"%{remote}p\", \
\"server_ip\":\"%A\", \
\"X-Forwarded-For\":\"%{X-Forwarded-For}i\", \
\"X-Forwarded-Proto\":\"%{X-Forwarded-Proto}i\", \
\"user\":\"%u\", \
\"REMOTE_USER\":\"%{REMOTE_USER}i\", \
\"BAPID\":\"%{BAPID}C\", \
\"pid\":\"%p\", \
\"protocol\":\"%H\", \
\"http_method\":\"%m\", \
\"vhost\":\"%{Host}i\", \
\"service_port\":\"%p\", \
\"path\":\"%U\", \
\"query_string\":\"%q\", \
\"referer\":\"%{Referer}i\", \
\"user_agent\":\"%{User-agent}i\", \
\"response_code\":\"%>s\", \
\"response_location\":\"%{Location}o\", \
\"Content-Type\":\"%{Content-Type}o\", \
\"keepalive\":\"%X\", \
\"duration_micros\":\"%D\" } }" fluentd_json

    CustomLog /proc/self/fd/1  fluentd_json

</IfModule>

<IfModule headers_module>
    RequestHeader unset Proxy early
    Header set X-Frame-Options: "sameorigin"
</IfModule>

<IfModule mime_module>
    TypesConfig conf/mime.types
</IfModule>

TimeOut 300
ProxyTimeout 300

<FilesMatch \.php$>
    SetHandler "proxy:fcgi://${FPM_HOST}:9000"
    # XXX FIXME : Should we set a longer timeout for fpm
</FilesMatch>

<IfModule dir_module>
    DirectoryIndex index.html index.php app.php
</IfModule>

<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType application/javascript "access plus 4 hours"
    ExpiresByType text/css "access plus 4 hours"
    ExpiresByType image/gif "access plus 4 hours"
    ExpiresByType image/svg+xml "access plus 4 hours"
    ExpiresByType image/png "access plus 4 hours"
    ExpiresByType application/x-font-ttf "access plus 1 week"
</IfModule>

<IfModule mod_deflate.c>
    FilterDeclare COMPRESS
    FilterProvider  COMPRESS  DEFLATE "%{Content_Type} = 'text/html'"
    FilterProvider  COMPRESS  DEFLATE "%{Content_Type} = 'text/css'"
    FilterProvider  COMPRESS  DEFLATE "%{Content_Type} = 'text/x-component'"
    FilterProvider  COMPRESS  DEFLATE "%{Content_Type} = 'application/javascript'"
    FilterProvider  COMPRESS  DEFLATE "%{Content_Type} = 'application/json'"
    FilterProvider  COMPRESS  DEFLATE "%{Content_Type} = 'image/svg+xml'"
    FilterProvider  COMPRESS  DEFLATE "%{Content_Type} = 'application/x-font-ttf'"
    FilterChain COMPRESS
    FilterProtocol  COMPRESS  DEFLATE change=yes;byteranges=no
</IfModule>

SetEnvIf Authorization .+ HTTP_AUTHORIZATION=$0

<VirtualHost *:80>
    ServerName localhost
    DocumentRoot /var/www/html/web

    <Directory /var/www/html/web>
        RewriteEngine On
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteRule ^(.*)$ app.php [QSA,L]
        Require all granted
        AllowOverride None
        AllowMethods GET POST PUT HEAD DELETE PATCH
    </Directory>
    LogLevel warn
</VirtualHost>
