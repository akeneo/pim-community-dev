apiVersion: cloudfunctions.cnrm.cloud.google.com/v1beta1
kind: CloudFunctionsFunction
metadata:
  name: {{ include "timmy.cloudFunctionName" . }}
  namespace: {{ .Release.Namespace | quote }}
  annotations:
    argocd.argoproj.io/sync-wave: "1"
    argocd.argoproj.io/sync-options: Replace=true
spec:
  projectRef:
    external: "projects/{{ .Values.common.gcpProjectID }}"
  description: {{ .Values.cloudFunction.description }}
  availableMemoryMb: {{ .Values.cloudFunction.availableMemoryMb }}
  region: {{ .Values.common.region }}
  runtime: {{ .Values.cloudFunction.runtime }}
  sourceArchiveUrl: "gs://{{ include "timmy.bucketName" . }}/{{ include "timmy.cloudFunctionName" . }}.zip"
  entryPoint: {{ .Values.cloudFunction.entryPoint }}
  serviceAccountRef:
    external: "{{ .Values.cloudFunction.serviceAccountEmail }}"
  environmentVariables:
    {{- toYaml .Values.cloudFunction.environmentVariables | nindent 4 }}
    PROJECT_ID: {{ .Values.common.gcpProjectID }}
  httpsTrigger:
    securityLevel: SECURE_ALWAYS
  ingressSettings: ALLOW_ALL
