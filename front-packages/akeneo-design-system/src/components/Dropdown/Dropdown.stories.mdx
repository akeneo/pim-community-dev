import {useState, useCallback} from 'react';
import {Meta, Story, ArgsTable, Canvas} from '@storybook/addon-docs/blocks';
import {Dropdown} from './Dropdown';
import {Button, Image, Badge, Link, Checkbox, Search} from '../../components';
import {useBooleanState} from '../../hooks';
import {SpaceContainer, useSelection} from '../../storybook';
import {ArrowDownIcon} from '../../icons';
import {action} from '@storybook/addon-actions';
import {usePaginatedResults, useDebounce} from './usePaginatedResults';

<Meta
  title="Components/Dropdown"
  subcomponents={{
    Dropdown: Dropdown,
    'Dropdown.Header': Dropdown.Header,
    'Dropdown.Title': Dropdown.Title,
    'Dropdown.Overlay': Dropdown.Overlay,
    'Dropdown.ItemCollection': Dropdown.ItemCollection,
    'Dropdown.Item': Dropdown.Item,
  }}
  parameters={{docs: {inlineStories: false}}}
/>

# Dropdown (Beta)

## Usage

The dropdown shows a list of options that can be used to select, filter or sort content.

### Dropdown options

The dropdown option should fit in one single line. If there are several lines, limit it by adding an ellipsis for the overflowing content. We display the full text on hover. We recommend that you present the options by alphabetical order.

### Interaction

By default, the dropdown list displays a label on closing. An open dropdown menu appears on the click. The open dropdown should appear above all other elements of the user interface. They can be close by clicking outside the dropdown element.

Selecting an item close the dropdown, and the selected option will replace the placeholder.

### Microcopy

**Ellipsis:** If the text is too long, we use an ellipsis.

For accessibility reasons, we must put the full text in an HTML title attribute.

**Punctuation:** Never use punctuation in a dropdown list.

## Playground

<Canvas>
  <Story name="Standard" height={260}>
    {args => {
      const [isOpen, open, close] = useBooleanState(true);
      return (
        <SpaceContainer height={200}>
          <Dropdown {...args}>
            <Button onClick={open}>
              Dropdown <ArrowDownIcon />
            </Button>
            {isOpen && (
              <Dropdown.Overlay verticalPosition="down" onClose={close}>
                <Dropdown.Header>
                  <Dropdown.Title>Elements</Dropdown.Title>
                </Dropdown.Header>
                <Dropdown.ItemCollection>
                  <Dropdown.Item onClick={action('Clicked')}>Item 1</Dropdown.Item>
                  <Dropdown.Item>Item 2</Dropdown.Item>
                  <Dropdown.Item>Item 3</Dropdown.Item>
                  <Dropdown.Item>Item 4</Dropdown.Item>
                </Dropdown.ItemCollection>
              </Dropdown.Overlay>
            )}
          </Dropdown>
        </SpaceContainer>
      );
    }}
  </Story>
</Canvas>

<ArgsTable story="Standard" />

## Simple Item

<Canvas>
  <Story name="Simple Item" height={260}>
    {args => {
      const [isOpen, open, close] = useBooleanState(true);
      return (
        <SpaceContainer height={200}>
          <Dropdown>
            <Button onClick={open}>
              Simple <ArrowDownIcon />
            </Button>
            {isOpen && (
              <Dropdown.Overlay verticalPosition="down" onClose={close}>
                <Dropdown.Header>
                  <Dropdown.Title>Elements</Dropdown.Title>
                </Dropdown.Header>
                <Dropdown.ItemCollection>
                  <Dropdown.Item>First item</Dropdown.Item>
                  <Dropdown.Item onClick={action('Clicked')}>A very long item</Dropdown.Item>
                  <Dropdown.Item onClick={action('Clicked')} disabled={true}>
                    This one is disabled
                  </Dropdown.Item>
                  <Dropdown.Item>
                    <Link target="_blank" href="https://www.youtube.com/watch?v=dQw4w9WgXcQ">
                      Item with a link
                    </Link>
                  </Dropdown.Item>
                  <Dropdown.Item disabled={true}>
                    <Link href="https://www.youtube.com/watch?v=dQw4w9WgXcQ">Disabled link</Link>
                  </Dropdown.Item>
                </Dropdown.ItemCollection>
              </Dropdown.Overlay>
            )}
          </Dropdown>
        </SpaceContainer>
      );
    }}
  </Story>
</Canvas>

## With Sections

<Canvas>
  <Story name="With Sections" height={260}>
    {args => {
      const fetchItems = async (page) => {
        if (page > 3) return Promise.resolve([]);
        return new Promise(resolve => {
          setTimeout(
            () =>
              resolve([
                {
                  id: `${page} name`,
                  text: `${page} Name`,
                },
                {
                  id: `${page} collection`,
                  text: 'Collection',
                },
                {
                  id: `${page} description`,
                  text: 'Description',
                },
                {
                  id: `${page} brand`,
                  text: 'Brand',
                },
                {
                  id: `${page} response_time`,
                  text: 'Response time (ms)',
                },
                {
                  id: `${page} variation_name`,
                  text: 'Variant Name',
                },
                {
                  id: `${page} variation_description`,
                  text: 'Variant description',
                },
                {
                  id: `${page} release_date`,
                  text: 'Release date',
                },
                {
                  id: `${page} name2`,
                  text: `${page} Name`,
                },
                {
                  id: `${page} collection2`,
                  text: 'Collection',
                },
                {
                  id: `${page} description2`,
                  text: 'Description',
                },
                {
                  id: `${page} brand2`,
                  text: 'Brand',
                },
                {
                  id: `${page} response_time2`,
                  text: 'Response time (ms)',
                },
                {
                  id: `${page} variation_name2`,
                  text: 'Variant Name',
                },
                {
                  id: `${page} variation_description2`,
                  text: 'Variant description',
                },
                {
                  id: `${page} release_date2`,
                  text: 'Release date',
                },
                {
                  id: `${page} name3`,
                  text: `${page} Name`,
                },
                {
                  id: `${page} collection3`,
                  text: 'Collection',
                },
                {
                  id: `${page} description3`,
                  text: 'Description',
                },
                {
                  id: `${page} brand3`,
                  text: 'Brand',
                },
                {
                  id: `${page} response_time3`,
                  text: 'Response time (ms)',
                },
                {
                  id: `${page} variation_name3`,
                  text: 'Variant Name',
                },
                {
                  id: `${page} variation_description3`,
                  text: 'Variant description',
                },
                {
                  id: `${page} release_date3`,
                  text: 'Release date',
                },
              ]),
            200
          );
        });
      };
      const [isOpen, open, close] = useBooleanState(true);
      const [searchValue, setSearchValue] = useState('');
      const debouncedSearchValue = useDebounce(searchValue)
      const [items, handleNextPage] = usePaginatedResults(useCallback((page) => {
        return fetchItems(page, debouncedSearchValue);
      }, [debouncedSearchValue]));
      return (
        <SpaceContainer height={200}>
          <Dropdown>
            <Button onClick={() => {
              open();
              searchValue('');
            }}>
              Simple <ArrowDownIcon />
            </Button>
            {isOpen && (
              <Dropdown.Overlay verticalPosition="down" onClose={close}>
                <Dropdown.Header>
                  <Search
                    onSearchChange={setSearchValue}
                    placeholder="Search"
                    searchValue={searchValue}
                    title="Search"
                  />
                </Dropdown.Header>
                <Dropdown.ItemCollection onNextPage={handleNextPage}>
                  {items.map((item, index) => (
                    <Dropdown.Item key={index}>{item.text}</Dropdown.Item>
                  ))}
                </Dropdown.ItemCollection>
              </Dropdown.Overlay>
            )}
          </Dropdown>
        </SpaceContainer>
      );
    }}
  </Story>
</Canvas>

## Selectable Item

<Canvas>
  <Story name="Item with selection" height={260}>
    {args => {
      const [isOpen, open, close] = useBooleanState(true);
      const firstSelection = useSelection();
      const secondSelection = useSelection();
      const thirdSelection = useSelection();
      const fourthSelection = useSelection();
      return (
        <SpaceContainer height={200}>
          <Dropdown>
            <Button onClick={open}>
              Selectable <ArrowDownIcon />
            </Button>
            {isOpen && (
              <Dropdown.Overlay verticalPosition="down" onClose={close}>
                <Dropdown.Header>
                  <Dropdown.Title>Elements</Dropdown.Title>
                </Dropdown.Header>
                <Dropdown.ItemCollection>
                  <Dropdown.Item>
                    <Checkbox {...firstSelection} /> Item 1
                  </Dropdown.Item>
                  <Dropdown.Item>
                    <Checkbox {...secondSelection} /> Item 2
                  </Dropdown.Item>
                  <Dropdown.Item disabled={true}>
                    <Checkbox {...thirdSelection} /> Item 3
                  </Dropdown.Item>
                  <Dropdown.Item>
                    <Checkbox {...fourthSelection} /> Item 4
                  </Dropdown.Item>
                </Dropdown.ItemCollection>
              </Dropdown.Overlay>
            )}
          </Dropdown>
        </SpaceContainer>
      );
    }}
  </Story>
</Canvas>

## Image Item

<Canvas>
  <Story name="Item with image" height={310}>
    {args => {
      const [isOpen, open, close] = useBooleanState(true);
      return (
        <SpaceContainer height={250}>
          <Dropdown>
            <Button onClick={open}>
              With image <ArrowDownIcon />
            </Button>
            {isOpen && (
              <Dropdown.Overlay verticalPosition="down" onClose={close}>
                <Dropdown.Header>
                  <Dropdown.Title>Elements</Dropdown.Title>
                </Dropdown.Header>
                <Dropdown.ItemCollection>
                  <Dropdown.Item>
                    <Image src="https://picsum.photos/seed/akeneo/200/140" alt="The alt" />
                    Item 1<Badge>100%</Badge>
                  </Dropdown.Item>
                  <Dropdown.Item disabled={true}>
                    <Image src="https://picsum.photos/seed/akenep/200/140" alt="The alt" />
                    Item 2<Badge level="danger">8%</Badge>
                  </Dropdown.Item>
                  <Dropdown.Item disabled={true}>
                    <Image src="https://picsum.photos/seed/akeneq/200/140" alt="The alt" />A very long item Name that
                    will be truncated
                    <Badge>100%</Badge>
                  </Dropdown.Item>
                  <Dropdown.Item>
                    <Image src="https://picsum.photos/seed/akener/200/140" alt="The alt" />
                    <Link target="_blank" href="https://www.youtube.com/watch?v=dQw4w9WgXcQ">
                      Item 4
                    </Link>
                    <Badge>100%</Badge>
                  </Dropdown.Item>
                </Dropdown.ItemCollection>
              </Dropdown.Overlay>
            )}
          </Dropdown>
        </SpaceContainer>
      );
    }}
  </Story>
</Canvas>
