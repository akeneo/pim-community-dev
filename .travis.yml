language: php

php:
    - 7.2

# Only build branches starting by "einrich-""
branches:
  only:
    - /^(einrich|assets)-?.*$/

# Extra dependencies
services:
  - mysql

# For mysql 5.7 instead of 5.6
addons:
  apt:
    sources:
      - mysql-5.7-trusty
    packages:
      - mysql-server

sudo: false

# Speed up a bit the process
cache:
  directories:
    - $HOME/.composer/cache/files
    - $HOME/.cache/yarn
    - /tmp/jest

before_install:
    - export BRANCH=$(if [ "$TRAVIS_PULL_REQUEST" == "false" ]; then echo $TRAVIS_BRANCH; else echo $TRAVIS_PULL_REQUEST_BRANCH; fi)
    - nvm install 10.15.0
    - node tests/travis/check-changes.js $BRANCH src/Akeneo/ReferenceEntity/,.travis.yml,tests/travis/,tests/front,package.json,composer.json
    - node tests/travis/check-changes.js $BRANCH src/Akeneo/AssetManager/,.travis.yml,tests/travis/,tests/front,package.json,composer.json
    - php src/Akeneo/AssetManager/tests/check-fake-implementations.php
    - php src/Akeneo/ReferenceEntity/tests/check-fake-implementations.php
    - phpenv config-rm xdebug.ini
    - composer config -g github-oauth.github.com $GITHUB_TOKEN
    - phpenv config-add tests/travis/travis.php.ini
    - echo -e "Host github.com\n\tStrictHostKeyChecking no\n" >> ~/.ssh/config
    - curl -O https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-6.5.4.deb && sudo dpkg -i --force-confnew elasticsearch-6.5.4.deb && sudo service elasticsearch restart
    - yes | pecl install imagick

install:
    - composer install --prefer-dist --no-interaction
    - ./bin/console pim:install:assets --env=behat
    - ./bin/console pim:install:db --withoutIndexes --withoutFixtures --env=behat
    - yarn install
    - yarn less
    - yarn webpack-test --env=prod

jobs:
  include:
    - stage: Reference Entities Tests
      if: branch =~ /^einrich-?.*$/
      script:
          - yarn unit
          - yarn integration
          - NODE_OPTIONS="--max-old-space-size=4096" NODE_PATH=./node_modules node_modules/.bin/cucumber-js --tags @acceptance-front -r ./frontend/test/acceptance/run-steps.js src/Akeneo/ReferenceEntity/tests/features
          - yarn lint
          - vendor/bin/php-coupling-detector detect --config-file=src/Akeneo/ReferenceEntity/tests/back/.php_cd.php src/Akeneo/ReferenceEntity/back
          - vendor/bin/phpstan analyse --configuration src/Akeneo/ReferenceEntity/tests/back/phpstan.neon.dist
          - vendor/bin/behat --config src/Akeneo/ReferenceEntity/tests/back/behat.yml.dist --no-interaction --format=progress
          - vendor/bin/phpunit -c src/Akeneo/ReferenceEntity/tests/back
          - vendor/bin/php-cs-fixer fix --diff --dry-run --config=.php_cs.php
          - vendor/bin/phpspec run -c src/Akeneo/ReferenceEntity/tests/back/phpspec.yml.dist --no-interaction

    - stage: Asset Manager Tests
      if: branch =~ /^assets-?.*$/
      script:
        - yarn unit
        - yarn integration
        - RANDOM_LATENCY=false NODE_OPTIONS="--max-old-space-size=4096" NODE_PATH=./node_modules node_modules/.bin/cucumber-js --tags @acceptance-front -r ./src/Akeneo/Pim/Enrichment/AssetManager/tests/front/acceptance/run-steps.js src/Akeneo/Pim/Enrichment/AssetManager/tests/front/features
        - yarn lint
        - vendor/bin/php-coupling-detector detect --config-file=src/Akeneo/AssetManager/tests/back/.php_cd.php src/Akeneo/AssetManager/back
        - vendor/bin/phpstan analyse --configuration src/Akeneo/AssetManager/tests/back/phpstan.neon.dist
        - vendor/bin/behat --config src/Akeneo/AssetManager/tests/back/behat.yml.dist --no-interaction --format=progress
        - vendor/bin/phpunit -c src/Akeneo/AssetManager/tests/back
        - vendor/bin/php-cs-fixer fix --diff --dry-run --config=.php_cs.php
        - vendor/bin/phpspec run -c src/Akeneo/AssetManager/tests/back/phpspec.yml.dist --no-interaction
        - rm -rf var/cache
        - rm -rf public/bundles
        - ./bin/console pim:install:assets --env=prod
        - yarn webpack --env=prod

notifications:
  email: false
