apiVersion: cloudscheduler.cnrm.cloud.google.com/v1beta1
kind: CloudSchedulerJob
metadata:
  labels:
    {{- include "timmy.labels" . | nindent 4 }}
  name: {{ include "timmy.fullname" . }}
  namespace: {{ .Release.Namespace | quote }}
  annotations:
    cnrm.cloud.google.com/project-id: {{ .Values.common.gcpProjectID }}
spec:
  description:  "The scheduler for Timmy to request the Portal"
  schedule: {{ .Values.cloudScheduler.schedule | quote }}
  location: {{ .Values.common.region }}
  timeZone: {{ .Values.common.timeZone }}
  httpTarget:
    uri: "https://{{ .Values.common.region }}-{{ .Values.common.gcpProjectID }}.cloudfunctions.net/{{ .Values.cloudScheduler.functionName }}"
    headers:
      Content-Type: "application/json"
      User-Agent: "Google-Cloud-Scheduler"
    httpMethod: "POST"
    oidcToken:
      audience: "https://{{ .Values.common.region }}-{{ .Values.common.gcpProjectID }}.cloudfunctions.net/{{ .Values.cloudScheduler.functionName }}"
      serviceAccountRef:
        external: {{ include "timmy.deploymentGSAEmail" . }}
    body: {{ "{}" | b64enc }}
