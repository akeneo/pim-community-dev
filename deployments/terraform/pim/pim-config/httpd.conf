ServerRoot "/usr/local/apache2"

Listen 80

LoadModule allowmethods_module modules/mod_allowmethods.so
LoadModule authz_core_module modules/mod_authz_core.so
LoadModule authz_host_module modules/mod_authz_host.so
LoadModule deflate_module modules/mod_deflate.so
LoadModule env_module modules/mod_env.so
LoadModule expires_module modules/mod_expires.so
LoadModule filter_module modules/mod_filter.so
LoadModule headers_module modules/mod_headers.so
LoadModule log_config_module modules/mod_log_config.so
LoadModule logio_module modules/mod_logio.so
LoadModule mime_module modules/mod_mime.so
LoadModule mpm_event_module modules/mod_mpm_event.so
LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_fcgi_module modules/mod_proxy_fcgi.so
LoadModule reqtimeout_module modules/mod_reqtimeout.so
LoadModule rewrite_module modules/mod_rewrite.so
LoadModule setenvif_module modules/mod_setenvif.so
LoadModule unixd_module modules/mod_unixd.so
LoadModule status_module modules/mod_status.so
LoadModule http2_module modules/mod_http2.so

#mpm_event_module configuration
StartServers 2
ServerLimit 50
MinSpareThreads 15
MaxSpareThreads 30
ThreadLimit 64
ThreadsPerChild 15
MaxRequestWorkers 75
MaxConnectionsPerChild 0

ServerTokens ProductOnly
ServerSignature Off
TraceEnable Off

User daemon
Group daemon

ServerAdmin security@akeneo.com

<Files ".ht*">
    Require all denied
</Files>

ErrorLogFormat "{ \"time\" : \"[%{u}t]\", \"function\" : \"[%-m:%l]\" , \"process\" : \"[pid %P:tid %T]\" , \"message\" : \"%M\" ,\ \"referer\"\ : \"%{Referer}i\" },"

ErrorLog /proc/self/fd/2

LogLevel warn

# Note also that httpd will escape " to \", plus various others... (see the docs),
# which (almost) matches up with JSON's requirements, with the exception of
# \xXX (should be \x00XX in JSON) and \v (should be \u0013 in JSON)

LogFormat "{ \"http\": { \"@timestamp\":\"%{%FT%T%z}t\", \
    \"client_ip\":\"%a\", \
    \"client_port\":\"%{remote}p\", \
    \"server_ip\":\"%A\", \
    \"X-Forwarded-For\":\"%{X-Forwarded-For}i\", \
    \"X-Forwarded-Proto\":\"%{X-Forwarded-Proto}i\", \
    \"user\":\"%u\", \
    \"REMOTE_USER\":\"%{REMOTE_USER}i\", \
    \"BAPID\":\"%{BAPID}C\", \
    \"pid\":\"%P\", \
    \"protocol\":\"%H\", \
    \"http_method\":\"%m\", \
    \"vhost\":\"%{Host}i\", \
    \"service_port\":\"%p\", \
    \"path\":\"%U\", \
    \"query_string\":\"%q\", \
    \"referer\":\"%{Referer}i\", \
    \"user_agent\":\"%{User-agent}i\", \
    \"response_code\":\"%>s\", \
    \"response_location\":\"%{Location}o\", \
    \"bytes_in\":\"%I\", \
    \"bytes_out\":\"%O\", \
    \"Content-Type\":\"%{Content-Type}o\", \
    \"keepalive\":\"%X\", \
    \"duration_micros\":\"%D\" } }" fluentd_json

CustomLog /proc/self/fd/1  fluentd_json

RequestHeader unset Proxy early
Header set X-Frame-Options: "sameorigin"

TypesConfig conf/mime.types

TimeOut 300
ProxyTimeout 300

<FilesMatch \.php$>
    SetHandler "proxy:fcgi://${FPM_HOST}:9000"
</FilesMatch>

<Location "/api.php">
    SetHandler "proxy:fcgi://${FPM_HOST}:9001"
</Location>

ExpiresActive On
ExpiresByType application/javascript "access plus 4 hours"
ExpiresByType text/css "access plus 4 hours"
ExpiresByType image/gif "access plus 4 hours"
ExpiresByType image/svg+xml "access plus 4 hours"
ExpiresByType image/png "access plus 4 hours"
ExpiresByType application/x-font-ttf "access plus 1 week"

FilterDeclare COMPRESS
FilterProvider  COMPRESS  DEFLATE "%{Content_Type} = 'text/html'"
FilterProvider  COMPRESS  DEFLATE "%{Content_Type} = 'text/css'"
FilterProvider  COMPRESS  DEFLATE "%{Content_Type} = 'text/x-component'"
FilterProvider  COMPRESS  DEFLATE "%{Content_Type} = 'text/plain'"
FilterProvider  COMPRESS  DEFLATE "%{Content_Type} = 'application/javascript'"
FilterProvider  COMPRESS  DEFLATE "%{Content_Type} = 'application/json'"
FilterProvider  COMPRESS  DEFLATE "%{Content_Type} = 'image/svg+xml'"
FilterProvider  COMPRESS  DEFLATE "%{Content_Type} = 'application/x-font-ttf'"
FilterChain COMPRESS
FilterProtocol  COMPRESS  DEFLATE change=yes;byteranges=no

SetEnvIf Authorization .+ HTTP_AUTHORIZATION=$0

# /server-status for Datadog checks
<Location /server-status>
    SetHandler server-status
    # Require local
    <RequireAll>
      # Limit to private network (even if external traffic is 10. through LB)
      Require ip 10
      # Limit to Datadog Agent
      Require expr %{HTTP_USER_AGENT} =~ /Datadog Agent/
    </RequireAll>
</Location>

<VirtualHost *:80>
    ServerName localhost
    DocumentRoot /srv/pim/public

    <Directory /srv/pim/public>
        RewriteEngine On

        RewriteRule ^(api/rest/.*)$ api.php [QSA,L]

        RewriteCond %{REQUEST_URI} !^/server-status
        RewriteCond %{REQUEST_URI} !^/api/rest/
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteRule ^(.*)$ index.php [QSA,L]

        Require all granted
        AllowOverride None
        AllowMethods GET POST PUT HEAD DELETE PATCH
    </Directory>
    LogLevel warn
    Protocols h2 http/1.1
</VirtualHost>
