<script type="text/javascript">
$(function() {
    'use strict';

    var activeTab = $('[href=' + {{ tab ? ("'#" ~ tab ~ "'")|raw : 'location.hash' }} + ']');
    activeTab && activeTab.tab('show');

    var formAction = '{{ path('pim_product_product_edit', { id: form.vars.value.id, dataLocale: dataLocale }) }}';

    $('#{{ form.vars.id }}').on('submit', function() {
        var tab = $('#form-navbar .nav li.active a').attr('href');
        tab && $(this).attr('action', formAction + '&tab=' + tab.substr(1));
        return true;
    });

    var updated = false;

    $('#updated').css('display', 'none');
    $('form [id^="pim_product_"]').change(function(event){
        updated = true;
        $('#updated').css('display', 'inline-block');
        $('form [id^="pim_product_"]').unbind('change');
    });

    $(window).on('beforeunload', function(){
        if (updated) {
            return "{{ 'You will lose changes to the product if you leave the page.'|trans }}";
        }
    });

    $('button[type="submit"]').click(function(event) {
        $('#pim_available_product_attributes_attributes').removeAttr('required');
        $(window).unbind('beforeunload');
    });

    $('#btn-delete-product').click(function(event) {
        doAction = function() {
            window.location.href = "{{ path('pim_product_product_remove', { id: form.vars.value.id }) }}";
        };

        if (!_.isUndefined(Backbone.BootstrapModal)) {
            confirm = new Backbone.BootstrapModal({
                title: "{{ 'Delete Confirmation' | trans }}",
                content: "{{ 'Are you sure you want to delete this product' | trans }}"
            });
            confirm.on('ok', doAction);
            confirm.open();
        } else if (window.confirm(message)) {
            doAction();
        }
    });

    $('#attribute-buttons .dropdown-menu').click(function (e) {
        e.stopPropagation();
    });

    // Destroy Select2 where it's not necessary
    $('#default_channel').select2('destroy');

    $('#default_channel').change(function() {
        $('.scopable').scopableField({ defaultScope: $(this).val() });
    });

    $('.dropdown-menu.channel a').click(function (e) {
        e.preventDefault();
        $('.scopable').scopableField($(this).data('action'));
    });

    $('li.tab.active a').each(function() {
        var paneId = $(this).attr('href');
        $(paneId).addClass('active');
    });

    $('.remove-attribute').each(function() {
        var target = $(this).parent().find('input:not([type="hidden"]):not([class*=select2]), select, textarea').first();
        $(this).insertAfter(target).css('margin-left', 20);
    });
});
</script>
