import React, {isValidElement, ReactNode, useEffect, useCallback, useState} from 'react';
import styled from 'styled-components';
import {SearchBar} from 'akeneoassetmanager/application/component/asset/list/search-bar';
import Mosaic from 'akeneoassetmanager/application/component/asset/list/mosaic';
import {Context} from 'akeneoassetmanager/domain/model/context';
import AssetFamilyIdentifier from 'akeneoassetmanager/domain/model/asset-family/identifier';
import {Filter} from 'akeneoassetmanager/application/reducer/grid';
import AssetCode from 'akeneoassetmanager/domain/model/asset/code';
import {SearchResult, emptySearchResult} from 'akeneoassetmanager/domain/fetcher/fetcher';
import ListAsset from 'akeneoassetmanager/domain/model/asset/list-asset';
import {useFetchResult, createQuery} from 'akeneoassetmanager/application/hooks/grid';
import FilterCollection, {useFilterViews} from 'akeneoassetmanager/application/component/asset/list/filter-collection';
import {AssetFamilySelector} from 'akeneoassetmanager/application/component/library/AssetFamilySelector';
import {HeaderView} from 'akeneoassetmanager/application/component/asset-family/edit/header';
import {getLabel} from 'pimui/js/i18n';
import {UploadModal} from 'akeneoassetmanager/application/asset-upload/component/modal';
import {useAssetFamily} from 'akeneoassetmanager/application/hooks/asset-family';
import {CreateModal} from 'akeneoassetmanager/application/component/asset/create';
import {CreateAssetFamilyModal} from 'akeneoassetmanager/application/component/asset-family/create';
import {useStoredState} from 'akeneoassetmanager/application/hooks/state';
import {getLocales} from 'akeneoassetmanager/application/reducer/structure';
import {useChannels} from 'akeneoassetmanager/application/hooks/channel';
import {Column} from 'akeneoassetmanager/application/component/app/column';
import AssetFetcher from 'akeneoassetmanager/domain/fetcher/asset';
import {ChannelFetcher} from 'akeneoassetmanager/application/hooks/channel';
import {AssetFamilyFetcher} from 'akeneoassetmanager/domain/fetcher/asset-family';
import {NormalizedAttribute} from 'akeneoassetmanager/domain/model/attribute/attribute';
import {clearImageLoadingQueue} from 'akeneoassetmanager/tools/image-loader';
import {getAttributeAsMainMedia} from 'akeneoassetmanager/domain/model/asset-family/asset-family';
import {isMediaLinkAttribute} from 'akeneoassetmanager/domain/model/attribute/type/media-link';
import {useScroll} from 'akeneoassetmanager/application/hooks/scroll';
import {CompletenessValue} from 'akeneoassetmanager/application/component/asset/list/completeness-filter';
import {getCompletenessFilter, updateCompletenessFilter} from 'akeneoassetmanager/tools/filters/completeness';
import {useNotify, NotificationLevel, useTranslate} from '@akeneo-pim-community/shared';
import {AssetFamilyBreadcrumb} from 'akeneoassetmanager/application/component/app/breadcrumb';
import {Checkbox, Toolbar, Button, useSelection, useBooleanState, Dropdown, ArrowDownIcon} from 'akeneo-design-system';
import {MassDelete} from 'akeneoassetmanager/application/component/library/MassDelete/MassDelete';
import {useSelectionQuery} from 'akeneoassetmanager/application/component/library/hooks/useSelectionQuery';
import {useRoutes} from 'akeneoassetmanager/application/component/library/hooks/useRoutes';
import {
  NoAssetFamily,
  NoAsset,
  AssetLibraryPlaceholder,
} from 'akeneoassetmanager/application/component/library/components';
import {MassEdit} from 'akeneoassetmanager/application/component/library/MassEdit/MassEdit';

const Header = styled.div`
  padding-left: 40px;
  padding-right: 40px;
  height: 136px;
`;

const Content = styled.div`
  flex: 1;
  display: flex;
  flex-direction: column;
`;

const Container = styled.div`
  display: flex;
  flex: 1;
  height: 100%;
`;

const Grid = styled.div`
  display: flex;
  flex-direction: column;
  flex: 1;
  margin: 0 40px;
  overflow-y: auto;
`;

export type AssetAttributeFetcher = {
  fetchAll: (assetFamilyIdentifier: AssetFamilyIdentifier) => Promise<NormalizedAttribute[]>;
};

export type LibraryDataProvider = {
  assetFetcher: AssetFetcher;
  channelFetcher: ChannelFetcher;
  assetFamilyFetcher: AssetFamilyFetcher;
  assetAttributeFetcher: AssetAttributeFetcher;
};

type CreateButtonProps = {
  children: ReactNode;
};

const CreateButton = ({children}: CreateButtonProps) => {
  const translate = useTranslate();
  const [isDropdownOpen, openDropdown, closeDropdown] = useBooleanState();

  const validChildren = React.Children.toArray(children).filter(Boolean);

  if (0 === validChildren.length) {
    return null;
  } else if (1 === validChildren.length && isValidElement(validChildren[0])) {
    return <Button onClick={validChildren[0].props.onClick}>{validChildren[0].props.children}</Button>;
  }

  return (
    <Dropdown>
      <Button onClick={openDropdown}>
        {translate('pim_common.create')} <ArrowDownIcon />
      </Button>
      {isDropdownOpen && (
        <Dropdown.Overlay onClose={closeDropdown}>
          <Dropdown.ItemCollection>{validChildren}</Dropdown.ItemCollection>
        </Dropdown.Overlay>
      )}
    </Dropdown>
  );
};

type LibraryProps = {
  dataProvider: LibraryDataProvider;
  initialContext: Context;
};

const Library = ({dataProvider, initialContext}: LibraryProps) => {
  const [currentAssetFamilyIdentifier, setCurrentAssetFamilyIdentifier] = useStoredState<AssetFamilyIdentifier | null>(
    'akeneo.asset_manager.grid.current_asset_family',
    null
  );
  const [scrollContainerRef, scrollTop] = useScroll<HTMLDivElement>();
  const [filterCollection, setFilterCollection] = useStoredState<Filter[]>(
    `akeneo.asset_manager.grid.filter_collection_${currentAssetFamilyIdentifier}`,
    []
  );
  const [excludedAssetCollection] = useState<AssetCode[]>([]);
  const [searchValue, setSearchValue] = useStoredState<string>('akeneo.asset_manager.grid.search_value', '');
  const [searchResult, setSearchResult] = useState<SearchResult<ListAsset>>(emptySearchResult());
  const [isInitialized, setIsInitialized] = useState<boolean>(false);
  const [context, setContext] = useStoredState<Context>('akeneo.asset_manager.grid.context', initialContext);
  const [isCreateAssetModalOpen, openCreateAssetModal, closeCreateAssetModal] = useBooleanState(false);
  const [isUploadModalOpen, openUploadModal, closeUploadModal] = useBooleanState(false);
  const [isCreateAssetFamilyModalOpen, openCreateAssetFamilyModal, closeCreateAssetFamilyModal] = useBooleanState(
    false
  );
  const notify = useNotify();
  const translate = useTranslate();

  const [selection, selectionState, isItemSelected, onSelectionChange, onSelectAllChange, selectedCount] = useSelection<
    AssetCode
  >(searchResult.matchesCount);

  const channels = useChannels(dataProvider.channelFetcher);
  const locales = getLocales(channels, context.channel);
  const {assetFamily: currentAssetFamily, rights} = useAssetFamily(dataProvider, currentAssetFamilyIdentifier);
  const currentAssetFamilyLabel =
    null === currentAssetFamily
      ? ''
      : getLabel(currentAssetFamily.labels, context.locale, currentAssetFamily.identifier);

  const completenessValue = getCompletenessFilter(filterCollection);
  const handleCompletenessValueChange = useCallback(
    (value: CompletenessValue) => {
      setFilterCollection(updateCompletenessFilter(filterCollection, value));
    },
    [filterCollection, setFilterCollection]
  );

  const selectionQuery = useSelectionQuery(
    currentAssetFamilyIdentifier,
    filterCollection,
    searchValue,
    context,
    selection
  );

  const updateResults = useFetchResult(createQuery)(
    true,
    dataProvider,
    currentAssetFamilyIdentifier,
    filterCollection,
    searchValue,
    excludedAssetCollection,
    context,
    (results: SearchResult<ListAsset>): void => {
      setSearchResult(results);
      setIsInitialized(true);
    }
  );
  const filterViews = useFilterViews(currentAssetFamilyIdentifier, dataProvider);
  const {redirectToAsset, redirectToAssetFamily} = useRoutes();

  const hasMediaLinkAsMainMedia =
    null !== currentAssetFamily && isMediaLinkAttribute(getAttributeAsMainMedia(currentAssetFamily));

  const handleAssetFamilyChange = useCallback(
    (assetFamilyIdentifier: AssetFamilyIdentifier) => {
      setCurrentAssetFamilyIdentifier(assetFamilyIdentifier);
      clearImageLoadingQueue();
    },
    [setCurrentAssetFamilyIdentifier]
  );

  const canSelectAssets = rights.asset.delete || rights.asset.edit;
  const isToolbarVisible = 0 < searchResult.matchesCount && !!selectionState && canSelectAssets;

  useEffect(() => {
    scrollTop();
    onSelectAllChange(false);
  }, [currentAssetFamilyIdentifier, filterCollection, searchValue, context]);

  return (
    <Container>
      <Column title={translate('pim_asset_manager.asset_family.column.title')}>
        <AssetFamilySelector
          assetFamilyIdentifier={currentAssetFamilyIdentifier}
          locale={context.locale}
          dataProvider={dataProvider}
          onChange={handleAssetFamilyChange}
        />
        <FilterCollection
          filterCollection={filterCollection}
          context={context}
          onFilterCollectionChange={setFilterCollection}
          orderedFilterViews={null === filterViews ? [] : filterViews}
        />
      </Column>
      <Content>
        <Header>
          <HeaderView
            label={
              isInitialized
                ? translate(
                    'pim_asset_manager.result_counter',
                    {count: searchResult.matchesCount},
                    searchResult.matchesCount
                  )
                : ''
            }
            image={null}
            primaryAction={() => (
              <>
                {null !== currentAssetFamilyIdentifier && (
                  <Button
                    ghost={true}
                    level="tertiary"
                    onClick={() => redirectToAssetFamily(currentAssetFamilyIdentifier)}
                  >
                    {translate(`pim_asset_manager.asset_family.button.${rights.assetFamily.edit ? 'edit' : 'view'}`)}
                  </Button>
                )}
                <CreateButton>
                  {null !== currentAssetFamilyIdentifier && rights.asset.create && (
                    <Dropdown.Item onClick={openCreateAssetModal}>
                      {translate('pim_asset_manager.asset.button.create')}
                    </Dropdown.Item>
                  )}
                  {null !== currentAssetFamilyIdentifier && (rights.asset.upload || hasMediaLinkAsMainMedia) && (
                    <Dropdown.Item
                      title={translate(
                        `pim_asset_manager.asset.upload.${
                          hasMediaLinkAsMainMedia ? 'disabled_for_media_link' : 'title'
                        }`
                      )}
                      disabled={hasMediaLinkAsMainMedia}
                      onClick={openUploadModal}
                    >
                      {translate('pim_asset_manager.asset.upload.title')}
                    </Dropdown.Item>
                  )}
                  {rights.assetFamily.create && (
                    <Dropdown.Item onClick={openCreateAssetFamilyModal}>
                      {translate('pim_asset_manager.asset_family.button.create')}
                    </Dropdown.Item>
                  )}
                </CreateButton>
              </>
            )}
            context={context}
            withLocaleSwitcher={true}
            withChannelSwitcher={true}
            isDirty={false}
            isLoading={false}
            breadcrumb={<AssetFamilyBreadcrumb assetFamilyLabel={currentAssetFamilyLabel} />}
            displayActions={true}
          />
        </Header>
        <Grid>
          {!isInitialized ? (
            <AssetLibraryPlaceholder assetFamily={currentAssetFamily} />
          ) : null === currentAssetFamilyIdentifier ? (
            <NoAssetFamily onCreateAssetFamily={openCreateAssetFamilyModal} />
          ) : 0 === searchResult.totalCount ? (
            <NoAsset assetFamilyLabel={currentAssetFamilyLabel} onCreateAsset={openCreateAssetModal} />
          ) : (
            <>
              <SearchBar
                dataProvider={dataProvider}
                searchValue={searchValue}
                context={context}
                resultCount={searchResult.matchesCount}
                onSearchChange={setSearchValue}
                onContextChange={setContext}
                completenessValue={completenessValue}
                onCompletenessChange={handleCompletenessValueChange}
              />
              <Mosaic
                scrollContainerRef={scrollContainerRef}
                assetCollection={searchResult.items}
                context={context}
                resultCount={searchResult.matchesCount}
                selectionState={selectionState}
                hasReachMaximumSelection={false}
                onSelectionChange={canSelectAssets ? onSelectionChange : undefined}
                isItemSelected={isItemSelected}
                assetWithLink={true}
                onAssetClick={(assetCode: AssetCode) => {
                  if (null !== currentAssetFamilyIdentifier) {
                    redirectToAsset(currentAssetFamilyIdentifier, assetCode);
                  }
                }}
              />
            </>
          )}
        </Grid>
        <Toolbar isVisible={isToolbarVisible}>
          <Toolbar.SelectionContainer>
            <Checkbox checked={selectionState} onChange={onSelectAllChange} />
          </Toolbar.SelectionContainer>
          <Toolbar.LabelContainer>
            {translate('pim_asset_manager.asset_selected', {assetCount: selectedCount}, selectedCount)}
          </Toolbar.LabelContainer>
          <Toolbar.ActionsContainer>
            {rights.asset.edit && (
              <MassEdit
                selectionQuery={selectionQuery}
                onConfirm={() => onSelectAllChange(false)}
                context={context}
                assetFamily={currentAssetFamily}
                selectedCount={selectedCount}
                channels={channels}
              />
            )}
            {rights.asset.delete && (
              <MassDelete
                selectionQuery={selectionQuery}
                onConfirm={() => onSelectAllChange(false)}
                assetFamily={currentAssetFamily}
                selectedCount={selectedCount}
              />
            )}
          </Toolbar.ActionsContainer>
        </Toolbar>
      </Content>
      {isCreateAssetModalOpen && null !== currentAssetFamily && (
        <CreateModal
          locale={context.locale}
          assetFamily={currentAssetFamily}
          onClose={closeCreateAssetModal}
          onAssetCreated={(assetCode: AssetCode, createAnother: boolean) => {
            notify(NotificationLevel.SUCCESS, translate('pim_asset_manager.asset.notification.create.success'));
            if (createAnother) {
              updateResults();
            } else {
              closeCreateAssetModal();
              redirectToAsset(currentAssetFamily.identifier, assetCode);
            }
          }}
        />
      )}
      {isUploadModalOpen && null !== currentAssetFamily && (
        <UploadModal
          confirmLabel={translate('pim_asset_manager.asset.upload.confirm')}
          locale={context.locale}
          channels={channels}
          locales={locales}
          assetFamily={currentAssetFamily}
          onCancel={() => {
            closeUploadModal();
            updateResults();
          }}
          onAssetCreated={() => {
            closeUploadModal();
            updateResults();
          }}
        />
      )}
      {isCreateAssetFamilyModalOpen && (
        <CreateAssetFamilyModal
          locale={context.locale}
          onClose={closeCreateAssetFamilyModal}
          onAssetFamilyCreated={(assetFamilyIdentifier: AssetFamilyIdentifier) => {
            closeCreateAssetFamilyModal();
            notify(NotificationLevel.SUCCESS, translate('pim_asset_manager.asset_family.notification.create.success'));
            handleAssetFamilyChange(assetFamilyIdentifier);
            redirectToAssetFamily(assetFamilyIdentifier);
          }}
        />
      )}
    </Container>
  );
};

export default Library;
