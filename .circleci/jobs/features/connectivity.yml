jobs:
    test_front_connectivity:
        machine:
            image: ubuntu-2004:202101-01
            docker_layer_caching: true
        steps:
            -   attach_workspace:
                    at: ~/
            -   run:
                    name: Create yarn cache folder
                    command: mkdir -p  ~/.cache/yarn
            -   run:
                    name: Change owner on project dir (default user = circleci (1001) and docker needs uid 1000)
                    command: sudo chown -R 1000:1000 ../project ~/.cache/yarn
            -   run:
                    name: Pull docker image for node
                    command: docker-compose pull node
            -   run:
                    name: Lint front
                    command: make connectivity-connection-lint-front
            -   run:
                    name: Unit front
                    command: make connectivity-connection-unit-front
            -   run:
                    name: Type checking front
                    command: make javascript-dev-strict

    test_back_connectivity:
        machine:
            image: ubuntu-2004:202101-01
            docker_layer_caching: true
        steps:
            -   attach_workspace:
                    at: ~/
            -   run:
                    name: Change owner on project dir (default user = circleci (1001) and docker needs uid 1000)
                    command: sudo chown -R 1000:1000 ../project
            -   run:
                    name: Pull docker image for php
                    command: docker-compose pull php
            -   run:
                    name: Coupling back
                    command: make connectivity-connection-coupling-back
            -   run:
                    name: Lint back
                    command: make connectivity-connection-lint-back
            -   run:
                    name: Unit back
                    command: make connectivity-connection-unit-back
            -   run:
                    name: Pull docker images
                    command: docker-compose pull fpm mysql elasticsearch object-storage pubsub-emulator
            -   run:
                    name: Start containers
                    command: |
                        APP_ENV=test C='fpm mysql elasticsearch object-storage pubsub-emulator' make up
                        docker/wait_docker_up.sh
            -   run:
                    name: Install database
                    command: APP_ENV=test make database
            -   run:
                    name: Integration back
                    command: CI=false make connectivity-connection-integration-back
            -   run:
                    name: End to end back
                    command: CI=false make connectivity-connection-e2e-back
            -   store_test_results:
                    path: var/tests/phpunit

    test_marketplace_activate_e2e:
        machine:
            image: ubuntu-2004:202101-01
        steps:
            -   attach_workspace:
                    at: ~/
            -   run:
                    name: Change owner on project dir in order to archive the project into the workspace
                    command: sudo chown -R 1000:1000 ../project
            -   run:
                    name: Start containers
                    command: |
                        docker load -i php-pim-image.tar
                        APP_ENV=behat docker-compose -f docker-compose.yml -f src/Akeneo/Connectivity/Connection/tests/docker-compose.yml up -d --remove-orphan fpm mysql elasticsearch httpd object-storage selenium pubsub-emulator
                        docker/wait_docker_up.sh
            -   run:
                    name: Install database
                    command: APP_ENV=behat make database
            -   run:
                    name: End to end Behat tests
                    command: PIM_CONTEXT=test make connectivity-connection-activate-e2e
            -   store_test_results:
                    path: var/tests/behat
            -   store_artifacts:
                    path: var/tests/behat
            -   store_artifacts:
                    path: var/logs
            -   store_artifacts:
                    path: var/tests/screenshots

    test_octopus_code_quality:
        machine:
            image: ubuntu-2004:202101-01
        steps:
            -   attach_workspace:
                    at: ~/
            -   run:
                    name: Change owner on project dir (default user = circleci (1001) and docker needs uid 1000)
                    command: sudo chown -R 1000:1000 ../project
            -   run:
                    name: PHP Insights results
                    command: make connectivity-connection-insight O='src/Akeneo/Connectivity/Connection/back/Domain src/Akeneo/Connectivity/Connection/back/Application src/Akeneo/Connectivity/Connection/back/Infrastructure'
            -   run:
                    name: PSALM results
                    command: make connectivity-connection-psalm || true
            -   run:
                    name: Start containers
                    command: |
                        docker load -i php-pim-image.tar
                        APP_ENV=test C='fpm mysql elasticsearch object-storage pubsub-emulator' make up
                        docker/wait_docker_up.sh
            -   run:
                    name: Install database
                    command: APP_ENV=test make database
            -   run:
                    name: Compute code coverage of all tests
                    command: PIM_CONTEXT=test make connectivity-connection-coverage
            -   store_artifacts:
                    path: coverage/Connectivity/Back/Global/

    debug_octo:
        machine:
            image: ubuntu-2004:202101-01
        steps:
            -   attach_workspace:
                    at: ~/
#                -   run: |
#                        changes=`git show --name-only ${CIRCLE_SHA1} | tail -n +7`
#                        echo $changes
