<VirtualHost *:80>
    ServerName akeneo.dev
    DocumentRoot /srv/pim/public

    Header set X-Frame-Options: "sameorigin"
    Header set X-Content-Type-Options: "nosniff"
    Header set Referrer-Policy: "same-origin"

    <Directory /srv/pim/public>
        AllowOverride None
        Require all granted

        Options -MultiViews

        SetEnv APP_ENV ${APP_ENV}

        RewriteEngine On

        RewriteRule ^(api/.*)$ api.php [QSA,L]

        RewriteCond "%{ENV:APP_ENV}" =prod
        RewriteCond "%{ENV:DOCKER_PORT_HTTPS}" ^$
        RewriteRule ^(.*)$ https://%{SERVER_NAME}:8443$1 [R,L]

        RewriteCond "%{ENV:APP_ENV}" =prod
        RewriteCond "%{ENV:DOCKER_PORT_HTTPS}" !^$
        RewriteRule ^(.*)$ https://%{SERVER_NAME}:%{ENV:DOCKER_PORT_HTTPS}$1 [R,L]

        RewriteCond %{REQUEST_URI} !^/server-status
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteRule ^(.*)$ index.php [QSA,L]

    </Directory>

    <Directory /srv/pim>
        Options FollowSymlinks
    </Directory>

    <Directory /srv/pim/public/bundles>
        RewriteEngine Off
    </Directory>
    Protocols h2 http/1.1
</VirtualHost>

<VirtualHost *:443>
    ServerName akeneo.dev
    DocumentRoot /srv/pim/public

    Header always set Strict-Transport-Security: "max-age=31536000; includeSubDomains"
    Header set X-Frame-Options: "sameorigin"
    Header set X-Content-Type-Options: "nosniff"
    Header set Referrer-Policy: "same-origin"

    <Directory /srv/pim/public>
        AllowOverride None
        Require all granted

        Options -MultiViews

        RewriteEngine On

        RewriteRule ^(api/.*)$ api.php [QSA,L]

        RewriteCond %{REQUEST_URI} !^/server-status
        RewriteCond %{REQUEST_FILENAME} !-f
        SetEnv APP_ENV ${APP_ENV}
        RewriteRule ^(.*)$ index.php [QSA,L]
    </Directory>

    SSLEngine on

    SSLCertificateFile "/usr/local/apache2/conf/server.crt"
    SSLCertificateKeyFile "/usr/local/apache2/conf/server.key"

    <FilesMatch "\.php$">
        SSLOptions +StdEnvVars
    </FilesMatch>
    Protocols h2 http/1.1
</VirtualHost>
