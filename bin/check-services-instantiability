#!/usr/bin/php
<?php
define('EXIT_WRONG_USAGE', 127);
define('EXIT_SERVICES_NON_INSTANTIABLE', 1);

if (!file_exists('src/Kernel.php')) {
    die("Please run this command from your Symfony application root.");
}

require 'config/bootstrap.php';

use Symfony\Component\Console\Exception\RuntimeException;
use Symfony\Component\Console\Input\ArgvInput;
use Symfony\Component\Console\Input\InputDefinition;
use Symfony\Component\Console\Input\InputOption;
use Symfony\Component\Console\Output\ConsoleOutput;
use Symfony\Component\DependencyInjection\ContainerInterface;

$ignoreServiceIds = [
];

$inputDefinition = new InputDefinition(array(
  new InputOption('verbose', 'v', InputOption::VALUE_NONE, 'Verbose mode: list all service ids we tried to instantiate.'. false)
));

$output = new ConsoleOutput();
$input = new ArgvInput($argv);

try {
    $input->bind($inputDefinition);
    $input->validate();
} catch (RuntimeException $e) {
    $output->writeln(
        sprintf('<error>Wrong usage: %s</error>', $e->getMessage())
    );

    exit (EXIT_WRONG_USAGE);
}

$verbosity = $input->getOption('verbose') ? ConsoleOutput::VERBOSITY_VERBOSE : ConsoleOutput::VERBOSITY_NORMAL;
$output->setVerbosity($verbosity);

$kernel = new Kernel('dev', false);
$kernel->boot();

$container = getContainerBuilder($kernel);

$exitStatus = checkServicesInstantiability($container, $output, $ignoreServiceIds);

exit ($exitStatus);

function checkServicesInstantiability(ContainerInterface $container, ConsoleOutput $output, array $ignoreServiceIds): int
{
    $serviceIds = $container->getServiceIds();

    $nonInstantiableServices = [];
    $skippedServices = [];

    foreach ($serviceIds as $serviceId) {

        if (in_array($serviceId, $ignoreServiceIds)) {
            continue;
        }

        if ($output->isVerbose()) {
            $output->writeln("Getting $serviceId");
        }

        try {
            $service = $container->get($serviceId);
            if ($service instanceof \ProxyManager\Proxy\VirtualProxyInterface) {
                $service->initializeProxy();
            }
        } catch (\Symfony\Component\DependencyInjection\Exception\ServiceNotFoundException $snfe) {
            // Service not found, certainly inlined
            $skippedServices[$serviceId] = ["error_type" => get_class($snfe), "error_message" => $snfe->getMessage()];
        } catch (\Doctrine\ORM\ORMException $oe) {
            // Doctrine ORM magic... Unable to instantiate a repository
            $skippedServices[$serviceId] = ["error_type" => get_class($oe), "error_message" => $oe->getMessage()];
        } catch (\Symfony\Component\DependencyInjection\Exception\ParameterNotFoundException $pnfe) {
            if ('container.build_id' === $pnfe->getKey()) {
                $skippedServices[$serviceId] = ["error_type" => get_class($pnfe), "error_message" => $pnfe->getMessage()];
            } else {
                $nonInstantiableServices[$serviceId] = ["error_type" => get_class($pnfe), "error_message" => $pnfe->getMessage()];
            }
        } catch (Symfony\Component\DependencyInjection\Exception\RuntimeException $re) {
            if ('You have requested a synthetic service ("kernel"). The DIC does not know how to construct this service.' === $re->getMessage()) {
                $skippedServices[$serviceId] = ["error_type" => get_class($re), "error_message" => $re->getMessage()];
            } else {
                $nonInstantiableServices[$serviceId] = ["error_type" => get_class($re), "error_message" => $re->getMessage()];
            }
        } catch (\Throwable $t) {
            $nonInstantiableServices[$serviceId] = ["error_type" => get_class($t), "error_message" => $t->getMessage()];
        }
    }

    if (0 === count($nonInstantiableServices)) {
        $output->writeln(
            sprintf(
                "<info>All %s services are instantiable (%s skipped).</info>",
                count($serviceIds),
                count($skippedServices)
            )
        );

        return 0;
    } else {
        $output->writeln(
            sprintf(
                "<comment>Found %s non instantiable services on a total of %s (%s skipped).</comment>",
                count($nonInstantiableServices),
                count($serviceIds),
                count($skippedServices)
            )
        );
        foreach ($nonInstantiableServices as $nonInstantiableServiceId => $nonInstantiableServiceReason) {
            $output->writeln(
                sprintf('<error>%s</error>',$nonInstantiableServiceId)
            );
            $output->write($nonInstantiableServiceReason['error_type']);
            $output->write(": ");
            $output->writeln($nonInstantiableServiceReason['error_message']);
            $output->writeln("------");
        }

        return EXIT_SERVICES_NON_INSTANTIABLE;
    }
}

/**
 * Loads the ContainerBuilder from the cache.
 *
 * @throws \LogicException
 */
function getContainerBuilder(Kernel $kernel)
{
    if (!$kernel->isDebug() || !(new ConfigCache($kernel->getContainer()->getParameter('debug.container.dump'), true))->isFresh()) {
        $buildContainer = \Closure::bind(function () { return $this->buildContainer(); }, $kernel, \get_class($kernel));
        $container = $buildContainer();
        $container->compile();
    } else {
        (new XmlFileLoader($container = new ContainerBuilder(), new FileLocator()))->load($kernel->getContainer()->getParameter('debug.container.dump'));
    }

    return $container;
}
