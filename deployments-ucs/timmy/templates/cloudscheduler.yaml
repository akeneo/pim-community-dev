apiVersion: cloudscheduler.gcp.jet.crossplane.io/v1alpha1
kind: Job
metadata:
  labels:
    {{- include "timmy.labels" . | nindent 4 }}
  name: {{ include "timmy.fullname" . }}
  namespace: {{ .Release.Namespace | quote }}
spec:
  deletionPolicy: "Delete"
  forProvider:
    name: {{ include "timmy.fullname" . }}
    description: "The scheduler for Timmy to request the Portal"
    schedule: {{ .Values.cloudScheduler.schedule | quote }}
    region: {{ .Values.common.region }}
    project: {{ .Values.common.gcpProjectID }}
    timeZone: {{ .Values.common.timeZone }}
    httpTarget:
      - headers:
          Content-Type: "application/json"
        httpMethod: "POST"
        uri: "https://{{ .Values.common.region }}-{{ .Values.common.gcpProjectID }}.cloudfunctions.net/{{ .Values.cloudScheduler.cloudFunctionName }}"
        oidcToken:
          - audience: "https://{{ .Values.common.region }}-{{ .Values.common.gcpProjectID }}.cloudfunctions.net/{{ include "timmy.cloudFunctionName" . }}"
            serviceAccountEmail: {{ .Values.cloudFunction.serviceAccountEmail }}
        body: {{ "{}" | b64enc }}
  providerConfigRef:
    name: provider-config-jet-gcp


