executor-machine: &executor-machine 'ubuntu-2004:2022.04.1'

orbs:
    slack-app: circleci/slack@4.8.3

jobs:
  test_catalogs:
    machine:
      image: *executor-machine
      docker_layer_caching: true
    steps:
      -   attach_workspace:
            at: ~/
      -   run:
            name: Define environment variables
            command: |
              echo export PIM_CONTEXT=catalogs >> $BASH_ENV
      -   run:
            name: Create missing directories
            command: mkdir -p  ~/.cache/yarn ~/.cache/Cypress
      -   run:
            name: Creating hash of JS dependencies
            command: cat yarn.lock > ~/front-dependency.hash && date +%F >> ~/front-dependency.hash
      - restore_cache:
            name: Restore JS dependencies from the cache
            keys:
              - frontend-dependency-cache-{{ checksum "~/front-dependency.hash" }}-{{ .Environment.CACHE_VERSION }}
      -   run:
            name: Change owner on directories (docker needs uid 1000, circleci can be another uid)
            command: sudo chown -R 1000:1000 ../project ~/.cache/yarn ~/.cache/Cypress
      -   run:
            name: Cleanup & re-install CE node_modules
            command: |
              rm -r vendor/akeneo/pim-community-dev/node_modules
              cd ~/project/vendor/akeneo/pim-community-dev && make node_modules
      -   run:
            name: Load php docker image
            command: docker load -i php-pim-image.tar
      -   run:
            name: Pull docker images
            command: docker-compose pull mysql elasticsearch object-storage pubsub-emulator
      -   run:
            name: Start containers
            command: |
              APP_ENV=test C='fpm mysql elasticsearch object-storage pubsub-emulator' make up
              docker/wait_docker_up.sh
      -   run:
            name: Install database
            command: APP_ENV=test O="--withoutFixtures" make database
      -   run:
            name: Integration back
            command: APP_ENV=test make catalogs-integration-back
      -   run:
            name: Acceptance back
            command: APP_ENV=test make catalogs-acceptance-back
      -   slack-app/notify:
            channel: 'monitoring-octopus'
            event: fail
            template: basic_fail_1
