version: 2.1
jobs:
  setup:
    parameters:
      is_pull_request:
        type: boolean
        default: true
    machine:
      enabled: true
      docker_layer_caching: true
    steps:
      - checkout
      - run:
          name: Rename docker-compose.yml.dist
          command: mv docker-compose.yml.dist docker-compose.yml
      - run:
          name: Copy docker-compose.override.yml.dist
          command: cp .circleci/docker-compose.override.yml.dist docker-compose.override.yml
      - run:
          name: Setup tests results folder and log folder
          command: mkdir -p var/tests/phpunit var/tests/behat var/tests/phpspec var/tests/csfixer var/logs
      - run:
          name: Setup the parameters.yml files
          command: ./bin/docker/pim-setup.sh
      - run:
          name: Change owner on project dir (default user = circleci (1001) and docker needs uid 1000)
          command: sudo chown -R 1000:1000 ../project
      - run:
          name: Start containers
          command: docker-compose up -d
      - run:
          name: Change owner on project dir after restoring cache
          command: sudo chown -R 1000:1000 ../project
      - when:
          condition: << parameters.is_pull_request >>
          steps:
            - run:
                name: Update composer.json if same branch exists in CE
                command: >
                  curl --output /dev/null --silent --head --fail
                  https://github.com/akeneo/pim-community-dev/tree/${CIRCLE_BRANCH} &&
                  docker-compose exec akeneo-behat php
                  /usr/local/bin/composer require "akeneo/pim-community-dev:dev-${CIRCLE_BRANCH}" --no-update ||
                  echo "No CE branch $CIRCLE_BRANCH found. I don't touch the composer.json file."
      - run:
          name: Install dependencies
          command: ./bin/docker/pim-dependencies.sh
      - run:
          name: Pim database installation
          command: docker-compose exec akeneo-behat app/console --env=behat pim:install --force --clean
      - run:
          name: Change owner on project dir after installing when there is no cache
          command: sudo chmod -R 777 ../project
      - persist_to_workspace:
          root: ~/
          paths:
            - project

  back_static:
    machine:
      enabled: true
      docker_layer_caching: true
    steps:
      - attach_workspace:
          at: ~/
      - run:
          name: Change owner on project dir (default user = circleci (1001) and docker needs uid 1000)
          command: sudo chown -R 1000:1000 ../project
      - run:
          name: Start containers
          command: docker-compose up -d akeneo-behat
      - run:
          name: PhpSpec
          command: docker-compose exec akeneo-behat bin/phpspec run -vvv
      - run:
          name: PhpCsFixer
          command: docker-compose exec -T akeneo-behat bin/php-cs-fixer fix --diff --dry-run --config=.php_cs.php
      - store_test_results:
          path: var/tests
      - store_artifacts:
          path: var/tests

  back_phpunit_integration:
    machine:
      enabled: true
      docker_layer_caching: true
    parallelism: 4
    steps:
      - attach_workspace:
          at: ~/
      - run:
          name: Change owner on project dir in order to archive the project into the workspace
          command: sudo chown -R 1000:1000 ../project
      - run:
          name: Start containers
          command: docker-compose up -d
      - run:
          name: Install database
          command: |
            sleep 25 # wait mysql to be up
            docker-compose exec akeneo-behat app/console --env=behat pim:install:db
      - run:
          name: PHPunit Integration
          command: |
            TESTFILES=$(circleci tests glob "src/**/*Integration.php" | circleci tests split)
            .circleci/run_phpunit.sh $TESTFILES
      - store_test_results:
          path: var/tests/phpunit
      - store_artifacts:
          path: var/tests/phpunit

  back_behat_legacy:
    machine:
      enabled: true
      docker_layer_caching: true
    parallelism: 20
    steps:
      - attach_workspace:
          at: ~/
      - run:
          name: Change owner on project dir in order to archive the project into the workspace
          command: sudo chown -R 1000:1000 ../project
      - run:
          name: Start containers
          command: docker-compose up -d
      - run:
          name: Install database
          command: |
            sleep 25 # wait mysql to be up
            docker-compose exec akeneo-behat app/console --env=behat pim:install:db
      - run:
          name: Behat
          command: |
            TESTFILES=$(docker-compose exec -T akeneo-behat bin/behat --list-scenarios | circleci tests split)
            vendor/akeneo/pim-community-dev/.circleci/run_behat.sh $TESTFILES
      - store_test_results:
          path: var/tests/behat
      - store_artifacts:
          path: var/tests/behat

workflows:
  version: 2
  pull_request:
    jobs:
      - wait_for_user_approval:
          type: approval
          filters:
            branches:
              ignore:
                - "1.7"
      - setup:
          requires:
            - wait_for_user_approval
      - back_static:
          requires:
            - setup
      - back_phpunit_integration:
          requires:
            - back_static
      - back_behat_legacy:
          requires:
            - back_phpunit_integration
