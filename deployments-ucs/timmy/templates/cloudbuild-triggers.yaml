{{- range $cloudFunction := .Values.cloudFunctions }}
{{- with $ -}}
apiVersion: cloudbuild.cnrm.cloud.google.com/v1beta1
kind: CloudBuildTrigger
metadata:
  name: {{ include "timmy.fullname" . }}-{{ $cloudFunction.name }}
  annotations:
    cnrm.cloud.google.com/project-id: {{ .Values.common.gcpProjectID }}
spec:
  description: "Cloud Build Trigger to update and deploy the CloudFunction with CloudSource"
  disabled: false
  triggerTemplate:
    repoRef:
      external: {{ $cloudFunction.sourceRepository.name }}
    dir: {{ $cloudFunction.sourceRepository.dir }}
    branchName: {{ $cloudFunction.sourceRepository.branch }}
  includedFiles:
    - "{{ $cloudFunction.sourceRepository.dir }}/*"
  serviceAccountRef:
    external: "projects/{{ .Values.common.gcpProjectID }}/serviceAccounts/{{ include "timmy.deploymentGSAEmail" . }}"
  build:
    step:
      # Check if cloudfunction already exists to not create it
      - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
        args:
          - gcloud
          - functions
          - describe
          - "{{ include "timmy.fullname" . }}-{{ $cloudFunction.name }}"
          - --region={{ .Values.common.region }}
      - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
        args:
          - gcloud
          - functions
          - deploy
          - "{{ include "timmy.fullname" . }}-{{ $cloudFunction.name }}"
          - --region={{ .Values.common.region }}
          - --runtime={{ .Values.common.cloudFunctions.runtime }}
          - --service-account={{ include "timmy.deploymentGSAEmail" . }}
          - --source=https://source.developers.google.com/projects/{{ .Values.common.gcpProjectID }}/repos/{{ $cloudFunction.sourceRepository.name }}/revisions/{{ $cloudFunction.sourceRepository.branch }}/paths/{{ $cloudFunction.sourceRepository.dir }}
          - --trigger-http
    options:
      logging: CLOUD_LOGGING_ONLY
---
{{- end }}
{{- end }}
