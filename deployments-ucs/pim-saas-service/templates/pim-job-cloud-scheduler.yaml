{{ $tplCtx := . -}}
{{ range $schedulerKey, $jobConfiguration := .Values.pim.jobs -}}
{{- if $jobConfiguration.enabled }}
apiVersion: cloudscheduler.cnrm.cloud.google.com/v1beta1
kind: CloudSchedulerJob
metadata:
  annotations:
    cnrm.cloud.google.com/project-id: {{ $tplCtx.Values.common.gcpProjectID }}
  name: "{{ $tplCtx.Values.pim.jobsPrefix }}-{{ $schedulerKey }}"
spec:
  description: "Schedule job for {{ $jobConfiguration.pimJobName }}"
  location: {{ $tplCtx.Values.common.region }}
  timeZone: {{ $tplCtx.Values.pim.cloudFunction.timeZone }}
  schedule: '{{ $jobConfiguration.schedule }}'
  retryConfig:
    maxDoublings: 5
    maxRetryDuration: "3600s"
    retryCount: 4
    minBackoffDuration: "10s"
    maxBackoffDuration: "60s"
  httpTarget:
    headers:
      Content-Type: application/json
      User-Agent: "Google-Cloud-Scheduler"
    httpMethod: "POST"
    uri: "https://{{ $tplCtx.Values.common.region }}-{{ $tplCtx.Values.common.gcpProjectID }}.cloudfunctions.net/{{ $tplCtx.Values.pim.cloudFunction.name }}"
    oidcToken:
      audience: "https://{{ $tplCtx.Values.common.region }}-{{ $tplCtx.Values.common.gcpProjectID }}.cloudfunctions.net/{{ $tplCtx.Values.pim.cloudFunction.name }}"
      serviceAccountRef:
        external: "{{ $tplCtx.Values.pim.cloudFunction.serviceAccountEmail }}"
    body: {{ printf "{\"cluster_name\": \"%s\",\"topic_id\": \"%s\",\"job_code\":  \"%s\",\"job_options\": \"%s\" }" $tplCtx.Values.common.region $tplCtx.Values.pim.pubsub.topicJobQueueScheduledJob $jobConfiguration.pimJobName $jobConfiguration.pimJobOptions | squote |  replace "'" ""| b64enc }}
---
{{ end }}
{{ end }}
