aliases:
    - &envVarsDeployDev
        ENV_NAME: "dev"
        GOOGLE_PROJECT_ID: "akecld-saas-dev"
        GOOGLE_COMPUTE_ZONE: "europe-west3-a"
        CLUSTER_NAME: "europe-west3-a"

    - &dockerCloudDeployer
        docker:
            - image: eu.gcr.io/akeneo-cloud/cloud-deployer:7.7
              auth:
                  username: _json_key  # default username when using a JSON key file to authenticate
                  password: $GCLOUD_SERVICE_KEY_DEV  # JSON service account you created, do not encode to base64

commands:
    set_gcloud_config_dev:
        description: "Authenticate on GCP services and set config and key to be used by other tools that need to authenticate."
        steps:
            - run:
                  name: "Set Gcloud Config."
                  shell: "/bin/bash -eo pipefail"
                  command: |
                      echo ${GCLOUD_SERVICE_KEY_DEV} | gcloud auth activate-service-account --key-file=-
                      gcloud config set project ${GOOGLE_PROJECT_ID}
                      gcloud config set compute/zone ${GOOGLE_COMPUTE_ZONE}
                      gcloud container clusters get-credentials ${GOOGLE_COMPUTE_ZONE} --project=${GOOGLE_PROJECT_ID} --zone=${GOOGLE_COMPUTE_ZONE}
                      echo ${GCLOUD_SERVICE_KEY_DEV} > ${HOME}/gcloud-service-key.json
                      echo 'export GOOGLE_APPLICATION_CREDENTIALS="${HOME}/gcloud-service-key.json"' >> $BASH_ENV
                      export GOOGLE_APPLICATION_CREDENTIALS="${HOME}/gcloud-service-key.json"
                      gcloud auth configure-docker --quiet

    restore_persisted_env_vars:
        description: "Restore env vars that have been persisted by the previous job."
        steps:
            - run:
                  name: Restore persisted env vars
                  command: |
                      echo "Persisted env vars:"
                      cat persisted_env_vars
                      cat persisted_env_vars >> $BASH_ENV

    install_yq:
        description: "Install yq"
        steps:
            - run:
                  name: Install yq
                  command: |
                      wget https://github.com/mikefarah/yq/releases/download/3.3.1/yq_linux_386
                      sudo mv yq_linux_386 /usr/local/bin/yq
                      echo "e7fa464149a450d068311a244f403757408a745b  /usr/local/bin/yq" > /tmp/checksum
                      sha1sum -c /tmp/checksum
                      sudo chmod +x /usr/local/bin/yq

jobs:
    checkout_ee:
        machine:
            image: ubuntu-2004:202101-01
        steps:
            - add_ssh_keys:
                  fingerprints:
                      - "1f:25:f8:bb:59:52:95:f6:e2:f2:97:2f:30:d4:e9:66"
            - run:
                  name: Download EE dev with the SSH key that we added above
                  command: |
                      export GIT_SSH_COMMAND='ssh -i ~/.ssh/id_rsa_1f25f8bb595295f6e2f2972f30d4e966 -o UserKnownHostsFile=~/.ssh/known_hosts -o IdentitiesOnly=Yes'
                      git clone git@github.com:akeneo/pim-enterprise-dev.git /home/circleci/project
            - run:
                  name: Checkout EE branch if it exists, or master otherwise
                  command: |
                      cd /home/circleci/project
                      git checkout ${CIRCLE_BRANCH} || git checkout master
                      echo "Current commit: $(git rev-parse --short HEAD)"
            - run:
                  name: BIG COMMERCE CONNECTOR - Checkout BigCommerce Connector
                  command: |
                      mkdir -p tmp
                      export GIT_SSH_COMMAND='ssh -i ~/.ssh/id_rsa_1f25f8bb595295f6e2f2972f30d4e966 -o UserKnownHostsFile=~/.ssh/known_hosts -o IdentitiesOnly=Yes'
                      CONNECTOR_BC_BRANCH=$(git -c 'versionsort.suffix=-' ls-remote --exit-code --refs --sort='version:refname' --tags git@github.com:akeneo/bigcommerce-connector.git 'v*' | tail -n1 | cut -d'/' -f3)
                      git clone --branch $CONNECTOR_BC_BRANCH git@github.com:akeneo/bigcommerce-connector.git tmp/build-connector
            - run:
                  name: Require proper dev CE branch
                  command: |
                      sed -i "s#akeneo/pim-community-dev\": \"dev-master#akeneo/pim-community-dev\": \"dev-${CIRCLE_BRANCH}#" composer.json
                      sed -i "s#akeneo/pim-community-dev\": \"dev-master#akeneo/pim-community-dev\": \"dev-${CIRCLE_BRANCH}#" grth/composer.json
            - install_yq
            - run:
                  name: Remove MySQL port translation (see BH-664)
                  command: yq delete --inplace docker-compose.yml services.mysql.ports
            - run:
                  name: Persist default IMAGE_TAG to be the repo last commit SHA1
                  command: |
                      echo export IMAGE_TAG_SHORTED=$(echo $CIRCLE_SHA1 | cut -c -7) >> persisted_env_vars
                      echo export IMAGE_TAG=$CIRCLE_SHA1 >> persisted_env_vars
            - persist_to_workspace:
                  root: ~/
                  paths:
                      - project

    checkout_ce:
        machine:
            image: ubuntu-2004:202101-01
        steps:
            - checkout
            - install_yq
            - run:
                  name: Remove MySQL port translation (see BH-664)
                  command: yq delete --inplace docker-compose.yml services.mysql.ports
            - persist_to_workspace:
                  root: ~/
                  paths:
                      - project

    build_dev:
        parameters:
            is_ee_built:
                type: boolean
                default: true
            path_to_front_packages:
                type: string
                default: front-packages
        machine:
            image: ubuntu-2004:202101-01
        steps:
            - attach_workspace:
                  at: ~/
            - run:
                  name: Copy docker-compose.override.yml.dist
                  command: cp .circleci/docker-compose.override.yml.dist docker-compose.override.yml
            - when:
                  condition: << parameters.is_ee_built >>

                  steps:
                      - run:
                            name: Creating hash key for PHP Docker image
                            command: |
                                find Dockerfile docker/ -type f -print0 | sort -z | xargs -0 sha1sum | sha1sum > ~/php-docker-image.hash
                                date +%F >> ~/php-docker-image.hash
                      - restore_cache:
                            name: Restore PHP docker image cache
                            key: php-docker-image-{{ checksum "~/php-docker-image.hash" }}
                      - run:
                            name: Build the latest EE Docker images
                            command: |
                                ls php-pim-image.tar && docker load -i php-pim-image.tar
                                ls php-pim-image.tar || make php-image-dev
                                ls php-pim-image.tar || docker save -o php-pim-image.tar akeneo/pim-dev/php:8.0
                      - save_cache:
                            name: Save PHP docker image cache
                            key: php-docker-image-{{ checksum "~/php-docker-image.hash" }}
                            paths:
                                - php-pim-image.tar
            - unless:
                  condition: << parameters.is_ee_built >>
                  steps:
                      - run:
                            name: Save the CE image as a tar
                            command: |
                                docker pull akeneo/pim-php-dev:6.0
                                docker save -o php-pim-image.tar akeneo/pim-php-dev:6.0
            - run:
                  name: Setup tests results folder and log folder
                  command: mkdir -p var/tests/phpspec var/tests/csfixer var/logs var/tests/screenshots ~/.cache/yarn ~/.cache/Cypress ~/.composer
            - run:
                  name: Creating cache key for JS and PHP dependencies
                  command: |
                      cat yarn.lock > ~/front-dependency.hash && date +%F >> ~/front-dependency.hash
                      cat composer.json > ~/back-dependency.hash && date +%F >> ~/back-dependency.hash
            - restore_cache:
                  name: Restore cache - yarn and Cypress dependency cache
                  keys:
                      - frontend-dependency-cache-{{ checksum "~/front-dependency.hash" }}
            - restore_cache:
                  name: Restore cache - composer dependency cache
                  keys:
                      - backend-dependency-cache-{{ checksum "~/back-dependency.hash" }}
            - run:
                  name: Change owner on project dir (default user = circleci (1001) and docker needs uid 1000)
                  command: |
                      sudo chown -R 1000:1000 ../project ~/.composer ~/.cache/
            - run:
                  name: Install back and front dependencies
                  command: make dependencies
                  environment:
                      YARN_REGISTRY: "http://registry.yarnpkg.com"
            - run:
                  name: Install assets
                  command: make assets
            - run:
                  name: Build css
                  command: make css
            - run:
                  name: Create hash for front packages
                  # Adding date allows to invalidate the cache each new day, adding front package path avoid conflict between CE build and EE build
                  command: |
                      find << parameters.path_to_front_packages >>/akeneo-design-system -type f -print0 | sort -z | xargs -0 sha1sum | sha1sum > ~/akeneo-design-system.hash
                      find << parameters.path_to_front_packages >>/measurement -type f -print0 | sort -z | xargs -0 sha1sum | sha1sum > ~/measurement.hash
                      find << parameters.path_to_front_packages >>/shared -type f -print0 | sort -z | xargs -0 sha1sum | sha1sum > ~/shared.hash
                      find << parameters.path_to_front_packages >>/../src/Akeneo/Platform/Job/front/process-tracker -type f -print0 | sort -z | xargs -0 sha1sum | sha1sum > ~/process-tracker.hash
                      find << parameters.path_to_front_packages >>/../src/Akeneo/Platform/Bundle/CatalogVolumeMonitoringBundle/front -type f -print0 | sort -z | xargs -0 sha1sum | sha1sum > ~/catalog-volume-monitoring.hash
                      echo "$(date +%F) << parameters.path_to_front_packages >>" | tee -a ~/akeneo-design-system.hash ~/measurement.hash ~/shared.hash ~/catalog-volume-monitoring.hash ~/process-tracker.hash
            - run:
                  name: Set directories owner to circleci
                  command: sudo chown -R circleci:circleci .
            - restore_cache:
                  name: Restore front package DSM cache
                  key: front-packages-dsm-{{ checksum "~/akeneo-design-system.hash" }}
            - restore_cache:
                  name: Restore front package measurement cache
                  key: front-packages-measurement-{{ checksum "~/measurement.hash" }}
            - restore_cache:
                  name: Restore front package Shared cache
                  key: front-packages-shared-{{ checksum "~/shared.hash" }}
            - restore_cache:
                  name: Restore micro frontend Process tracker cache
                  key: micro-frontend-process-tracker-{{ checksum "~/process-tracker.hash" }}
            - restore_cache:
                  name: Restore micro-frontend Catalog Volume Monitoring cache
                  key: micro-frontend-catalog-volume-monitoring-{{ checksum "~/catalog-volume-monitoring.hash" }}
            - run:
                  name: Set directories owner to docker
                  command: sudo chown -R 1000:1000 ../project
            - run:
                  name: Build front-packages
                  command: make front-packages
            - run:
                  name: Build Javascript
                  command: make javascript-dev
            - run:
                  name: Change owner on project dir after installing when there is no cache
                  command: sudo chmod -R 777 ../project ~/.cache ~/.composer
            - save_cache:
                  name: Save frontend dependency cache
                  paths:
                      - ~/.cache
                  key: frontend-dependency-cache-{{ checksum "~/front-dependency.hash" }}
            - save_cache:
                  name: Save backend dependency cache
                  paths:
                      - ~/.composer
                  key: backend-dependency-cache-{{ checksum "~/back-dependency.hash" }}
            - save_cache:
                  name: Save front package DSM cache
                  key: front-packages-dsm-{{ checksum "~/akeneo-design-system.hash" }}
                  paths:
                      - << parameters.path_to_front_packages >>/akeneo-design-system/
            - save_cache:
                  name: Save front package measurement cache
                  key: front-packages-measurement-{{ checksum "~/measurement.hash" }}
                  paths:
                      - << parameters.path_to_front_packages >>/measurement/
            - save_cache:
                  name: Save front package Shared cache
                  key: front-packages-shared-{{ checksum "~/shared.hash" }}
                  paths:
                      - << parameters.path_to_front_packages >>/shared/
            - save_cache:
                  name: Save micro frontend Process Tracker cache
                  key: micro-frontend-process-tracker-{{ checksum "~/process-tracker.hash" }}
                  paths:
                      - << parameters.path_to_front_packages >>/../src/Akeneo/Platform/Job/front/process-tracker
            - save_cache:
                  name: Save micro-frontend Catalog Volume Monitoring cache
                  key: micro-frontend-catalog-volume-monitoring-{{ checksum "~/catalog-volume-monitoring.hash" }}
                  paths:
                      - << parameters.path_to_front_packages >>/../src/Akeneo/Platform/Bundle/CatalogVolumeMonitoringBundle/front
            - persist_to_workspace:
                  root: ~/
                  paths:
                      - project

    build_prod:
        parameters:
            is_ee_built:
                type: boolean
                default: true
        environment:
            <<: *envVarsDeployDev
        machine:
            image: ubuntu-2004:202101-01
        resource_class: medium
        working_directory: ~/project
        steps:
            - attach_workspace:
                  at: ~/
            - add_ssh_keys:
                  fingerprints:
                      - "1f:25:f8:bb:59:52:95:f6:e2:f2:97:2f:30:d4:e9:66"
            - set_gcloud_config_dev
            - restore_persisted_env_vars
            - run:
                  name: Define value for next steps
                  command: |
                      TYPE="srnt"
                      TYPE_LONG="serenity"
                      IMAGE_TAG=${CIRCLE_SHA1}
                      IMAGE_TAG_SHORTED=$(echo ${IMAGE_TAG} | cut -c -7)
                      IMAGE_TAG_DATE=$(date +%Y%m%d%H%M%S)
                      RELEASE_NAME="v$(date +%Y%m%d%H%M%S)"
                      PRODUCT_REFERENCE_TYPE="serenity_instance"
                      PRODUCT_REFERENCE_CODE="serenity_${ENV_NAME}"

                      echo export TYPE=${TYPE} >> $BASH_ENV
                      echo export TYPE_LONG=${TYPE_LONG} >> $BASH_ENV
                      echo export IMAGE_TAG=${IMAGE_TAG} >> $BASH_ENV
                      echo export IMAGE_TAG_SHORTED=${IMAGE_TAG_SHORTED} >> $BASH_ENV
                      echo export IMAGE_TAG_DATE=${IMAGE_TAG_DATE} >> $BASH_ENV
                      echo export RELEASE_NAME=${RELEASE_NAME} >> $BASH_ENV
                      echo export PRODUCT_REFERENCE_TYPE=${PRODUCT_REFERENCE_TYPE} >> $BASH_ENV
                      echo export PRODUCT_REFERENCE_CODE=${PRODUCT_REFERENCE_CODE} >> $BASH_ENV

                      echo "Image tag: ${IMAGE_TAG}"
                      echo "Serenity release name: ${RELEASE_NAME}"
            - run:
                  name: Build the Serenity Edition prod image
                  command: make -C deployments/ php-image-prod
            - run:
                  name: Push the Serenity Edition prod image on docker registry
                  command: make -C deployments/ push-php-image-prod
            - run:
                  name: Push Terraform modules to GCS
                  command: |
                      BOTO_CONFIG=/dev/null gsutil -m cp -r deployments/ gs://akecld-terraform-modules/serenity-edition-dev/${IMAGE_TAG}/
            - run:
                  name: Persist env vars for next jobs
                  command: |
                      echo export TYPE=${TYPE} > persisted_env_vars
                      echo export TYPE_LONG=${TYPE_LONG} >> persisted_env_vars
                      echo export IMAGE_TAG=${IMAGE_TAG} >> persisted_env_vars
                      echo export IMAGE_TAG_SHORTED=${IMAGE_TAG_SHORTED} >> persisted_env_vars
                      echo export IMAGE_TAG_DATE=${IMAGE_TAG_DATE} >> persisted_env_vars
                      echo export RELEASE_NAME=${RELEASE_NAME} >> persisted_env_vars
                      echo export PRODUCT_REFERENCE_TYPE=${PRODUCT_REFERENCE_TYPE} >> persisted_env_vars
                      echo export PRODUCT_REFERENCE_CODE=${PRODUCT_REFERENCE_CODE} >> persisted_env_vars
            - persist_to_workspace:
                  root: ~/
                  paths:
                      - project/persisted_env_vars

    test_deploy:
        environment:
            <<: *envVarsDeployDev
        <<: *dockerCloudDeployer
        resource_class: medium
        steps:
            - attach_workspace:
                  at: ~/
            - add_ssh_keys:
                  fingerprints:
                      - "1f:25:f8:bb:59:52:95:f6:e2:f2:97:2f:30:d4:e9:66"
            - set_gcloud_config_dev
            - restore_persisted_env_vars
            - run:
                  name: Define value for next steps
                  command: |
                      INSTANCE_NAME_PREFIX=pimci
                      INSTANCE_NAME=${INSTANCE_NAME_PREFIX}-${IMAGE_TAG_SHORTED}-${CIRCLE_BUILD_NUM}
                      echo export INSTANCE_NAME_PREFIX=${INSTANCE_NAME_PREFIX} >> $BASH_ENV
                      echo export INSTANCE_NAME=${INSTANCE_NAME} >> $BASH_ENV
                      echo "Instance name prefix: ${INSTANCE_NAME_PREFIX}"
                      echo "Instance name: ${INSTANCE_NAME}"
                      echo "Image tag: ${IMAGE_TAG}"
            - run:
                  name: DATADOG deployment Livetail logs page
                  command: echo "https://app.datadoghq.eu/logs/livetail?query=kube_namespace%3A${TYPE}-${INSTANCE_NAME}"
            - run:
                  name: Deploy PIM on kubernetes
                  command: |
                      NS=${TYPE}-${INSTANCE_NAME} PHASE=install bash deployments/bin/deployments_poll_up.sh 2>&1 >> deployment.log &
                      ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts
                      export GIT_SSH_COMMAND='ssh -i ~/.ssh/id_rsa_1f25f8bb595295f6e2f2972f30d4e966 -o UserKnownHostsFile=~/.ssh/known_hosts -o IdentitiesOnly=Yes'
                      make -C deployments/ deploy-instance
                      make -C deployments/ commit-instance
            - run:
                  name: Test PIM connexion on kubernetes
                  command: make -C deployments/ test-prod
            - run:
                  name: Display Deployment Errors
                  command: cat deployment.log
                  when: on_fail
            - run:
                  name: Prepare infrastructure artifacts
                  command: make -C deployments/ prepare-infrastructure-artifacts
                  when: on_fail
            - store_artifacts:
                  path: ~/artifacts/infra
            - store_artifacts:
                  path: deployment.log
                  destination: test_deploy_srnt_deployment.log
            - run:
                  name: Remove env on kubernetes
                  command: |
                      ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts
                      export GIT_SSH_COMMAND='ssh -i ~/.ssh/id_rsa_1f25f8bb595295f6e2f2972f30d4e966 -o UserKnownHostsFile=~/.ssh/known_hosts -o IdentitiesOnly=Yes'
                      UNCOMMIT_INSTANCE_STATUS_CODE=0
                      for i in 1 2 3; do make -C deployments/ uncommit-instance && UNCOMMIT_INSTANCE_STATUS_CODE=0 && break || UNCOMMIT_INSTANCE_STATUS_CODE=1; done
                      exit ${UNCOMMIT_INSTANCE_STATUS_CODE}
                  when: always
            - persist_to_workspace:
                  root: ~/
                  paths:
                      - upgrades.tfplan.json

    deploy_pr_environment:
        environment:
            <<: *envVarsDeployDev
        <<: *dockerCloudDeployer
        resource_class: small
        steps:
            - attach_workspace:
                  at: ~/
            - add_ssh_keys:
                  fingerprints:
                      - "1f:25:f8:bb:59:52:95:f6:e2:f2:97:2f:30:d4:e9:66"
            - set_gcloud_config_dev
            - restore_persisted_env_vars
            - run:
                  name: Define value for next steps
                  command: |
                      INSTANCE_NAME_PREFIX=pimci-pr
                      INSTANCE_NAME=${INSTANCE_NAME_PREFIX}-${CIRCLE_PULL_REQUEST##*/}
                      ACTIVATE_MONITORING=true
                      echo export IMAGE_TAG=${IMAGE_TAG} >> $BASH_ENV
                      echo export INSTANCE_NAME_PREFIX=${INSTANCE_NAME_PREFIX} >> $BASH_ENV
                      echo export INSTANCE_NAME=${INSTANCE_NAME} >> $BASH_ENV
                      echo export PRODUCT_REFERENCE_TYPE=${PRODUCT_REFERENCE_TYPE} >> $BASH_ENV
                      echo export PRODUCT_REFERENCE_CODE=${PRODUCT_REFERENCE_CODE} >> $BASH_ENV
                      echo export ACTIVATE_MONITORING=${ACTIVATE_MONITORING} >> $BASH_ENV
                      echo "Instance name prefix: ${INSTANCE_NAME_PREFIX}"
                      echo "Instance name: ${INSTANCE_NAME}"
                      echo "Image tag: ${IMAGE_TAG}"
            - run:
                  name: DATADOG deployment Livetail logs page
                  command: echo "https://app.datadoghq.eu/logs/livetail?query=kube_namespace%3A${TYPE}-${INSTANCE_NAME}"
            - run:
                  name: Check Circle CI PR
                  command: |
                      if [[ ${CIRCLE_PULL_REQUEST##*/} == "" ]]; then echo "ERROR : CIRCLE_PULL_REQUEST is empty."; exit 1;fi
                      echo "This environment will be available at https://${INSTANCE_NAME}.dev.cloud.akeneo.com once deployed :)"
            - run:
                  name: Deploy PR environment
                  command: |
                      NS=${TYPE}-${INSTANCE_NAME} PHASE=install bash deployments/bin/deployments_poll_up.sh 2>&1 >> deployment.log &
                      ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts
                      export GIT_SSH_COMMAND='ssh -i ~/.ssh/id_rsa_1f25f8bb595295f6e2f2972f30d4e966 -o UserKnownHostsFile=~/.ssh/known_hosts -o IdentitiesOnly=Yes'
                      make -C deployments/ deploy-instance
                      make -C deployments/ commit-instance
            - run:
                  name: Persist env vars for next jobs
                  command: |
                      echo export INSTANCE_NAME_PREFIX=${INSTANCE_NAME_PREFIX} >> persisted_env_vars
                      echo export INSTANCE_NAME=${INSTANCE_NAME} >> persisted_env_vars
                      echo export ACTIVATE_MONITORING=${ACTIVATE_MONITORING} >> persisted_env_vars
            - persist_to_workspace:
                  root: ~/
                  paths:
                      - project/persisted_env_vars
            - run:
                  name: Prepare infrastructure artifacts
                  command: make -C deployments/ prepare-infrastructure-artifacts
                  when: on_fail
            - run:
                  name: Remove env on kubernetes
                  command: |
                      ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts
                      export GIT_SSH_COMMAND='ssh -i ~/.ssh/id_rsa_1f25f8bb595295f6e2f2972f30d4e966 -o UserKnownHostsFile=~/.ssh/known_hosts -o IdentitiesOnly=Yes'
                      UNCOMMIT_INSTANCE_STATUS_CODE=0
                      for i in 1 2 3; do make -C deployments/ uncommit-instance && UNCOMMIT_INSTANCE_STATUS_CODE=0 && break || UNCOMMIT_INSTANCE_STATUS_CODE=1; done
                      exit ${UNCOMMIT_INSTANCE_STATUS_CODE}
                  when: on_fail
            - store_artifacts:
                  path: ~/artifacts/infra

    delete_pr_environment:
        environment:
            <<: *envVarsDeployDev
        <<: *dockerCloudDeployer
        steps:
            - attach_workspace:
                  at: ~/
            - add_ssh_keys:
                  fingerprints:
                      - "1f:25:f8:bb:59:52:95:f6:e2:f2:97:2f:30:d4:e9:66"
            - set_gcloud_config_dev
            - restore_persisted_env_vars
            - run:
                  name: Delete environments
                  no_output_timeout: 30m
                  command: |
                      ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts
                      export GIT_SSH_COMMAND='ssh -i ~/.ssh/id_rsa_1f25f8bb595295f6e2f2972f30d4e966 -o UserKnownHostsFile=~/.ssh/known_hosts -o IdentitiesOnly=Yes'
                      UNCOMMIT_INSTANCE_STATUS_CODE=0
                      for i in 1 2 3; do make -C deployments/ uncommit-instance && UNCOMMIT_INSTANCE_STATUS_CODE=0 && break || UNCOMMIT_INSTANCE_STATUS_CODE=1; done
                      exit ${UNCOMMIT_INSTANCE_STATUS_CODE}
