name: Pull Request

on:
  pull_request:
    branches:
      - main
      - 'community-edition-*'
    types: [opened, synchronize, reopened]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  PHP_VERSION: '8.3'
  NODE_VERSION: '18'
  COMPOSER_CACHE_DIR: ~/.composer/cache
  YARN_CACHE_DIR: ~/.cache/yarn

jobs:
  checkout:
    name: Checkout
    runs-on: ubuntu-latest
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Generate cache key
        id: cache-key
        run: echo "key=${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Create required directories
        run: |
          mkdir -p var/tests/phpspec
          mkdir -p var/tests/csfixer
          mkdir -p var/tests/phpunit
          mkdir -p var/tests/behat
          mkdir -p var/logs
          mkdir -p var/tests/screenshots
          mkdir -p ~/.composer

      - name: Upload workspace
        uses: actions/upload-artifact@v4
        with:
          name: workspace-${{ github.sha }}
          path: |
            .
            !.git
          retention-days: 1

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: checkout
    steps:
      - name: Download workspace
        uses: actions/download-artifact@v4
        with:
          name: workspace-${{ github.sha }}

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: intl, opcache, mysql, zip, xml, gd, curl, mbstring, bcmath, imagick, apcu, exif
          coverage: none
          tools: composer:v2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Get Composer cache directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: composer-${{ hashFiles('composer.lock') }}
          restore-keys: composer-

      - name: Cache Yarn dependencies
        uses: actions/cache@v4
        with:
          path: node_modules
          key: yarn-${{ hashFiles('yarn.lock') }}
          restore-keys: yarn-

      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: Install Yarn dependencies
        run: yarn install --frozen-lockfile

      - name: Build assets
        run: |
          bin/console assets:install --symlink
          yarn run less
          yarn run webpack-dev

      - name: Build front packages
        run: |
          yarn --cwd front-packages/shared build
          yarn --cwd front-packages/measurement build
          yarn --cwd front-packages/akeneo-design-system build

      - name: Upload built workspace
        uses: actions/upload-artifact@v4
        with:
          name: built-workspace-${{ github.sha }}
          path: |
            .
            !.git
          retention-days: 1

  test-back-static:
    name: Backend Static Analysis
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download built workspace
        uses: actions/download-artifact@v4
        with:
          name: built-workspace-${{ github.sha }}

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: intl, opcache, mysql, zip, xml, gd, curl, mbstring, bcmath, imagick, apcu, exif
          coverage: none

      - name: Lint Symfony container
        run: APP_ENV=dev bin/console lint:container

      - name: PHPStan analysis
        run: vendor/bin/phpstan analyse src/Akeneo/Pim --level 2 --memory-limit=2G

      - name: PHP-CS-Fixer
        run: vendor/bin/php-cs-fixer fix --diff --dry-run --config=.php-cs-fixer.php

  test-back-unit:
    name: Backend Unit Tests (PHPSpec)
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download built workspace
        uses: actions/download-artifact@v4
        with:
          name: built-workspace-${{ github.sha }}

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: intl, opcache, mysql, zip, xml, gd, curl, mbstring, bcmath, imagick, apcu, exif
          coverage: none

      - name: Run PHPSpec
        run: vendor/bin/phpspec run --format=progress

  test-back-acceptance:
    name: Backend Acceptance Tests
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download built workspace
        uses: actions/download-artifact@v4
        with:
          name: built-workspace-${{ github.sha }}

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: intl, opcache, mysql, zip, xml, gd, curl, mbstring, bcmath, imagick, apcu, exif
          coverage: none

      - name: Run Behat acceptance tests
        run: |
          APP_ENV=behat vendor/bin/behat -p acceptance --format progress --colors

  test-front-static:
    name: Frontend Static Analysis
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download built workspace
        uses: actions/download-artifact@v4
        with:
          name: built-workspace-${{ github.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: TypeScript type checking
        run: yarn run webpack-dev --strict

      - name: ESLint
        run: yarn lint

  test-front-unit:
    name: Frontend Unit Tests
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download built workspace
        uses: actions/download-artifact@v4
        with:
          name: built-workspace-${{ github.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Run Jest
        run: yarn unit

  test-back-phpunit:
    name: Backend PHPUnit Tests
    runs-on: ubuntu-latest
    needs: build
    services:
      mysql:
        image: mysql:8.0.34
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: akeneo_pim
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

      elasticsearch:
        image: elastic/elasticsearch:8.17.0
        env:
          discovery.type: single-node
          xpack.security.enabled: false
          ES_JAVA_OPTS: -Xms512m -Xmx512m
        ports:
          - 9200:9200
        options: >-
          --health-cmd="curl -f http://localhost:9200/_cluster/health"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3, 4, 5]
    steps:
      - name: Download built workspace
        uses: actions/download-artifact@v4
        with:
          name: built-workspace-${{ github.sha }}

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: intl, opcache, mysql, zip, xml, gd, curl, mbstring, bcmath, imagick, apcu, exif
          coverage: none

      - name: Wait for services
        run: |
          while ! mysqladmin ping -h 127.0.0.1 --silent; do sleep 1; done
          while ! curl -s http://localhost:9200/_cluster/health | grep -q '"status":"green"\|"status":"yellow"'; do sleep 1; done

      - name: Setup database
        env:
          APP_ENV: test
          DATABASE_URL: mysql://root:root@127.0.0.1:3306/akeneo_pim
          APP_INDEX_HOSTS: localhost:9200
        run: |
          bin/console doctrine:database:create --if-not-exists
          bin/console doctrine:schema:create

      - name: Run PHPUnit Integration tests (shard ${{ matrix.shard }}/5)
        env:
          APP_ENV: test
          DATABASE_URL: mysql://root:root@127.0.0.1:3306/akeneo_pim
          APP_INDEX_HOSTS: localhost:9200
        run: |
          # Get all test files and split into shards
          TEST_FILES=$(find tests -name '*Test.php' -path '*/Integration/*' | sort)
          TOTAL=$(echo "$TEST_FILES" | wc -l)
          SHARD_SIZE=$((TOTAL / 5 + 1))
          START=$(((${{ matrix.shard }} - 1) * SHARD_SIZE + 1))

          echo "$TEST_FILES" | tail -n +$START | head -n $SHARD_SIZE > /tmp/test_files.txt

          if [ -s /tmp/test_files.txt ]; then
            vendor/bin/phpunit --testsuite=PIM_Integration_Test $(cat /tmp/test_files.txt | tr '\n' ' ')
          fi

  test-back-migrations:
    name: Backend Migration Tests
    runs-on: ubuntu-latest
    needs: test-back-phpunit
    services:
      mysql:
        image: mysql:8.0.34
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: akeneo_pim
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

      elasticsearch:
        image: elastic/elasticsearch:8.17.0
        env:
          discovery.type: single-node
          xpack.security.enabled: false
          ES_JAVA_OPTS: -Xms512m -Xmx512m
        ports:
          - 9200:9200
        options: >-
          --health-cmd="curl -f http://localhost:9200/_cluster/health"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    steps:
      - name: Download built workspace
        uses: actions/download-artifact@v4
        with:
          name: built-workspace-${{ github.sha }}

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: intl, opcache, mysql, zip, xml, gd, curl, mbstring, bcmath, imagick, apcu, exif
          coverage: none

      - name: Wait for services
        run: |
          while ! mysqladmin ping -h 127.0.0.1 --silent; do sleep 1; done
          while ! curl -s http://localhost:9200/_cluster/health | grep -q '"status":"green"\|"status":"yellow"'; do sleep 1; done

      - name: Setup database
        env:
          APP_ENV: test
          DATABASE_URL: mysql://root:root@127.0.0.1:3306/akeneo_pim
          APP_INDEX_HOSTS: localhost:9200
        run: |
          bin/console doctrine:database:create --if-not-exists
          bin/console doctrine:schema:create

      - name: Run Migration tests
        env:
          APP_ENV: test
          DATABASE_URL: mysql://root:root@127.0.0.1:3306/akeneo_pim
          APP_INDEX_HOSTS: localhost:9200
        run: vendor/bin/phpunit --testsuite=PIM_Migration_Test

  cypress-sanity:
    name: Cypress Sanity Checks
    runs-on: ubuntu-latest
    needs: build
    services:
      mysql:
        image: mysql:8.0.34
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: akeneo_pim
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

      elasticsearch:
        image: elastic/elasticsearch:8.17.0
        env:
          discovery.type: single-node
          xpack.security.enabled: false
          ES_JAVA_OPTS: -Xms512m -Xmx512m
        ports:
          - 9200:9200
        options: >-
          --health-cmd="curl -f http://localhost:9200/_cluster/health"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    steps:
      - name: Download built workspace
        uses: actions/download-artifact@v4
        with:
          name: built-workspace-${{ github.sha }}

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: intl, opcache, mysql, zip, xml, gd, curl, mbstring, bcmath, imagick, apcu, exif
          coverage: none

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Wait for services
        run: |
          while ! mysqladmin ping -h 127.0.0.1 --silent; do sleep 1; done
          while ! curl -s http://localhost:9200/_cluster/health | grep -q '"status":"green"\|"status":"yellow"'; do sleep 1; done

      - name: Setup database with demo data
        env:
          APP_ENV: prod
          DATABASE_URL: mysql://root:root@127.0.0.1:3306/akeneo_pim
          APP_INDEX_HOSTS: localhost:9200
        run: |
          bin/console doctrine:database:create --if-not-exists
          bin/console pim:installer:db --catalog=src/Akeneo/Platform/Installer/back/src/Infrastructure/Symfony/Resources/fixtures/icecat_demo_dev

      - name: Start PHP built-in server
        env:
          APP_ENV: prod
          DATABASE_URL: mysql://root:root@127.0.0.1:3306/akeneo_pim
          APP_INDEX_HOSTS: localhost:9200
        run: |
          php -S 127.0.0.1:8080 -t public &
          sleep 5

      - name: Run Cypress tests
        uses: cypress-io/github-action@v6
        env:
          CYPRESS_baseUrl: http://127.0.0.1:8080
          CYPRESS_defaultCommandTimeout: 10000
          CYPRESS_requestTimeout: 15000
          CYPRESS_responseTimeout: 50000
        with:
          browser: chrome
          wait-on: 'http://127.0.0.1:8080'
          wait-on-timeout: 120

      - name: Upload Cypress screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-screenshots
          path: cypress/screenshots
          retention-days: 7

      - name: Upload Cypress videos
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-videos
          path: cypress/videos
          retention-days: 7

  test-back-behat-legacy:
    name: Behat Legacy Tests
    runs-on: ubuntu-latest
    needs: [test-back-static, test-front-static, test-back-unit]
    services:
      mysql:
        image: mysql:8.0.34
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: akeneo_pim
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

      elasticsearch:
        image: elastic/elasticsearch:8.17.0
        env:
          discovery.type: single-node
          xpack.security.enabled: false
          ES_JAVA_OPTS: -Xms512m -Xmx512m
        ports:
          - 9200:9200
        options: >-
          --health-cmd="curl -f http://localhost:9200/_cluster/health"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

      selenium:
        image: selenium/standalone-chrome:latest
        ports:
          - 4444:4444
        options: >-
          --shm-size=2g

    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
    steps:
      - name: Download built workspace
        uses: actions/download-artifact@v4
        with:
          name: built-workspace-${{ github.sha }}

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: intl, opcache, mysql, zip, xml, gd, curl, mbstring, bcmath, imagick, apcu, exif
          coverage: none

      - name: Wait for services
        run: |
          while ! mysqladmin ping -h 127.0.0.1 --silent; do sleep 1; done
          while ! curl -s http://localhost:9200/_cluster/health | grep -q '"status":"green"\|"status":"yellow"'; do sleep 1; done

      - name: Setup database
        env:
          APP_ENV: behat
          DATABASE_URL: mysql://root:root@127.0.0.1:3306/akeneo_pim
          APP_INDEX_HOSTS: localhost:9200
        run: |
          bin/console doctrine:database:create --if-not-exists
          bin/console pim:installer:db

      - name: Start PHP built-in server
        env:
          APP_ENV: behat
          DATABASE_URL: mysql://root:root@127.0.0.1:3306/akeneo_pim
          APP_INDEX_HOSTS: localhost:9200
        run: |
          php -S 127.0.0.1:8080 -t public &
          sleep 5

      - name: Run Behat Legacy tests (shard ${{ matrix.shard }}/10)
        env:
          APP_ENV: behat
          DATABASE_URL: mysql://root:root@127.0.0.1:3306/akeneo_pim
          APP_INDEX_HOSTS: localhost:9200
          BEHAT_PARAMS: '{"extensions":{"Behat\\MinkExtension":{"base_url":"http://127.0.0.1:8080","selenium2":{"wd_host":"http://localhost:4444/wd/hub"}}}}'
        run: |
          # Get all scenarios and split into shards
          SCENARIOS=$(vendor/bin/behat --list-scenarios -p legacy | sort)
          TOTAL=$(echo "$SCENARIOS" | wc -l)
          SHARD_SIZE=$((TOTAL / 10 + 1))
          START=$(((${{ matrix.shard }} - 1) * SHARD_SIZE + 1))

          echo "$SCENARIOS" | tail -n +$START | head -n $SHARD_SIZE > /tmp/scenarios.txt

          if [ -s /tmp/scenarios.txt ]; then
            vendor/bin/behat -p legacy --strict $(cat /tmp/scenarios.txt | tr '\n' ' ')
          fi

      - name: Upload Behat screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: behat-screenshots-shard-${{ matrix.shard }}
          path: var/tests/screenshots
          retention-days: 7

  pull-request-success:
    name: All Tests Passed
    runs-on: ubuntu-latest
    needs:
      - test-back-static
      - test-back-unit
      - test-back-acceptance
      - test-front-static
      - test-front-unit
      - test-back-phpunit
      - test-back-migrations
      - cypress-sanity
      - test-back-behat-legacy
    steps:
      - name: Success
        run: echo "All tests passed successfully!"
