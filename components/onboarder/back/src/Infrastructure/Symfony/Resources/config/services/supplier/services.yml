services:
    akeneo.onboarder_serenity.feature:
        class: Akeneo\Platform\Bundle\FeatureFlagBundle\Configuration\EnvVarFeatureFlag
        arguments:
            - '%env(bool:FLAG_ONBOARDER_SERENITY_ENABLED)%'
        public: true

    # Repositories
    Akeneo\OnboarderSerenity\Domain\Supplier\Write\Repository:
        class: Akeneo\OnboarderSerenity\Infrastructure\Supplier\Repository\Sql\DatabaseRepository
        arguments:
            - '@database_connection'

    # Command/Handlers
    Akeneo\OnboarderSerenity\Application\Supplier\CreateSupplierHandler:
        arguments:
            - '@Akeneo\OnboarderSerenity\Domain\Supplier\Write\Repository'
            - '@Akeneo\OnboarderSerenity\Domain\Supplier\Read\SupplierExists'
            - '@logger'

    Akeneo\OnboarderSerenity\Application\Supplier\UpdateSupplierHandler:
        arguments:
            - '@Akeneo\OnboarderSerenity\Domain\Supplier\Write\Repository'
            - '@validator'
            - '@logger'
            - '@event_dispatcher'

    Akeneo\OnboarderSerenity\Application\Supplier\DeleteSupplierHandler:
        arguments:
            - '@Akeneo\OnboarderSerenity\Domain\Supplier\Write\Repository'
            - '@logger'

    Akeneo\OnboarderSerenity\Application\Supplier\CreateContributorAccountHandler: ~

    # Queries
    Akeneo\OnboarderSerenity\Domain\Supplier\Read\GetSupplierList:
        class: Akeneo\OnboarderSerenity\Infrastructure\Supplier\Query\Sql\DatabaseGetSupplierList
        arguments:
            - '@database_connection'

    Akeneo\OnboarderSerenity\Domain\Supplier\Read\GetSupplier:
        class: Akeneo\OnboarderSerenity\Infrastructure\Supplier\Query\Sql\DatabaseGetSupplier
        arguments:
            - '@database_connection'

    Akeneo\OnboarderSerenity\Domain\Supplier\Read\GetSupplierCount:
        class: Akeneo\OnboarderSerenity\Infrastructure\Supplier\Query\Sql\DatabaseGetSupplierCount
        arguments:
            - '@database_connection'

    Akeneo\OnboarderSerenity\Domain\Supplier\Read\SupplierExists:
        class: Akeneo\OnboarderSerenity\Infrastructure\Supplier\Query\Sql\DatabaseSupplierExists
        arguments:
            - '@database_connection'

    Akeneo\OnboarderSerenity\Domain\Supplier\Read\GetAllSuppliersWithContributors:
        class: Akeneo\OnboarderSerenity\Infrastructure\Supplier\Query\Sql\DatabaseGetAllSuppliersWithContributors
        arguments:
            - '@database_connection'

    Akeneo\OnboarderSerenity\Domain\Supplier\Read\GetIdentifierFromCode:
        class: Akeneo\OnboarderSerenity\Infrastructure\Supplier\Query\Sql\DatabaseGetIdentifierFromCode
        arguments:
            - '@database_connection'

    Akeneo\OnboarderSerenity\Domain\Supplier\Read\SupplierContributorsBelongingToAnotherSupplier:
        class: Akeneo\OnboarderSerenity\Infrastructure\Supplier\Query\Sql\DatabaseSupplierContributorsBelongingToAnotherSupplier
        arguments:
            - '@database_connection'

    # Controllers
    Akeneo\OnboarderSerenity\Infrastructure\Supplier\Controller\SupplierList:
        public: true
        arguments:
            - '@Akeneo\OnboarderSerenity\Domain\Supplier\Read\GetSupplierList'
            - '@Akeneo\OnboarderSerenity\Domain\Supplier\Read\GetSupplierCount'

    Akeneo\OnboarderSerenity\Infrastructure\Supplier\Controller\SupplierCreate:
        public: true
        arguments:
            - '@Akeneo\OnboarderSerenity\Application\Supplier\CreateSupplierHandler'

    Akeneo\OnboarderSerenity\Infrastructure\Supplier\Controller\SupplierDelete:
        public: true
        arguments:
            - '@Akeneo\OnboarderSerenity\Application\Supplier\DeleteSupplierHandler'

    Akeneo\OnboarderSerenity\Infrastructure\Supplier\Controller\GetSupplier:
        public: true
        arguments:
            - '@Akeneo\OnboarderSerenity\Domain\Supplier\Read\GetSupplier'

    Akeneo\OnboarderSerenity\Infrastructure\Supplier\Controller\ExportSupplier:
        public: true
        arguments:
            - '@Akeneo\OnboarderSerenity\Domain\Supplier\Read\GetAllSuppliersWithContributors'
            - '@Akeneo\OnboarderSerenity\Infrastructure\Supplier\Encoder\SuppliersEncoder'

    Akeneo\OnboarderSerenity\Infrastructure\Supplier\Controller\SupplierUpdate:
        public: true
        arguments:
            - '@Akeneo\OnboarderSerenity\Application\Supplier\UpdateSupplierHandler'
            - '@Akeneo\OnboarderSerenity\Domain\Supplier\Read\SupplierContributorsBelongingToAnotherSupplier'

    Akeneo\OnboarderSerenity\Infrastructure\Supplier\Controller\GetSupplierContributorsBelongingToAnotherSupplier:
        public: true
        arguments:
            - '@Akeneo\OnboarderSerenity\Domain\Supplier\Read\SupplierContributorsBelongingToAnotherSupplier'
            - '@logger'

    Akeneo\OnboarderSerenity\Infrastructure\Supplier\Controller\DownloadImportSupplierTemplate:
        public: true
        arguments:
            - '@Akeneo\OnboarderSerenity\Infrastructure\Supplier\Encoder\SuppliersEncoder'

    # Encoders
    Akeneo\OnboarderSerenity\Infrastructure\Supplier\Encoder\SuppliersEncoder:
        class: Akeneo\OnboarderSerenity\Infrastructure\Supplier\Encoder\XlsxSuppliersEncoder
        arguments:
            - '@logger'

    # Import
    onboarder_serenity.job.xlsx_supplier_import:
        class: '%pim_connector.job.simple_job.class%'
        arguments:
            - 'onboarder_serenity_xlsx_supplier_import'
            - '@event_dispatcher'
            - '@akeneo_batch.job_repository'
            -   - '@pim_connector.step.charset_validator'
                - '@onboarder_serenity.step.xlsx_supplier.import'
        tags:
            - { name: akeneo_batch.job, connector: 'Akeneo Onboarder XLSX Connector', type: '%pim_connector.job.import_type%', feature: 'onboarder_serenity' }

    onboarder_serenity.step.xlsx_supplier.import:
        class: '%pim_connector.step.tasklet.class%'
        arguments:
            - 'import'
            - '@event_dispatcher'
            - '@akeneo_batch.job_repository'
            - '@Akeneo\OnboarderSerenity\Infrastructure\Supplier\Import\ImportSupplierTasklet'

    Akeneo\OnboarderSerenity\Infrastructure\Supplier\Import\ImportSupplierTasklet:
        arguments:
            - '@onboarder_serenity.connector.supplier.reader.file.xlsx'
            - '@validator'
            - '@Akeneo\OnboarderSerenity\Application\Supplier\CreateSupplierHandler'
            - '@Akeneo\OnboarderSerenity\Application\Supplier\UpdateSupplierHandler'
            - '@Akeneo\OnboarderSerenity\Domain\Supplier\Read\SupplierExists'
            - '@akeneo_batch.job_repository'
            - '@event_dispatcher'
            - '@Akeneo\OnboarderSerenity\Domain\Supplier\Read\GetIdentifierFromCode'
            - '@logger'

    onboarder_serenity.connector.supplier.reader.file.xlsx:
        class: '%pim_connector.reader.file.xlsx.class%'
        arguments:
            - '@pim_connector.reader.file.xlsx_iterator_factory'
            - '@Akeneo\OnboarderSerenity\Infrastructure\Supplier\Import\FlatToStandard'

    onboarder_serenity.job.job_parameters.default_values_provider.xlsx_supplier_import:
        class: '%pim_connector.job.job_parameters.default_values_provider.simple_xlsx_import.class%'
        arguments:
            - [ 'onboarder_serenity_xlsx_supplier_import' ]
        tags:
            - { name: akeneo_batch.job.job_parameters.default_values_provider }

    onboarder_serenity.job.job_parameters.constraint_collection_provider.xlsx_supplier_import:
        class: '%pim_connector.job.job_parameters.constraint_collection_provider.simple_xlsx_import.class%'
        arguments:
            - [ 'onboarder_serenity_xlsx_supplier_import' ]
        tags:
            - { name: akeneo_batch.job.job_parameters.constraint_collection_provider }

    Akeneo\OnboarderSerenity\Infrastructure\Supplier\Import\FlatToStandard:
        arguments:
            - '@pim_connector.array_convertor.checker.fields_requirement'

    onboarder_serenity.supplier.job_instance.form_provider:
        class: Akeneo\Platform\Bundle\ImportExportBundle\Provider\Form\JobInstanceFormProvider
        arguments:
            -   onboarder_serenity_xlsx_supplier_import: pim-job-instance-xlsx-base-import
        tags:
            - { name: pim_enrich.provider.form }

    # Validators
    Akeneo\OnboarderSerenity\Application\Supplier\Validation\UniqueContributorEmailValidator:
        arguments:
            - '@Akeneo\OnboarderSerenity\Domain\Supplier\Read\SupplierContributorsBelongingToAnotherSupplier'
        tags:
            - { name: validator.constraint_validator }

    #Event subscribers
    Akeneo\OnboarderSerenity\Application\Supplier\Subscriber\ContributorAddedSubscriber:
        arguments:
            - '@Akeneo\OnboarderSerenity\Application\Supplier\CreateContributorAccountHandler'
        tags:
            - 'kernel.event_subscriber'