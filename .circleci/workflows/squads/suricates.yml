executor-machine: &executor-machine

jobs:
    install_onboarder_supplier_front_dependencies:
        machine:
            image: *executor-machine
        resource_class: medium
        steps:
            -   attach_workspace:
                    at: ~/
            -   run:
                    name: Setup tests results folder and log folder
                    command: mkdir -p ~/.cache/yarn
            -   run:
                    name: Change owner on project dir (docker needs uid 1000, circleci can be another uid)
                    command: |
                        sudo chown -R 1000:1000 ../project
                        sudo chown -R 1000:1000 ~/.cache/
            -   run:
                    name: Set front packages directories owner to docker
                    command: sudo chown -R 1000:1000 components/onboarder-supplier/front/
            -   run:
                    name: Install supplier front dependencies
                    command: PIM_CONTEXT=onboarder-serenity make front-dependencies-supplier
            -   persist_to_workspace:
                    root: ~/
                    paths:
                        - project/components/onboarder-supplier/front/node_modules
    build_onboarder_supplier_front:
        machine:
            image: *executor-machine
        resource_class: medium
        steps:
            -   attach_workspace:
                    at: ~/
            -   run:
                    name: Setup tests results folder and log folder
                    command: mkdir -p ~/.cache/yarn
            -   run:
                    name: Change owner on project dir (docker needs uid 1000, circleci can be another uid)
                    command: |
                        sudo chown -R 1000:1000 ../project
                        sudo chown -R 1000:1000 ~/.cache/
            -   run:
                    name: Set front packages directories owner to docker
                    command: sudo chown -R 1000:1000 components/onboarder-supplier/front/
            -   run:
                    name: Install supplier front dependencies
                    command: PIM_CONTEXT=onboarder-serenity make front-dependencies-supplier
            -   run:
                    name: Build Onboarder Supplier frontend application
                    command: PIM_CONTEXT=onboarder-serenity make build-onboarder-supplier-front-app
            -   persist_to_workspace:
                    root: ~/
                    paths:
                        - project/components/onboarder-supplier/front/build

workflows:
  version: 2

  suricates_pull_request:
    when:
      not:
        equal: [ scheduled_pipeline, << pipeline.trigger_source >> ]
    jobs:
      - ready_to_build?:
          type: approval
          filters:
            branches:
              only:
                - /SURI-.*/
                - /OB2-.*/
                - /OBS-.*/
      - checkout:
          requires:
            - ready_to_build?
      - build_srnt_dev:
          requires:
            - checkout
      - install_onboarder_supplier_front_dependencies:
          requires:
            - checkout
      - test_front_onboarder:
          requires:
            - build_srnt_dev
            - install_onboarder_supplier_front_dependencies
      - test_back_onboarder:
          requires:
            - build_srnt_dev
      - test_database:
          requires:
            - build_srnt_dev
      - test_helm_generated_k8s_files:
          requires:
            - checkout
      - deploy_pr_environment?:
            name: "Deploy Onboarder PR environment?"
            type: approval
            filters:
              branches:
                only:
                  - /SURI-.*/
                  - /OB2-.*/
                  - /OBS-.*/
      - build_onboarder_supplier_front:
            requires:
              - checkout
              - "Deploy Onboarder PR environment?"
      - build_srnt_prod:
            name: "Build srnt Prod for deploy PR"
            requires:
              - checkout
              - test_helm_generated_k8s_files
              - build_onboarder_supplier_front
      - deploy_pr_environment:
            name: "Deploy Onboarder PR environment"
            requires:
                - "Build srnt Prod for deploy PR"
      - delete_pr_environment?:
            name: "Delete Onboarder PR environment?"
            type: approval
            requires:
                - "Deploy Onboarder PR environment"
      - delete_pr_environment:
            name: "Delete Onboarder PR environment"
            requires:
            - "Delete Onboarder PR environment?"
      - pull_request_success:
          requires:
            - test_front_onboarder
            - test_back_onboarder
            - test_database
