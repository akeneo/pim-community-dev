apiVersion: v1
kind: Pod
metadata:
  name: "{{ .Release.Name }}-auth-test"
  annotations:
    "helm.sh/hook": test-success
spec:
  containers:
  - name: {{ .Release.Name }}-auth-test
    image: curlimages/curl
    env:
      - name: TARGET
        value: https://{{ required ".Values.common.pimMasterDomain" .Values.common.pimMasterDomain }}
      - name: LOGIN
        value: {{ .Values.pim.defaultAdminUser.email }}
      - name: PASSWORD
        value: {{ .Values.pim.defaultAdminUser.password }}
    command: ["/bin/sh", "-c"]
    args:
    - export LOGIN_DATA=$(mktemp);
      export COOKIE_JAR=$(mktemp);
      echo "Testing ${TARGET}";
      timeout 500 curl --retry 300 --retry-delay 30 -k ${TARGET} > /dev/null;
      echo -n "_target_path=&_username=$LOGIN&_password=$PASSWORD&_csrf_token=" > $LOGIN_DATA;
      cat $LOGIN_DATA;
      curl --retry 5 --retry-delay 5 --connect-timeout 10 --cookie-jar $COOKIE_JAR $TARGET/user/login | grep "_csrf_token" | cut -d '"' -f 6 >> $LOGIN_DATA;
      curl --retry 5 --retry-delay 5 --connect-timeout 10 -XPOST --cookie $COOKIE_JAR --cookie-jar $COOKIE_JAR --data @$LOGIN_DATA $TARGET/user/login-check;
      curl --retry 5 --retry-delay 5 -L -m 5 --cookie $COOKIE_JAR $TARGET/dashboard;
      curl --retry 5 --retry-delay 5 -L -m 5 -w "%{http_code}" --cookie $COOKIE_JAR $TARGET/dashboard | grep 200;
  restartPolicy: Never
