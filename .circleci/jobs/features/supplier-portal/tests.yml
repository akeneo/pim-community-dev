executor-machine: &executor-machine

jobs:
    test_back_supplier_portal:
        machine:
            image: *executor-machine
            docker_layer_caching: true
        steps:
            -   attach_workspace:
                    at: ~/
            -   run:
                    name: Create Behat acceptance output directory
                    command: mkdir -p var/tests/behat/supplier-portal-acceptance ~/.cache/yarn
            -   run:
                    name: Change owner on project dir (docker needs uid 1000, circleci can be another uid)
                    command: |
                        sudo chown -R 1000:1000 ../project
            -   run:
                    name: Load archived docker PHP image
                    command: docker load -i php-pim-image.tar
            -   run:
                    name: Clear Docker network
                    command: docker network prune -f
            -   run:
                    name: Start containers
                    command: |
                        APP_ENV=test C='fpm mysql elasticsearch object-storage pubsub-emulator' make up
                        docker/wait_docker_up.sh
            -   run:
                    name: Install database
                    command: APP_ENV=test make database
            -   run:
                    name: Launch PHP static analyzer & check Sf services
                    command: PIM_CONTEXT=test make static-back
            -   run:
                    name: Run tests for Supplier Portal
                    command: PIM_CONTEXT=supplier-portal make tests-back-supplier-portal
            -   run:
                    name: Run migration tests for Supplier Portal
                    command: PIM_CONTEXT=supplier-portal make test-migrations
            - store_test_results:
                path: var/tests/phpunit
    test_front_supplier_portal:
        machine:
            image: *executor-machine
            docker_layer_caching: true
        steps:
            -   attach_workspace:
                    at: ~/
            -   run:
                    name: Create Yarn cache directory
                    command: mkdir -p ~/.cache/yarn
            -   run:
                    name: Change owner on project dir and yarn cache dir (docker needs uid 1000, circleci can be another uid)
                    command: |
                        sudo chown -R 1000:1000 ../project
                        sudo chown -R 1000:1000 ~/.cache/yarn
            -   run:
                    name: Install supplier front dependencies
                    command:  |
                        PIM_CONTEXT=supplier-portal make install-front-dependencies-supplier
            -   run:
                    name: Run tests front for Supplier Portal
                    command: PIM_CONTEXT=supplier-portal make tests-front-supplier-portal
