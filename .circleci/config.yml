version: 2.1

setup: true

orbs:
    continuation: circleci/continuation@0.2.0

jobs:
    merge_config:
        executor: continuation/default
        steps:
            - run:
                name: Checkout code
                command: |
                      mkdir -p ~/.ssh
                      chmod 0700 ~/.ssh
                      echo 'github.com ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAq2A7hRGmdnm9tUDbO9IDSwBK6TbQa+PXYPCPy6rbTrTtw7PHkccKrpp0yVhp5HdEIcKr6pLlVDBfOLX9QUsyCOV0wzfjIJNlGEYsdlLJizHhbn2mUjvSAHQqZETYP81eFzLQNnPHt4EVVUh7VfDESU84KezmD5QlWpXLmvU31/yMf+Se8xhHTvKSCZIFImWwoG6mbUoWf9nzpIoaSjB+weqqUUmpaaasXVal72J+UX2B+2RPW3RcT0eOzQgqlJL3RKrTJvdsjE3JEAvGq3lGHSZXy28G3skua2SmVi/w4yCE6gbODqnTWlg7+wC604ydGXA8VJiS5ap43JXiUFFAaQ==' >> ~/.ssh/known_hosts
                      echo "$CHECKOUT_KEY" > ~/.ssh/id_rsa
                      chmod 0600 ~/.ssh/id_rsa ~/.ssh/known_hosts
                      git config --global url."ssh://git@github.com".insteadOf "https://github.com" || true
                      git config --global gc.auto 0 || true
                      git clone --depth=1 --single-branch -b $CIRCLE_BRANCH $CIRCLE_REPOSITORY_URL .
                      git --no-pager log --no-color -n 1 --format='HEAD is now at %h %s'
            - run:
                  name: Install yq
                  command: |
                      wget https://github.com/mikefarah/yq/releases/download/v4.13.2/yq_linux_386
                      sudo mv yq_linux_386 /usr/local/bin/yq
                      echo "3a011f37fd67ac2fe3b334b46a6e848698d5621d  /usr/local/bin/yq" > /tmp/checksum
                      sha1sum -c /tmp/checksum
                      sudo chmod +x /usr/local/bin/yq
            - run:
                  name: Merge all files
                  command: |
                      yq eval-all '. as $item ireduce ({}; . *+ $item )' .circleci/jobs/*/*.yml .circleci/workflows/*.yml .circleci/workflows/*/*.yml > .circleci/merged_config.yml
                      cat .circleci/merged_config.yml
            - continuation/continue:
                  configuration_path: .circleci/merged_config.yml

workflows:
    version: 2

    merge_config_workflow:
        jobs:
            - merge_config
