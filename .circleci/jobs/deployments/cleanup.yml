envVarsDeployDev: &envVarsDeployDev
envVarsDeployPIMSaaSDev: &envVarsDeployPIMSaaSDev
dockerCloudDeployerCurrent: &dockerCloudDeployerCurrent
dockerCloudDeployerNext: &dockerCloudDeployerNext
dockerCloudDeployerUCS: &dockerCloudDeployerUCS
executor-machine: &executor-machine

jobs:
    delete_environment:
        parameters:
            INSTANCE_NAME:
                type: string
                default: ""
        environment:
            <<: *envVarsDeployDev
        <<: *dockerCloudDeployerCurrent
        resource_class: small
        steps:
            - attach_workspace:
                  at: ~/
            - add_ssh_keys:
                  fingerprints:
                      - "1f:25:f8:bb:59:52:95:f6:e2:f2:97:2f:30:d4:e9:66"
            - set_gcloud_config_dev
            - run:
                  name: Delete environments
                  no_output_timeout: 30m
                  command: |
                      ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts
                      export GIT_SSH_COMMAND='ssh -i ~/.ssh/id_rsa_1f25f8bb595295f6e2f2972f30d4e966 -o UserKnownHostsFile=~/.ssh/known_hosts -o IdentitiesOnly=Yes'
                      NS=<<parameters.INSTANCE_NAME>> make -C deployments/ delete_environment_manually

    delete_pr_environment:
        parameters:
            PRODUCT_TYPE:
                type: string
                default: ""
            INSTANCE_NAME:
                type: string
                default: ""
        environment:
            <<: *envVarsDeployDev
        <<: *dockerCloudDeployerCurrent
        resource_class: small
        steps:
            - attach_workspace:
                  at: ~/
            - add_ssh_keys:
                  fingerprints:
                      - "1f:25:f8:bb:59:52:95:f6:e2:f2:97:2f:30:d4:e9:66"
            - set_gcloud_config_dev
            - restore_persisted_env_vars
            - run:
                  name: Delete environments
                  no_output_timeout: 30m
                  command: |
                      ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts
                      export GIT_SSH_COMMAND='ssh -i ~/.ssh/id_rsa_1f25f8bb595295f6e2f2972f30d4e966 -o UserKnownHostsFile=~/.ssh/known_hosts -o IdentitiesOnly=Yes'
                      UNCOMMIT_INSTANCE_STATUS_CODE=0
                      for i in 1 2 3; do make -C deployments/ uncommit-instance && UNCOMMIT_INSTANCE_STATUS_CODE=0 && break || UNCOMMIT_INSTANCE_STATUS_CODE=1; done
                      exit ${UNCOMMIT_INSTANCE_STATUS_CODE}

    delete_tenant:
        parameters:
            PRODUCT_TYPE:
                type: string
                default: ""
            INSTANCE_NAME:
                type: string
                default: ""
        environment:
            <<: *envVarsDeployPIMSaaSDev
        <<: *dockerCloudDeployerUCS
        resource_class: small
        steps:
            - attach_workspace:
                  at: ~/
            - set_gcloud_config_pim_saas_dev
            - restore_persisted_env_vars
            - run:
                  name: Delete environments
                  no_output_timeout: 30m
                  command: |
                      DELETE_TENANT_STATUS_CODE=0
                      for i in 1 2 3; do make -C deployments-ucs/ delete_tenant && DELETE_TENANT_STATUS_CODE=0 && break || DELETE_TENANT_STATUS_CODE=1; done
                      exit ${DELETE_TENANT_STATUS_CODE}

    delete_pim:
        parameters:
            PRODUCT_TYPE:
                type: string
                default: ""
            INSTANCE_NAME:
                type: string
                default: ""
        environment:
            <<: *envVarsDeployPIMSaaSDev
        <<: *dockerCloudDeployerUCS
        resource_class: small
        steps:
            - attach_workspace:
                  at: ~/
            - set_gcloud_config_pim_saas_dev
            - restore_persisted_env_vars
            - run:
                  name: Delete environments
                  command: |
                      CIRCLE_BRANCH_LOWER=$(echo "${CIRCLE_BRANCH}" | awk '{print tolower($0)}')

                      kubectl delete app pim-${CIRCLE_BRANCH_LOWER} -n argocd
                      kubectl delete ns pim-${CIRCLE_BRANCH_LOWER}

    delete_environments_hourly:
        parameters:
            PRODUCT_TYPE:
                type: string
                default: ""
        environment:
            <<: *envVarsDeployDev
        <<: *dockerCloudDeployerCurrent
        resource_class: small
        steps:
            - attach_workspace:
                  at: ~/
            - add_ssh_keys:
                  fingerprints:
                      - "1f:25:f8:bb:59:52:95:f6:e2:f2:97:2f:30:d4:e9:66"
            - set_gcloud_config_dev
            - run:
                  name: Delete environments
                  no_output_timeout: 30m
                  command: |
                      TYPE="<<parameters.PRODUCT_TYPE>>"
                      ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts

                      export GIT_SSH_COMMAND='ssh -i ~/.ssh/id_rsa_1f25f8bb595295f6e2f2972f30d4e966 -o UserKnownHostsFile=~/.ssh/known_hosts -o IdentitiesOnly=Yes'

                      TYPE=${TYPE} make -C deployments/ delete_environments_hourly

    remove_unused_resources:
        environment:
            <<: *envVarsDeployDev
        <<: *dockerCloudDeployerCurrent
        resource_class: small
        steps:
            - attach_workspace:
                  at: ~/
            - set_gcloud_config_dev
            - run:
                  name: Remove unused resources
                  command:
                      make -C deployments/ remove_unused_resources

    delete_ucs_environments_hourly:
        environment:
            <<: *envVarsDeployPIMSaaSDev
        <<: *dockerCloudDeployerUCS
        resource_class: small
        steps:
            - attach_workspace:
                  at: ~/
            - set_gcloud_config_pim_saas_dev
            - run:
                  name: Delete tenant environments
                  no_output_timeout: 15m
                  command: |
                      sh deployments-ucs/bin/remove_tenants.sh
            - run:
                  name: Delete PIM environments
                  no_output_timeout: 15m
                  command: |
                      sh deployments-ucs/bin/remove_pim.sh
