language: php
php:
    - "5.4"
    - "5.5"
    - "5.6"
    - "hhvm"
env:
    - STORAGE=orm
    - STORAGE=mongo

sudo: true

matrix:
    allow_failures:
        - php: "hhvm"

cache:
  directories:
    - $HOME/.composer/cache

before_script:
    - echo -e "Host github.com\n\tStrictHostKeyChecking no\n" >> ~/.ssh/config
    - npm install -g grunt-cli
    - npm install
    - curl http://get.sensiolabs.org/php-cs-fixer.phar -o php-cs-fixer
    - sudo apt-get update > /dev/null
    - sudo apt-get install -y --force-yes apache2 libapache2-mod-php5 php5-curl php5-mysql php5-intl
    - sudo sed -i -e "s,/var/www,$(pwd)/web,g" /etc/apache2/sites-available/default
    - sudo /etc/init.d/apache2 restart

    - php app/check.php

    - composer self-update --no-interaction
    - ant prepare
    - sh -c 'if [ "$STORAGE" == "mongo" ]; then ant require-mongo; fi;'
    - sh -c 'if [ "$STORAGE" == "mongo" ]; then ant activate-mongo; fi;'
    - ant vendors
    - ant install-all-behat

    # Initialize xvfb + selenium
    - "sh -e /etc/init.d/xvfb start"
    - "export DISPLAY=:99.0"
    - "wget http://selenium.googlecode.com/files/selenium-server-standalone-2.31.0.jar"
    - "java -jar selenium-server-standalone-2.31.0.jar > /dev/null &"
    - sleep 5

script:
    - php bin/phpunit -c app/phpunit.travis.xml --testsuite PIM_Unit_Test
    - php bin/behat
    - php phpspec-fix
    - php php-cs-fixer fix --dry-run -v --diff --config-file=.php_cs.php
    - grunt travis

notifications:
  slack: akeneo:fDZaQeRRj1gVtXCW3f2kQAxo

