envVarsDeployPIMSaaSDev: &envVarsDeployPIMSaaSDev
executor-machine: &executor-machine

jobs:
  # Description :
  #    Build image for pim-deployer
  build_and_push_pim_deployer:
    environment:
        <<: *envVarsDeployPIMSaaSDev
    machine:
        image: *executor-machine
    resource_class: medium
    working_directory: ~/project
    steps:
      - attach_workspace:
            at: ~/
      - set_gcloud_config_pim_saas_dev
      - run:
          name: Check if image already exists
          command: |
            REGEX_RELEASE_CHANGELOG='^# (.*)$'

            if [[ "$(head -n 1 deployments-ucs/tooling/pim-deployer/CHANGELOG.md)" =~ ${REGEX_RELEASE_CHANGELOG} ]]; then
                RELEASE_CHANGELOG="${BASH_REMATCH[1]}"
            else
                echo "Release version number is missing from the first line of CHANGELOG.md"
                exit 1
            fi
            echo export RELEASE_CHANGELOG=${RELEASE_CHANGELOG} >> $BASH_ENV
      - run:
          name: Build and push the image
          command: |
            docker manifest inspect ${GOOGLE_CLUSTER_REGION}-docker.pkg.dev/${GOOGLE_PROJECT_ID_SHARED}/prod/pim-deployer:${RELEASE_CHANGELOG} &> /dev/null && echo release tag ${RELEASE_CHANGELOG} alredy exist && exit 1

            cd deployments-ucs/tooling/pim-deployer
            docker build . --target pim-deployer-dev --tag ${GOOGLE_CLUSTER_REGION}-docker.pkg.dev/${GOOGLE_PROJECT_ID_SHARED}/dev/pim-deployer:${RELEASE_CHANGELOG}
            docker push ${GOOGLE_CLUSTER_REGION}-docker.pkg.dev/${GOOGLE_PROJECT_ID_SHARED}/dev/pim-deployer:${RELEASE_CHANGELOG}
            docker build . --target pim-deployer-prod --tag ${GOOGLE_CLUSTER_REGION}-docker.pkg.dev/${GOOGLE_PROJECT_ID_SHARED}/prod/pim-deployer:${RELEASE_CHANGELOG}
            docker push ${GOOGLE_CLUSTER_REGION}-docker.pkg.dev/${GOOGLE_PROJECT_ID_SHARED}/prod/pim-deployer:${RELEASE_CHANGELOG}

  # Description :
  #    Build image for curl_jq_zip
  build_and_push_curl_jq_zip:
    environment:
        <<: *envVarsDeployPIMSaaSDev
    machine:
        image: *executor-machine
    resource_class: medium
    working_directory: ~/project
    steps:
      - attach_workspace:
            at: ~/
      - set_gcloud_config_pim_saas_dev
      - run:
          name: Check if image already exists
          command: |
            REGEX_RELEASE_CHANGELOG='^# (.*)$'

            if [[ "$(head -n 1 deployments-ucs/tooling/curl-jq-zip/CHANGELOG.md)" =~ ${REGEX_RELEASE_CHANGELOG} ]]; then
                RELEASE_CHANGELOG="${BASH_REMATCH[1]}"
            else
                echo "Release version number is missing from the first line of CHANGELOG.md"
                exit 1
            fi
            echo export RELEASE_CHANGELOG=${RELEASE_CHANGELOG} >> $BASH_ENV
      - run:
          name: Build and push the image
          command: |
            docker manifest inspect ${GOOGLE_CLUSTER_REGION}-docker.pkg.dev/${GOOGLE_PROJECT_ID_SHARED}/prod/curl-jq-zip:${RELEASE_CHANGELOG} &> /dev/null && echo release tag ${RELEASE_CHANGELOG} alredy exist && exit 1

            cd deployments-ucs/tooling/curl-jq-zip
            docker build . --tag ${GOOGLE_CLUSTER_REGION}-docker.pkg.dev/${GOOGLE_PROJECT_ID_SHARED}/dev/curl-jq-zip:${RELEASE_CHANGELOG}
            docker push ${GOOGLE_CLUSTER_REGION}-docker.pkg.dev/${GOOGLE_PROJECT_ID_SHARED}/dev/curl-jq-zip:${RELEASE_CHANGELOG}
            docker build . --tag ${GOOGLE_CLUSTER_REGION}-docker.pkg.dev/${GOOGLE_PROJECT_ID_SHARED}/prod/curl-jq-zip:${RELEASE_CHANGELOG}
            docker push ${GOOGLE_CLUSTER_REGION}-docker.pkg.dev/${GOOGLE_PROJECT_ID_SHARED}/prod/curl-jq-zip:${RELEASE_CHANGELOG}
