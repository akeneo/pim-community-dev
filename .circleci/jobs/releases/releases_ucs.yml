envVarsDeployPIMSaaSDev: &envVarsDeployPIMSaaSDev
executor-machine: &executor-machine

jobs:
    release_ucs:
        environment:
            <<: *envVarsDeployPIMSaaSDev
        machine:
            image: *executor-machine
        resource_class: medium
        steps:
            - attach_workspace:
                  at: ~/
            - add_ssh_keys:
                  fingerprints:
                      - "ee:73:a1:e4:ef:57:13:9e:cf:d3:23:fb:e2:c1:d7:92"
            - restore_persisted_env_vars
            - install_yq_v3
            - run:
                  name: Pull image from prod registry
                  command: |
                      echo ${GCLOUD_SERVICE_KEY_DEV} | gcloud auth activate-service-account --key-file=-
                      gcloud config set project akecld-saas-dev
                      gcloud config set compute/zone europe-west3-a
                      gcloud container clusters get-credentials europe-west3-a --project=akecld-saas-dev --zone=europe-west3-a
                      echo ${GCLOUD_SERVICE_KEY_DEV} > ${HOME}/gcloud-service-key.json
                      echo 'export GOOGLE_APPLICATION_CREDENTIALS="${HOME}/gcloud-service-key.json"' >> $BASH_ENV
                      export GOOGLE_APPLICATION_CREDENTIALS="${HOME}/gcloud-service-key.json"
                      gcloud auth configure-docker --quiet

                      docker pull eu.gcr.io/akeneo-cloud/pim-enterprise-dev:${RELEASE_NAME}
            - set_gcloud_config_pim_saas_dev
            - run:
                  name: Tag and push prod image to UCS dev and prod registry
                  command: |
                      docker image tag eu.gcr.io/akeneo-cloud/pim-enterprise-dev:${RELEASE_NAME} ${GOOGLE_CLUSTER_REGION}-docker.pkg.dev/${GOOGLE_PROJECT_ID_SHARED}/dev/pim-enterprise-dev:${RELEASE_NAME}
                      docker image tag eu.gcr.io/akeneo-cloud/pim-enterprise-dev:${RELEASE_NAME} ${GOOGLE_CLUSTER_REGION}-docker.pkg.dev/${GOOGLE_PROJECT_ID_SHARED}/prod/pim-enterprise-dev:${RELEASE_NAME}
                      docker push ${GOOGLE_CLUSTER_REGION}-docker.pkg.dev/${GOOGLE_PROJECT_ID_SHARED}/dev/pim-enterprise-dev:${RELEASE_NAME}
                      docker push ${GOOGLE_CLUSTER_REGION}-docker.pkg.dev/${GOOGLE_PROJECT_ID_SHARED}/prod/pim-enterprise-dev:${RELEASE_NAME}
            - run:
                name: Update the pim-saas-k8s-artifacts with the new values for master branch
                command: |
                  ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts
                  export GIT_SSH_COMMAND='ssh -i ~/.ssh/id_rsa_ee73a1e4ef57139ecfd323fbe2c1d792 -o UserKnownHostsFile=~/.ssh/known_hosts -o IdentitiesOnly=Yes'
                  git config --global user.email "pim_ci@akeneo.com"
                  git config --global user.name "pim_ci_deployment"

                  git clone git@github.com:akeneo/pim-saas-k8s-artifacts.git /tmp/pim-saas-k8s-artifacts

                  # argocd
                  rm -rf /tmp/pim-saas-k8s-artifacts/argocd
                  cp -r deployments-ucs/argocd /tmp/pim-saas-k8s-artifacts/argocd

                  # argocd-apps
                  rm -rf /tmp/pim-saas-k8s-artifacts/argocd-apps
                  cp -r deployments-ucs/argocd-apps /tmp/pim-saas-k8s-artifacts/argocd-apps

                  # infra
                  rm -rf /tmp/pim-saas-k8s-artifacts/infra
                  mkdir -p /tmp/pim-saas-k8s-artifacts/infra
                  cp -r deployments-ucs/infra/k8s /tmp/pim-saas-k8s-artifacts/infra/k8s

                  # pim-saas-services
                  rm -rf /tmp/pim-saas-k8s-artifacts/pim-saas-service
                  bash deployments-ucs/bin/deploy_artifacts_akecld-prd-pim-saas-dev-europe-west1.sh
                  bash deployments-ucs/bin/deploy_artifacts_akecld-prd-pim-saas-dev-europe-west3.sh

                  bash deployments-ucs/bin/deploy_artifacts_akecld-prd-pim-saas-sandbox-europe-west1.sh

                  bash deployments-ucs/bin/deploy_artifacts_demo-euw3-gke-pim-saas-demo-1.sh
                  bash deployments-ucs/bin/deploy_artifacts_demo-usc1-gke-pim-saas-demo-1.sh
                  bash deployments-ucs/bin/deploy_artifacts_demo-ause1-gke-pim-saas-demo-1.sh

                  cp -r deployments-ucs/pim-saas-service /tmp/pim-saas-k8s-artifacts/pim-saas-service

                  # tenant
                  rm -rf /tmp/pim-saas-k8s-artifacts/tenant
                  yq w -i deployments-ucs/tenant/values.yaml image.pim.tag "${RELEASE_NAME}"
                  cp -r deployments-ucs/tenant /tmp/pim-saas-k8s-artifacts/tenant

                  # timmy
                  rm -rf /tmp/pim-saas-k8s-artifacts/timmy
                  cp -r deployments-ucs/timmy /tmp/pim-saas-k8s-artifacts/timmy

                  cd /tmp/pim-saas-k8s-artifacts
                  git add -A
                  # git diff for commit only when changes are present
                  if ! git diff-index --quiet HEAD; then
                    git commit -m "Update with release ${RELEASE_NAME}"
                    # Should the master branch be protected?
                    git push
                  fi
                  # Tag the repo with the release number
                  git tag -a ${RELEASE_NAME} -m "Update with release ${RELEASE_NAME}"
            - run:
                name: Update the pim-saas-k8s-artifacts with the new values for master-migration-step1 branch
                command: |
                  ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts
                  export GIT_SSH_COMMAND='ssh -i ~/.ssh/id_rsa_ee73a1e4ef57139ecfd323fbe2c1d792 -o UserKnownHostsFile=~/.ssh/known_hosts -o IdentitiesOnly=Yes'
                  git config --global user.email "pim_ci@akeneo.com"
                  git config --global user.name "pim_ci_deployment"

                  rm -rf /tmp/pim-saas-k8s-artifacts
                  MIGRATION_BRANCH=master-migration-step1
                  git clone -b ${MIGRATION_BRANCH} git@github.com:akeneo/pim-saas-k8s-artifacts.git /tmp/pim-saas-k8s-artifacts

                  # argocd
                  rm -rf /tmp/pim-saas-k8s-artifacts/argocd
                  cp -r deployments-ucs/argocd /tmp/pim-saas-k8s-artifacts/argocd

                  # argocd-apps
                  rm -rf /tmp/pim-saas-k8s-artifacts/argocd-apps
                  cp -r deployments-ucs/argocd-apps /tmp/pim-saas-k8s-artifacts/argocd-apps

                  # infra
                  rm -rf /tmp/pim-saas-k8s-artifacts/infra
                  mkdir -p /tmp/pim-saas-k8s-artifacts/infra
                  cp -r deployments-ucs/infra/k8s /tmp/pim-saas-k8s-artifacts/infra/k8s

                  # pim-saas-services
                  rm -rf /tmp/pim-saas-k8s-artifacts/pim-saas-service
                  bash deployments-ucs/bin/deploy_artifacts_akecld-prd-pim-saas-dev-europe-west1.sh
                  bash deployments-ucs/bin/deploy_artifacts_akecld-prd-pim-saas-dev-europe-west3.sh

                  bash deployments-ucs/bin/deploy_artifacts_akecld-prd-pim-saas-sandbox-europe-west1.sh

                  bash deployments-ucs/bin/deploy_artifacts_demo-euw3-gke-pim-saas-demo-1.sh
                  bash deployments-ucs/bin/deploy_artifacts_demo-usc1-gke-pim-saas-demo-1.sh
                  bash deployments-ucs/bin/deploy_artifacts_demo-ause1-gke-pim-saas-demo-1.sh

                  cp -r deployments-ucs/pim-saas-service /tmp/pim-saas-k8s-artifacts/pim-saas-service

                  # tenant
                  rm -rf /tmp/pim-saas-k8s-artifacts/tenant
                  mkdir -p /tmp/pim-saas-k8s-artifacts/tenant
                  cp deployments-ucs/tenant/Chart.yaml /tmp/pim-saas-k8s-artifacts/tenant/Chart.yaml
                  yq d -i /tmp/pim-saas-k8s-artifacts/tenant/Chart.yaml dependencies
                  yq w -i deployments-ucs/tenant/values.yaml image.pim.tag "${RELEASE_NAME}"
                  cp deployments-ucs/tenant/values.yaml /tmp/pim-saas-k8s-artifacts/tenant/values.yaml
                  mkdir -p /tmp/pim-saas-k8s-artifacts/tenant/templates
                  cp deployments-ucs/tenant/templates/storage-bucket.yaml /tmp/pim-saas-k8s-artifacts/tenant/templates/storage-bucket.yaml
                  mkdir -p /tmp/pim-saas-k8s-artifacts/tenant/argocd-app
                  cp deployments-ucs/tenant/argocd-app/tenant-application.yaml /tmp/pim-saas-k8s-artifacts/tenant/argocd-app/tenant-application.yaml

                  # timmy
                  rm -rf /tmp/pim-saas-k8s-artifacts/timmy
                  cp -r deployments-ucs/timmy /tmp/pim-saas-k8s-artifacts/timmy

                  cd /tmp/pim-saas-k8s-artifacts
                  git add -A
                  # git diff for commit only when changes are present
                  if ! git diff-index --quiet HEAD; then
                    git commit -m "Update with release ${RELEASE_NAME}"
                    git push
                  fi
            - run:
                name: Update the pim-saas-k8s-artifacts with the new values for master-migration-step2 branch
                command: |
                  ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts
                  export GIT_SSH_COMMAND='ssh -i ~/.ssh/id_rsa_ee73a1e4ef57139ecfd323fbe2c1d792 -o UserKnownHostsFile=~/.ssh/known_hosts -o IdentitiesOnly=Yes'
                  git config --global user.email "pim_ci@akeneo.com"
                  git config --global user.name "pim_ci_deployment"

                  rm -rf /tmp/pim-saas-k8s-artifacts
                  MIGRATION_BRANCH=master-migration-step2
                  git clone -b ${MIGRATION_BRANCH} git@github.com:akeneo/pim-saas-k8s-artifacts.git /tmp/pim-saas-k8s-artifacts

                  # argocd
                  rm -rf /tmp/pim-saas-k8s-artifacts/argocd
                  cp -r deployments-ucs/argocd /tmp/pim-saas-k8s-artifacts/argocd

                  # argocd-apps
                  rm -rf /tmp/pim-saas-k8s-artifacts/argocd-apps
                  cp -r deployments-ucs/argocd-apps /tmp/pim-saas-k8s-artifacts/argocd-apps

                  # infra
                  rm -rf /tmp/pim-saas-k8s-artifacts/infra
                  mkdir -p /tmp/pim-saas-k8s-artifacts/infra
                  cp -r deployments-ucs/infra/k8s /tmp/pim-saas-k8s-artifacts/infra/k8s

                  # pim-saas-services
                  rm -rf /tmp/pim-saas-k8s-artifacts/pim-saas-service
                  bash deployments-ucs/bin/deploy_artifacts_akecld-prd-pim-saas-dev-europe-west1.sh
                  bash deployments-ucs/bin/deploy_artifacts_akecld-prd-pim-saas-dev-europe-west3.sh

                  bash deployments-ucs/bin/deploy_artifacts_akecld-prd-pim-saas-sandbox-europe-west1.sh

                  bash deployments-ucs/bin/deploy_artifacts_demo-euw3-gke-pim-saas-demo-1.sh
                  bash deployments-ucs/bin/deploy_artifacts_demo-usc1-gke-pim-saas-demo-1.sh
                  bash deployments-ucs/bin/deploy_artifacts_demo-ause1-gke-pim-saas-demo-1.sh

                  cp -r deployments-ucs/pim-saas-service /tmp/pim-saas-k8s-artifacts/pim-saas-service

                  # tenant
                  rm -rf /tmp/pim-saas-k8s-artifacts/tenant
                  cp -r deployments-ucs/tenant /tmp/pim-saas-k8s-artifacts/tenant
                  yq w -i /tmp/pim-saas-k8s-artifacts/tenant/values.yaml global.cloned true
                  yq w -i /tmp/pim-saas-k8s-artifacts/tenant/values.yaml pim.hook.migration.enabled true
                  yq w -i /tmp/pim-saas-k8s-artifacts/tenant/values.yaml mysql.mysql.resetPassword true

                  # Waiting PH-430
                  yq w -i /tmp/pim-saas-k8s-artifacts/tenant/values.yaml pim.hook.addAdmin.enabled false
                  yq w -i /tmp/pim-saas-k8s-artifacts/tenant/values.yaml pim.hook.installPim.enabled false

                  # timmy
                  rm -rf /tmp/pim-saas-k8s-artifacts/timmy
                  cp -r deployments-ucs/timmy /tmp/pim-saas-k8s-artifacts/timmy

                  cd /tmp/pim-saas-k8s-artifacts
                  git add -A
                  # git diff for commit only when changes are present
                  if ! git diff-index --quiet HEAD; then
                    git commit -m "Update with release ${RELEASE_NAME}"
                    git push
                  fi
