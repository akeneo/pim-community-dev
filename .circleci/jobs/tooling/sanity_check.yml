envVarsDeployDev: &envVarsDeployDev
dockerCloudDeployerCurrent: &dockerCloudDeployerCurrent
dockerCloudDeployerNext: &dockerCloudDeployerNext
executor-machine: &executor-machine

jobs:
    # Description :
    #    Use cypress to do UI sanity checks on dev instances
    #    This job can be trigged after a deployment, clone, migration or upgrade job
    ui_sanity_checks:
        parameters:
            SOURCE_PFID:
                type: string
                default: ""
        machine:
            image: *executor-machine
        resource_class: large
        steps:
            - attach_workspace:
                  at: ~/
            - restore_persisted_env_vars
            - run:
                  name: Copy docker-compose.override.yml.dist
                  command: cp .circleci/docker-compose.override.yml.dist docker-compose.override.yml
            - run:
                  name: Setup tests results folder and log folder
                  command: mkdir -p var/tests/phpspec var/tests/csfixer var/logs var/tests/screenshots ~/.cache/yarn ~/.composer ~/.cache/Cypress
            - run:
                  name: Modify the password for the sanity check
                  command: |
                      sed -i "s/Q7sKB5xP2ttc5KnqFPOF1BrOkTRSulmEj528BpJzbDcLbYSHU1/${PIM_ADMIN_PASSWORD}/g" tests/front/e2e/product/edit.js
            - run:
                  name: Change owner on project dir (docker needs uid 1000, circleci can be another uid)
                  command: |
                      sudo chown -R 1000:1000 ../project
                      sudo chown -R 1000:1000 ~/.composer
                      sudo chown -R 1000:1000 ~/.cache/yarn
                      sudo chown -R 1000:1000 ~/.cache/Cypress
            - run:
                  name: Build the latest Docker images
                  command: |
                      make php-image-dev
            - when:
                  condition:
                      not:
                          equal: [master, << pipeline.git.branch >>]
                  steps:
                      - run:
                            name: Update composer.json if same branch exists in CE
                            command: >
                                curl --output /dev/null --silent --head --fail
                                https://github.com/akeneo/pim-community-dev/tree/${CIRCLE_BRANCH} &&
                                docker-compose run --rm -u www-data:www-data php php
                                /usr/local/bin/composer require "akeneo/pim-community-dev:dev-${CIRCLE_BRANCH}" --no-update ||
                                echo "No CE branch $CIRCLE_BRANCH found. I don't touch the composer.json file."
            - run:
                  name: Install back dependencies
                  command: make dependencies
            - run:
                  name: Launch Cypress
                  command: |
                      PIM_CONTEXT=test CYPRESS_defaultCommandTimeout=10000 CYPRESS_requestTimeout=10000 CYPRESS_responseTimeout=50000 CYPRESS_baseUrl=https://${INSTANCE_NAME}.dev.cloud.akeneo.com make end-to-end-front
            - store_artifacts:
                  path: cypress/screenshots
            - store_artifacts:
                  path: cypress/videos
            - store_artifacts:
                  path: var/logs

    validate_data_integrity:
        parameters:
          SOURCE_PFID_SOURCE_PROJECT_ID:
            type: string
            default: ""
          PRODUCT_TYPE:
            type: string
            default: "srnt"
        environment:
          <<: *envVarsDeployDev
        <<: *dockerCloudDeployerCurrent
        resource_class: small
        steps:
          - attach_workspace:
              at: ~/
          - set_gcloud_config_dev
          - restore_persisted_env_vars
          - run:
              name: Launch data referential integrity validation command
              command: |
                POD_DAEMON=$(kubectl get pods --no-headers --namespace=${TYPE}-${INSTANCE_NAME} -l component=pim-daemon-webhook-consumer-process | awk 'NR==1{print $1}')
                kubectl exec -it -n ${TYPE}-${INSTANCE_NAME} ${POD_DAEMON} -- /bin/bash -c 'bin/console  pimee:database:batch-validate -vvv '

    validate_db_schema:
      parameters:
        SOURCE_PFID_SOURCE_PROJECT_ID:
          type: string
          default: ""
        PRODUCT_TYPE:
          type: string
          default: "srnt"
      environment:
        <<: *envVarsDeployDev
      <<: *dockerCloudDeployerCurrent
      resource_class: small
      steps:
        - attach_workspace:
            at: ~/
        - set_gcloud_config_dev
        - restore_persisted_env_vars
        - run:
            name: Launch data referential integrity validation command
            command: |
              POD_DAEMON=$(kubectl get pods --no-headers --namespace=${TYPE}-${INSTANCE_NAME} -l component=pim-daemon-webhook-consumer-process | awk 'NR==1{print $1}')
              kubectl exec -it -n ${TYPE}-${INSTANCE_NAME} ${POD_DAEMON} -- /bin/bash -c 'bin/console pimee:database:inspect -f && bin/console pimee:database:diff'

    validate_indexing_diff:
      parameters:
        SOURCE_PFID_SOURCE_PROJECT_ID:
          type: string
          default: ""
        PRODUCT_TYPE:
          type: string
          default: "srnt"
      environment:
        <<: *envVarsDeployDev
      <<: *dockerCloudDeployerCurrent
      resource_class: small
      steps:
        - attach_workspace:
            at: ~/
        - set_gcloud_config_dev
        - restore_persisted_env_vars
        - run:
            name: Launch data referential integrity validation command
            command: |
              POD_DAEMON=$(kubectl get pods --no-headers --namespace=${TYPE}-${INSTANCE_NAME} -l component=pim-daemon-webhook-consumer-process | awk 'NR==1{print $1}')
              kubectl exec -it -n ${TYPE}-${INSTANCE_NAME} ${POD_DAEMON} -- /bin/bash -c 'bin/console pimee:database:indexing-diff'
