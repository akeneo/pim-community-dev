String tag = "eu.gcr.io/akeneo-ci/pim-community-dev:${env.BRANCH_NAME}"
String composer_command = "update"

pipeline {

    options {
        timeout(time: 4, unit: 'HOURS')
        timestamps()
    }

    agent none

    stages {
        stage("Build") {
            agent {
                kubernetes {
                    label 'pim-community-build'
                    yaml """
                        apiVersion: v1
                        kind: Pod
                        spec:
                            containers:
                                -
                                    name: docker
                                    image: paulwoelfel/docker-gcloud:latest
                                    resources: { requests: { memory: "200Mi", cpu: "100m" } }
                                    command: ["cat"]
                                    tty: true
                    """
                }
            }

            when {
                expression {
                    skip = sh (script: "git log -1 | grep '.*\\[skip-build\\].*'", returnStatus: true)
                    return skip != 0
                }
            }

            steps {
                container('docker') {
                    sh "cp .ci/Dockerfile Dockerfile"
                    sh "gcloud builds submit . --config .ci/builder.yaml --substitutions _IMAGE_TAG=${tag},_COMPOSER_COMMAND=${composer_command}"
                }
            }
        }
    }
}
