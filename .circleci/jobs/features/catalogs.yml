executor-machine: &executor-machine 'ubuntu-2004:202111-02'

jobs:
    test_front_lint_catalogs:
        machine:
            image: *executor-machine
        steps:
            -   attach_workspace:
                    at: ~/
            -   run:
                    name: Create yarn cache folder
                    command: mkdir -p  ~/.cache/yarn
            -   run:
                    name: Change owner on project dir (docker needs uid 1000, circleci can be another uid)
                    command: sudo chown -R 1000:1000 ../project ~/.cache/yarn
            -   run:
                    name: Pull docker image for node
                    command: docker-compose pull node
            -   run:
                    name: Lint front
                    command: make catalogs-lint-front

    test_front_unit_catalogs:
        machine:
            image: *executor-machine
        steps:
            -   attach_workspace:
                    at: ~/
            -   run:
                    name: Create yarn cache folder
                    command: mkdir -p  ~/.cache/yarn
            -   run:
                    name: Change owner on project dir (docker needs uid 1000, circleci can be another uid)
                    command: sudo chown -R 1000:1000 ../project ~/.cache/yarn
            -   run:
                    name: Pull docker image for node
                    command: docker-compose pull node
            -   run:
                    name: Unit front
                    command: make catalogs-unit-front

    test_back_unit_catalogs:
        machine:
            image: *executor-machine
        steps:
            -   attach_workspace:
                    at: ~/
            -   run:
                    name: Change owner on project dir (docker needs uid 1000, circleci can be another uid)
                    command: sudo chown -R 1000:1000 ../project
            -   run:
                    name: Pull docker image for php
                    command: docker-compose pull php
            -   run:
                    name: Coupling back
                    command: make catalogs-coupling-back
            -   run:
                    name: Lint back
                    command: make catalogs-lint-back
            -   run:
                    name: Unit back
                    command: make catalogs-unit-back
            -   store_test_results:
                    path: var/tests/phpunit

    test_back_integration_catalogs:
        machine:
            image: *executor-machine
            docker_layer_caching: true
        steps:
            -   attach_workspace:
                    at: ~/
            -   run:
                    name: Copy docker-compose.override.yml.dist
                    command: cp .circleci/docker-compose.override.yml.dist docker-compose.override.yml
            -   run:
                    name: Change owner on project dir (docker needs uid 1000, circleci can be another uid)
                    command: sudo chown -R 1000:1000 ../project
            -   run:
                    name: Pull docker images
                    command: docker-compose pull php fpm mysql elasticsearch object-storage pubsub-emulator
            -   run:
                    name: Start containers
                    command: |
                        APP_ENV=test C='fpm mysql elasticsearch object-storage pubsub-emulator' make up
                        docker/wait_docker_up.sh
            -   run:
                    name: Install database
                    command: APP_ENV=test O="--withoutFixtures" make database
            -   run:
                    name: Integration back
                    command: make catalogs-integration-back
            -   store_test_results:
                    path: var/tests/phpunit
