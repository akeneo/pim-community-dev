client-to-clone-grth: &client-to-clone-grth
client-to-clone-grth-ge2ee-nightly: &client-to-clone-grth-ge2ee-nightly

workflows:

    ge2ee_bulk_deploy_last:
        when:
            not:
                equal: [ scheduled_pipeline, << pipeline.trigger_source >> ]
        jobs:
            - ready_to_build?:
                  type: approval
                  filters:
                      branches:
                          only:
                              - /BH-.*/
                              - /SDO-.*/
            - checkout:
                requires:
                    - ready_to_build?
            - build_env_vars:
                PRODUCT_TYPE: grth
                requires:
                    - checkout
            - ge2ee_bulk_deploy_last_release:
                  name: "[<< matrix.PRODUCT_TYPE >>] [<< matrix.GE2EE_ID >>] Bulk Deploy last ge2ee"
                  matrix:
                      parameters:
                          PRODUCT_TYPE: ["grth"]
                          #GE2EE_ID: ["01","02","03","04","05","06","07","08","09"]
                          GE2EE_ID: ["01","02","03"]
                  requires:
                    - build_env_vars

    on_demand_ge2ee_jenkins_mig:
        when:
            and:
                - equal: [ true, << pipeline.parameters.trigger_jenkins_ge2ee_mig >> ]
                - not:
                    equal: [ "", << pipeline.parameters.instance >> ]
        jobs:
            - checkout
            - jenkins_ge2ee_migration:
                name: "Migrate Ge to EE via Jenkins"
                INSTANCE: << pipeline.parameters.instance >>
                GE2EE_SCRIPT_RELEASE: << pipeline.parameters.ge2ee_script_release >>
                PRODUCT_TYPE: grth
                requires:
                    - checkout

    ge2ee_deploy_and_migrate:
        when:
            not:
                equal: [ scheduled_pipeline, << pipeline.trigger_source >> ]
        jobs:
            - ready_to_build?:
                  type: approval
                  filters:
                      branches:
                          only:
                              - /BH-.*/
                              - /SDO-.*/
                              - /.*GE2EE.*/
            - checkout:
                requires:
                    - ready_to_build?
            - ge2ee_bulk_deploy_last_release:
                name: "[grth] Deploy last release"
                PRODUCT_TYPE: "grth"
                GE2EE_ID: "01"
                requires:
                    - checkout
            - ge2ee_mig-build_srnt_prod:
                  name: "[srnt] Build release with scripts"
                  requires:
                      - checkout
            - jenkins_ge2ee_migration:
                name: "Migrate Ge to EE via Jenkins"
                PRODUCT_TYPE: grth
                requires:
                    - "[grth] Deploy last release"
                    - "[srnt] Build release with scripts"


    ge2ee_clone_and_migrate:
        when:
            not:
                equal: [ scheduled_pipeline, << pipeline.trigger_source >> ]
        jobs:
            - ready_to_build?:
                  type: approval
                  filters:
                      branches:
                          only:
                              - /BH-.*/
                              - /SDO-.*/
                              - /.*GE2EE.*/
            - checkout:
                requires:
                    - ready_to_build?
            - build_env_vars:
                name: "[<< matrix.PRODUCT_TYPE >>] build_env_vars"
                matrix:
                    parameters:
                        PRODUCT_TYPE: ["grth"]
                requires:
                    - checkout
            - test_clone_from_customer_db:
                name: "[<< matrix.PRODUCT_TYPE >>] deploy_clone_from-<< matrix.SOURCE_PFID >>"
                matrix:
                    parameters:
                        PRODUCT_TYPE: ["grth"]
                        SOURCE_PFID: *client-to-clone-grth
                requires:
                    - "[<< matrix.PRODUCT_TYPE >>] build_env_vars"
            - ge2ee_mig-build_srnt_prod:
                  name: "[srnt] Build with EDITION_FLAG"
                  requires:
                      - checkout
            - jenkins_ge2ee_migration:
                name: "GE2EE Migration for Cloned: << matrix.SOURCE_PFID >>"
                matrix:
                    parameters:
                        PRODUCT_TYPE: ["grth"]
                        SOURCE_PFID: *client-to-clone-grth
                requires:
                    - "[<< matrix.PRODUCT_TYPE >>] deploy_clone_from-<< matrix.SOURCE_PFID >>"
                    - "[srnt] Build with EDITION_FLAG"

    nightly_ge2ee_clone_and_migrate:
        when:
            and:
                - equal: [ scheduled_pipeline, << pipeline.trigger_source >> ]
                - equal: [ "nightly_ge2ee_clone_and_migrate", << pipeline.schedule.name >> ]
        jobs:
            - checkout
            - build_env_vars:
                name: "[<< matrix.PRODUCT_TYPE >>] build_env_vars"
                matrix:
                    parameters:
                        PRODUCT_TYPE: ["grth"]
                requires:
                    - checkout
            - test_clone_from_customer_db:
                name: "[<< matrix.PRODUCT_TYPE >>] deploy_clone_from-<< matrix.SOURCE_PFID >>"
                matrix:
                    parameters:
                        PRODUCT_TYPE: ["grth"]
                        SOURCE_PFID: *client-to-clone-grth-ge2ee-nightly
                requires:
                    - "[<< matrix.PRODUCT_TYPE >>] build_env_vars"
            - ge2ee_mig-build_srnt_prod:
                  name: "[srnt] Build with EDITION_FLAG"
                  requires:
                      - checkout
            - jenkins_ge2ee_migration:
                name: "GE2EE Migration for Cloned: << matrix.SOURCE_PFID >>"
                matrix:
                    parameters:
                        PRODUCT_TYPE: ["grth"]
                        SOURCE_PFID: *client-to-clone-grth-ge2ee-nightly
                requires:
                    - "[<< matrix.PRODUCT_TYPE >>] deploy_clone_from-<< matrix.SOURCE_PFID >>"
                    - "[srnt] Build with EDITION_FLAG"