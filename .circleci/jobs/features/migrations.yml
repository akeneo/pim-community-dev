executor-machine: &executor-machine 'ubuntu-2004:2022.04.1'

jobs:
  test_ce_migrations:
    machine:
      image: *executor-machine
      docker_layer_caching: true
    steps:
      - when:
          condition: << pipeline.parameters.run-database-migration-tests >>
          steps:
            - attach_workspace:
                at: ~/
            - run:
                name: Change owner on project dir (docker needs uid 1000, circleci can be another uid)
                command: sudo chown -R 1000:1000 ../project
            - run:
                name: Pull docker images
                command: docker-compose pull php fpm mysql elasticsearch object-storage pubsub-emulator
            - run:
                name: Start containers
                command: |
                  APP_ENV=test C='fpm mysql elasticsearch object-storage pubsub-emulator' make up
                  docker/wait_docker_up.sh
            - run:
                name: Install database
                command: APP_ENV=test O="--withoutFixtures" make database
            - run:
                name: Migrations tests
                command: make migration-back
