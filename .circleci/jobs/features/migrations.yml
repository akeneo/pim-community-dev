executor-machine: &executor-machine 'ubuntu-2004:2022.04.1'

jobs:
  test_ce_migrations:
    machine:
      image: *executor-machine
    steps:
      - when:
          condition: << pipeline.parameters.run-database-migration-tests >>
          steps:
            - attach_workspace:
                at: ~/
            - run:
                name: Change owner on project dir in order to archive the project into the workspace
                command: sudo chown -R 1000:1000 ../project
            - run:
                name: Start containers
                command: |
                  APP_ENV=test C='fpm mysql elasticsearch object-storage pubsub-emulator' make up
                  docker/wait_docker_up.sh
            - run:
                name: Install database
                command: APP_ENV=dev make database
            - run:
                name: Migrations tests
                command: make migration-back
