language: php

php:
    - 7.2

# Only build branches starting by "einrich-""
branches:
  only:
    - /^einrich-?.*$/

# Extra dependencies
services:
  - mysql

# For mysql 5.7 instead of 5.6
addons:
  apt:
    sources:
      - mysql-5.7-trusty
    packages:
      - mysql-server

sudo: false

# Speed up a bit the process
cache:
  directories:
    - $HOME/.composer/cache/files
    - $HOME/.cache/yarn
    - /tmp/jest

before_install:
    - export BRANCH=$(if [ "$TRAVIS_PULL_REQUEST" == "false" ]; then echo $TRAVIS_BRANCH; else echo $TRAVIS_PULL_REQUEST_BRANCH; fi)
    - node tests/travis/check-changes.js $BRANCH src/Akeneo/ReferenceEntity/,.travis.yml,tests/travis/,tests/front,package.json,composer.json
    - php tests/travis/check-fake-implementations.php
    - phpenv config-rm xdebug.ini
    - composer config -g github-oauth.github.com cb6d948ada430cba6f71257ce0a57026061df22c
    - phpenv config-add tests/travis/travis.php.ini
    - echo -e "Host github.com\n\tStrictHostKeyChecking no\n" >> ~/.ssh/config

install:
    - composer install --prefer-dist --no-interaction
    - cp tests/travis/parameters_test.yml app/config/parameters_test.yml
    - ./bin/console pim:install:assets --env=behat
    - ./bin/console pim:install:db --withoutIndexes --withoutFixtures --env=behat
    - yarn install
    - yarn webpack-test --env=prod

script:
    - yarn unit
    - yarn integration
    - yarn acceptance src/Akeneo/ReferenceEntity/tests/features
    - yarn lint
    - vendor/bin/php-coupling-detector detect --config-file=src/Akeneo/ReferenceEntity/tests/back/.php_cd.php src/Akeneo/ReferenceEntity/back
    - vendor/bin/phpstan analyse --configuration src/Akeneo/ReferenceEntity/tests/back/phpstan.neon.dist
    - vendor/bin/behat --config src/Akeneo/ReferenceEntity/tests/back/behat.yml.dist --no-interaction
    - vendor/bin/phpunit -c src/Akeneo/ReferenceEntity/tests/back
    - vendor/bin/php-cs-fixer fix --diff --dry-run --config=.php_cs.php
    - vendor/bin/phpspec run -c src/Akeneo/ReferenceEntity/tests/back/phpspec.yml.dist --no-interaction

notifications:
  email: false
