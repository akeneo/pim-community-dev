

{{ $tplCtx := . -}}
{{ range $jobName, $jobOptions := .Values.pim.jobs -}}
apiVersion: cloudscheduler.gcp.jet.crossplane.io/v1alpha1
kind: Job
metadata:
  name: "ucs-pim-job-{{ $jobName }}"
spec:
  providerConfigRef:
    name: "provider-config-jet-gcp"
  forProvider:
    description: "job for {{ $jobName }}"
    name: "ucs-pim-job-{{ $jobName }}"
    region: {{ $tplCtx.Values.region }}
    timeZone: "Europe/Paris"
    schedule: '{{ $jobOptions.schedule }}'
    httpTarget:
      - httpMethod: "POST"
        uri: "https://{{ $tplCtx.Values.region }}-{{ $tplCtx.Values.projectId }}.cloudfunctions.net/{{ $tplCtx.Values.cloudFunction.name }}"
        oidcToken:
          - audience: "https://{{ $tplCtx.Values.region }}-{{ $tplCtx.Values.projectId }}.cloudfunctions.net/{{ $tplCtx.Values.cloudFunction.name }}"
            serviceAccountEmail: "{{ $tplCtx.Values.cloudFunction.serviceAccountEmail }}"
        headers: {"Content-Type": "application/json"}
        body: {{ printf "{ 'topicId': '%s','code': '%s','options': '%s' }" $tplCtx.Values.pim.pubsub.ucs_topic_job_schudeler $jobName $jobOptions.pimCommand   | b64enc }}
---
{{ end }}