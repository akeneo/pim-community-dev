parameters:
    pimee_workflow.datagrid.event_listener.inject_entity_with_values_for_product_draft.class: Akeneo\Pim\WorkOrganization\Workflow\Bundle\Datagrid\EventListener\InjectEntityWithValuesForProductDraftSubscriber
    pimee_workflow.event_listener.configure_proposal_grid_listener.class: Akeneo\Pim\WorkOrganization\Workflow\Bundle\Datagrid\EventListener\ConfigureProposalGridListener
    pimee_workflow.datagrid.configuration.product_draft.grid_helper.class: Akeneo\Pim\WorkOrganization\Workflow\Bundle\Datagrid\Configuration\ProductDraft\GridHelper
    pimee_workflow.datasource.result_record.hydrator.product_draft.class: Akeneo\Pim\WorkOrganization\Workflow\Bundle\Datagrid\Datasource\ResultRecord\ProductDraftHydrator
    pimee_workflow.datagrid.mass_action.handler.mass_approve.class: Akeneo\Pim\WorkOrganization\Workflow\Bundle\Datagrid\MassAction\Handler\MassApproveActionHandler
    pimee_workflow.datagrid.datasource.product_proposal.class: Akeneo\Pim\WorkOrganization\Workflow\Bundle\Datagrid\Datasource\ProductProposalDatasource
    pimee_workflow.datagrid.datasource.product_draft.class: Oro\Bundle\PimDataGridBundle\Datasource\Datasource
    pimee_workflow.datagrid.event_listener.configure_proposal_grid_listener.class: Akeneo\Pim\WorkOrganization\Workflow\Bundle\Datagrid\EventListener\ConfigureProposalGridListener
    pimee_workflow.datagrid.configuration.proposal.context_configurator.class: Akeneo\Pim\WorkOrganization\Workflow\Bundle\Datagrid\Configuration\Proposal\ContextConfigurator
    pimee_workflow.datagrid.product_draft_utility.class: Akeneo\Pim\WorkOrganization\Workflow\Bundle\Datagrid\Filter\ProductDraftFilterUtility
    pimee_workflow.datagrid.product_draft_attribute_choice_filter.class: Akeneo\Pim\WorkOrganization\Workflow\Bundle\Datagrid\Filter\AttributeChoiceFilter
    pimee_workflow.datagrid.product_draft_choice_filter.class: Akeneo\Pim\WorkOrganization\Workflow\Bundle\Datagrid\Filter\ChoiceFilter
    pimee_workflow.datagrid.product_draft_author_filter.class: Akeneo\Pim\WorkOrganization\Workflow\Bundle\Datagrid\Filter\AuthorFilter
    pimee_workflow.datagrid.product_draft_date_filter.class: Oro\Bundle\PimFilterBundle\Filter\ProductValue\DateTimeRangeFilter
    pimee_workflow.datagrid.configuration.published_product.grid_helper.class: Akeneo\Pim\WorkOrganization\Workflow\Bundle\Datagrid\Configuration\PublishedProduct\GridHelper
    pimee_workflow.datagrid.datasource.result_record.hydrator.published_product_history.class: Akeneo\Pim\WorkOrganization\Workflow\Bundle\Datagrid\Datasource\ResultRecord\PublishedProductHistoryHydrator

services:
    # Listener
    pimee_workflow.datagrid.event_listener.configure_proposal_grid_listener:
        class: '%pimee_workflow.datagrid.event_listener.configure_proposal_grid_listener.class%'
        arguments:
            - '@pimee_workflow.datagrid.configuration.proposal.context_configurator'
            - '@pim_datagrid.datagrid.configuration.product.filters_configurator.ce'
        tags:
            - { name: kernel.event_listener, event: oro_datagrid.datgrid.build.before.proposal-grid, method: buildBefore }

    pimee_workflow.event_listener.proposal_grid_before_listener:
        class: '%pimee_workflow.event_listener.configure_proposal_grid_listener.class%'
        arguments:
            - '@pimee_workflow.datagrid.configuration.proposal.context_configurator'
            - '@pimee_workflow.datagrid.configuration.product.filters_configurator'
        tags:
            - { name: kernel.event_listener, event: oro_datagrid.datgrid.build.before.proposal-grid, method: buildBefore }

    pimee_workflow.event_listener.product_drafts_grid_listener:
        class: '%pim_datagrid.event_listener.add_parameters_to_grid.class%'
        arguments:
          - [ entityWithValues ]
          - '@oro_datagrid.datagrid.request_params'
        tags:
          - { name: kernel.event_listener, event: oro_datagrid.datgrid.build.after.product-draft-grid, method: onBuildAfter }

    pimee_workflow.datagrid.event_listener.inject_entity_with_values_for_product_draft:
        class: '%pimee_workflow.datagrid.event_listener.inject_entity_with_values_for_product_draft.class%'
        arguments:
            - '@oro_datagrid.datagrid.request_params'
        tags:
            - { name: kernel.event_listener, event: oro_datagrid.datgrid.build.before.product-draft-grid, method: buildBefore }

    pim_enrich.event_listener.product_grid_before_listener:
        class: '%pim_datagrid.event_listener.configure_product_grid_listener.class%'
        arguments:
            - '@pim_datagrid.datagrid.configuration.product.context_configurator'
            - '@pim_datagrid.datagrid.configuration.product.columns_configurator'
            - '@pim_datagrid.datagrid.configuration.product.filters_configurator'
            - '@pim_datagrid.datagrid.configuration.product.sorters_configurator'
            - '@pim_datagrid.datagrid.configuration.product.selected_attributes_configurator'
            - '@pimee_security.datagrid.configuration.product.row_actions_configurator'
        tags:
            - { name: kernel.event_listener, event: oro_datagrid.datgrid.build.before.product-grid, method: buildBefore }

    pim_enrich.event_listener.published_product_grid_before_listener:
        class: '%pim_datagrid.event_listener.configure_product_grid_listener.class%'
        arguments:
            - '@pim_datagrid.datagrid.configuration.product.context_configurator'
            - '@pim_datagrid.datagrid.configuration.product.columns_configurator'
            - '@pim_datagrid.datagrid.configuration.product.filters_configurator'
            - '@pim_datagrid.datagrid.configuration.product.sorters_configurator'
            - '@pim_datagrid.datagrid.configuration.product.all_attributes_useable_in_grid_configurator'
        tags:
            - { name: kernel.event_listener, event: oro_datagrid.datgrid.build.before.published-product-grid, method: buildBefore }

    pim_enrich.event_listener.published_product_grid_after_listener:
        class: '%pim_datagrid.event_listener.add_parameters_to_product_grid.class%'
        arguments:
          - [dataLocale]
          - '@oro_datagrid.datagrid.request_params'
          - '@pim_catalog.context.catalog'
          - '@pim_user.context.user'
          - false
          - '@request_stack'
        tags:
          - { name: kernel.event_listener, event: oro_datagrid.datgrid.build.after.published-product-grid, method: onBuildAfter }

    pimee_workflow.event_listener.proposal_grid_after_listener:
        class: '%pim_datagrid.event_listener.add_parameters_to_product_grid.class%'
        arguments:
          - [dataLocale]
          - '@oro_datagrid.datagrid.request_params'
          - '@pim_catalog.context.catalog'
          - '@pim_user.context.user'
          - false
          - '@request_stack'
        tags:
          - { name: kernel.event_listener, event: oro_datagrid.datgrid.build.after.proposal-grid, method: onBuildAfter }

    pim_datagrid.event_listener.configure_published_product_filters:
        class: '%pim_datagrid.event_listener.configure_product_filters.class%'
        arguments:
            - '@pim_user.context.user'
        tags:
            - { name: kernel.event_listener, event: oro_datagrid.datgrid.build.after.published-product-grid, method: onBuildAfter }

    # Configuration
    pimee_workflow.datagrid.configuration.product_draft.grid_helper:
        class: '%pimee_workflow.datagrid.configuration.product_draft.grid_helper.class%'
        public: true
        arguments:
            - '@security.authorization_checker'
            - '@pimee_workflow.helper.product_draft_changes_permission'

    pimee_workflow.datagrid.configuration.proposal.context_configurator:
        class: '%pimee_workflow.datagrid.configuration.proposal.context_configurator.class%'
        arguments:
            - '@oro_datagrid.datagrid.request_params'
            - '@pim_user.context.user'
            - '@request_stack'
            - '@pim_catalog.repository.attribute'

    pimee_workflow.datagrid.configuration.published_product.grid_helper:
        class: '%pimee_workflow.datagrid.configuration.published_product.grid_helper.class%'
        public: true
        arguments:
            - '@security.authorization_checker'
            - '@pimee_workflow.repository.published_product'

    # Datasource
    pimee_catalog.datasource.product_draft:
        class: '%pimee_workflow.datagrid.datasource.product_draft.class%'
        arguments:
            - '@pim_catalog.object_manager.product'
            - '@pimee_workflow.datagrid.datasource.result_record.hydrator.product_draft'
        tags:
            - { name: oro_datagrid.datasource, type: pimee_datasource_product_draft }

    pimee_workflow.datagrid.datasource.result_record.hydrator.product_draft:
        class: '%pimee_workflow.datasource.result_record.hydrator.product_draft.class%'
        arguments:
          - '@pim_datagrid.datagrid.request.parameters_extractor'
          - '@pimee_workflow.normalizer.proposal_product'

    pim_datagrid.datasource.result_record.hydrator.product_model_draft:
        class: '%pimee_workflow.datasource.result_record.hydrator.product_draft.class%'
        arguments:
          - '@pim_datagrid.datagrid.request.parameters_extractor'
          - '@pimee_workflow.normalizer.proposal_product_model'

    pimee_workflow.datagrid.datasource.result_record.hydrator.published_product_history:
        class: '%pimee_workflow.datagrid.datasource.result_record.hydrator.published_product_history.class%'
        arguments:
            - '@pimee_workflow.repository.published_product'

    pimee_workflow.datagrid.datasource.published_product:
        class: '%pim_datagrid.datasource.product.class%'
        arguments:
            - '@pim_catalog.object_manager.product'
            - '@pimee_workflow.doctrine.query.published_product_query_builder_from_size_factory'
            - '@pimee_workflow.normalizer.datagrid.published_product'
            - '@pim_datagrid.event_subscriber.filter_entity_with_values_subscriber'
        calls:
            - [ setMassActionRepository, ['@pimee_workflow.repository.published_product_mass_action' ]]
        tags:
            - { name: oro_datagrid.datasource, type: pimee_datasource_published_product }

    pimee_catalog.datasource.product_model_draft:
        class: '%pimee_workflow.datagrid.datasource.product_draft.class%'
        arguments:
            - '@doctrine.orm.entity_manager'
            - '@pim_datagrid.datasource.result_record.hydrator.product_model_draft'
        tags:
            - { name: oro_datagrid.datasource, type: pimee_datasource_product_model_draft }

    # Mass actions
    pimee_workflow.datagrid.mass_action.handler.mass_approve:
        class: '%pimee_workflow.datagrid.mass_action.handler.mass_approve.class%'
        arguments:
            - '@event_dispatcher'
            - '@pimee_workflow.factory.product_and_product_model_proposal_cursor'
        tags:
            - { name: pim_datagrid.extension.mass_action.handler, alias: mass_approve }

    pimee_workflow.datagrid.datasource.proposal_product:
        class: '%pimee_workflow.datagrid.datasource.product_proposal.class%'
        arguments:
            - '@pimee_workflow.doctrine.query.proposal_product_and_product_model_query_builder_from_size_factory_with_permissions'
            - '@pim_datagrid_serializer'
        calls:
            - [ setMassActionRepository, ['@pimee_workflow.repository.product_draft' ]]
        tags:
            - { name: oro_datagrid.datasource, type: pimee_datasource_proposal_product }

    pimee_workflow.datagrid.extension.mass_action.type.mass_approve:
        public: true
        class: '%oro_datagrid.extension.mass_action.type.redirect.class%'
        shared: false
        tags:
            - { name: oro_datagrid.extension.mass_action.type, type: mass-approve-proposal }

    pimee_workflow.datagrid.extension.mass_action.type.mass_refuse:
        public: true
        class: '%oro_datagrid.extension.mass_action.type.redirect.class%'
        shared: false
        tags:
            - { name: oro_datagrid.extension.mass_action.type, type: mass-refuse-proposal }

    pim_datagrid.extension.mass_action.handler.mass_refuse:
        class: 'Akeneo\Pim\WorkOrganization\Workflow\Bundle\Datagrid\MassAction\Handler\MassRefuseActionHandler'
        arguments:
            - '@event_dispatcher'
            - '@pimee_workflow.factory.product_and_product_model_proposal_cursor'
        tags:
            - { name: pim_datagrid.extension.mass_action.handler, alias: mass_refuse }

    # Action
    pimee_workflow.datagrid.extension.action.type.approve_proposal:
        public: true
        class: '%oro_datagrid.extension.action.type.ajax.class%'
        shared: false
        tags:
            - { name: oro_datagrid.extension.action.type, type: approve-proposal }

    pimee_workflow.datagrid.extension.action.type.reject_proposal:
        public: true
        class: '%oro_datagrid.extension.action.type.ajax.class%'
        shared: false
        tags:
            - { name: oro_datagrid.extension.action.type, type: refuse-proposal }

    pimee_workflow.datagrid.extension.action.type.remove_proposal:
        public: true
        class: '%oro_datagrid.extension.action.type.ajax.class%'
        shared: false
        tags:
            - { name: oro_datagrid.extension.action.type, type: remove-proposal }

    # Utility
    pimee_workflow.datagrid.product_draft_utility:
        class: '%pimee_workflow.datagrid.product_draft_utility.class%'
        arguments:
            - '@pimee_workflow.repository.product_draft'

    # Filters
    pimee_workflow.datagrid.product_draft_choice_filter:
        class: '%pimee_workflow.datagrid.product_draft_choice_filter.class%'
        arguments:
            - '@form.factory'
            - '@pimee_workflow.datagrid.product_draft_utility'
        tags:
            - { name: oro_filter.extension.orm_filter.filter, type: product_draft_choice }

    pimee_workflow.datagrid.product_draft_author_filter:
        class: '%pimee_workflow.datagrid.product_draft_author_filter.class%'
        arguments:
            - '@form.factory'
            - '@pimee_workflow.datagrid.product_draft_utility'
            - '@pimee_workflow.query.elasticsearch.filter.author'
        tags:
            - { name: oro_filter.extension.orm_filter.filter, type: product_draft_author }

    pimee_workflow.datagrid.product_draft_source_filter:
        class: Akeneo\Pim\WorkOrganization\Workflow\Bundle\Datagrid\Filter\ChoiceFilter
        arguments:
            - '@form.factory'
            - '@pimee_workflow.datagrid.product_draft_utility'
            - '@pimee_workflow.query.elasticsearch.filter.draft_source'
        tags:
            - { name: oro_filter.extension.orm_filter.filter, type: product_draft_source}

    pimee_workflow.datagrid.product_draft_attribute_choice_filter:
        class: '%pimee_workflow.datagrid.product_draft_attribute_choice_filter.class%'
        parent: pimee_workflow.datagrid.product_draft_choice_filter
        tags:
            - { name: oro_filter.extension.orm_filter.filter, type: product_draft_attribute_choice }

    pimee_workflow.datagrid.product_draft_date_filter:
        class: '%pimee_workflow.datagrid.product_draft_date_filter.class%'
        arguments:
            - '@form.factory'
            - '@pimee_workflow.datagrid.product_draft_utility'
            - '@pim_user.context.user'
        tags:
            - { name: oro_filter.extension.orm_filter.filter, type: product_draft_date }

    pimee_workflow.datagrid.filter.published_product_category:
        parent: pim_filter.product_category_filter
        tags:
            - { name: oro_filter.extension.orm_filter.filter, type: published_product_category }

    pimee_workflow.datagrid.oro_to_pim_grid_filter:
        class: 'Akeneo\Pim\WorkOrganization\Workflow\Bundle\Datagrid\OroToPimGridFilterAdapter'
        arguments:
            - '@pim_datagrid.extension.mass_action.dispatcher'

    # Controller
    pimee_workflow.datagrid.controller.published_product_export:
        class: '%pim_datagrid.controller.product_export.class%'
        public: true
        arguments:
            - '@request_stack'
            - '@pim_datagrid.extension.mass_action.dispatcher'
            - '@pimee_workflow.datagrid.oro_to_pim_grid_filter'
            - '@akeneo_batch.job.job_instance_repository'
            - '@security.token_storage'
            - '@akeneo_batch_queue.launcher.queue_job_launcher'
            - '@oro_datagrid.datagrid.manager'
            - '@oro_datagrid.mass_action.parameters_parser'

    pimee_workflow.datagrid.product.event_listener.add_draft_status_filter:
        class: 'Akeneo\Pim\WorkOrganization\Workflow\Bundle\Datagrid\Configuration\Product\AddDraftStatusFilterToProductGridListener'
        tags:
            - { name: kernel.event_listener, event: oro_datagrid.datgrid.build.before.product-grid, method: buildBefore }

    pimee_workflow.datagrid.product.filter.draft_status:
        class: Akeneo\Pim\WorkOrganization\Workflow\Bundle\Datagrid\Filter\DraftStatusFilter
        arguments:
            - '@form.factory'
            - '@pim_filter.product_utility'
            - '@pimee_workflow.query.select_product_ids_by_user_and_draft_status'
            - '@pimee_workflow.query.select_product_model_ids_by_user_and_draft_status'
            - '@pim_user.context.user'
        tags:
            - { name: oro_filter.extension.orm_filter.filter, type: draft_status }

    pim_datagrid.adapter.published_product_items_counter:
        class: Akeneo\Pim\WorkOrganization\Workflow\Bundle\Datagrid\Counter\PublishedProductItemsCounter
        arguments:
            - '@pim_enrich.doctrine.query.count_impacted_products'
            - '@pimee_workflow.doctrine.query.published_product_query_builder_factory'
