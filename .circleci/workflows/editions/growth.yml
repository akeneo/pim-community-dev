orbs:
    slack: circleci/slack@3.4.2
    cypress: cypress-io/cypress@1

aliases:
    - &slack-fail-post-step-ge
        post-steps:
            - slack/status:
                  channel: ci
                  webhook: $SLACK_NIGHTLY_STATUS
                  fail_only: true

    - &slack-post-step-ge
        post-steps:
            - slack/status:
                  channel: ci
                  webhook: $SLACK_NIGHTLY_STATUS
                  fail_only: false

workflows:
    nightly_grth_release:
        when:
            and:
                - equal: [ scheduled_pipeline, << pipeline.trigger_source >> ]
                - equal: [ "nightly_grth_release", << pipeline.schedule.name >> ]
        jobs:
            - checkout
            - build_grth:
                  <<: *slack-fail-post-step-ge
                  requires:
                      - checkout
            - test_cronjobs_existence:
                  <<: *slack-fail-post-step-ge
                  matrix:
                      parameters:
                          PRODUCT_TYPE: ["grth"]
                  requires:
                      - build_grth
            - test_deploy:
                  <<: *slack-fail-post-step-ge
                  matrix:
                      parameters:
                          PRODUCT_TYPE: ["grth"]
                  requires:
                      - test_cronjobs_existence
            - test_deploy_last_release:
                  <<: *slack-fail-post-step-ge
                  matrix:
                      parameters:
                          PRODUCT_TYPE: ["grth"]
                  requires:
                      - test_cronjobs_existence
            - test_upgrade_from_last_release:
                  <<: *slack-fail-post-step-ge
                  matrix:
                      parameters:
                          PRODUCT_TYPE: ["grth"]
                  requires:
                      - test_deploy_last_release
            - release:
                  <<: *slack-post-step-ge
                  matrix:
                      parameters:
                          PRODUCT_TYPE: ["grth"]
                  requires:
                      - test_deploy
                      - test_upgrade_from_last_release
