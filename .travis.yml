language: php

branches:
  only:
    - /^einrich-?.*$/

php:
    - 7.1

sudo: false

cache:
  directories:
    - $HOME/.composer/cache/files
    - $HOME/.cache/yarn

before_install:
    - node tests/travis/check-changes.js einrich-PIM-7380 src/Akeneo/EnrichedEntity/,.travis.yml,tests/travis/,tests/back/Integration/EnrichedEntity,tests/back/Acceptance,tests/features,tests/front,package.json
    - phpenv config-rm xdebug.ini
    - composer config -g github-oauth.github.com b67ee2fd847a2ba0f2275cbaab068bf543cdf9a2
    - printf "\n" | pecl install apcu
    - phpenv config-add tests/travis/travis.php.ini
    - echo -e "Host github.com\n\tStrictHostKeyChecking no\n" >> ~/.ssh/config

install:
    - composer install --prefer-dist --no-interaction
    - ./bin/console pim:installer:dump-extensions --env=prod
    - ./bin/console pim:install:ass --env=prod
    - cp app/config/parameters_test.yml.dist app/config/parameters_test.yml
    - yarn install
    - yarn webpack-test --env=prod

script:
    - yarn unit
    - yarn integration
    - yarn acceptance tests/features
    - yarn acceptance vendor/akeneo/pim-community-dev/tests/features
    - vendor/bin/behat -p acceptance --no-interaction
    - vendor/bin/php-cs-fixer fix --diff --dry-run --config=.php_cs.php
    - vendor/bin/phpspec run --no-interaction

notifications:
  email: false
