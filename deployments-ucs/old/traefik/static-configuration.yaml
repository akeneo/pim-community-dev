providers:
  kubernetesCRD:
    allowCrossNamespace: true
    allowExternalNameServices: true

deployment:
  replicas: 1

podAnnotations:
  ad.datadoghq.com/${chart_release_name}.check_names: '["http_check", "http_check"]'
  ad.datadoghq.com/${chart_release_name}.init_configs: "[{},{}]"
  ad.datadoghq.com/${chart_release_name}.instances: |
    [
      [{
        "name": "traefik_tls_check",
        "url": "https://%%host%%:%%port_websecure%%",
        "timeout": "1",
        "tls_verify": "true",
        "check_hostname": "true",
        "ssl_server_name": "*.dev.akeneo.ch",
        "check_certificate_expiration": "true",
        "include_content": "true",
        "days_warning": 30,
        "days_critical": 7,
        "http_response_status_code": "(2|3|4)\\d\\d"
      }],
      [{
        "name": "traefik_http_redirect",
        "url": "http://*.dev.akeneo.ch",
        "timeout": "1",
        "tls_verify": "false",
        "check_hostname": "false",
        "include_content": "true",
        "http_response_status_code": "301",
        "allow_redirects": "false"
      }]
    ]
env:
  - name: TRAEFIK_METRICS_DATADOG_ADDRESS
    valueFrom:
      fieldRef:
        fieldPath: status.hostIP

metrics:
  datadog:
    address: $(TRAEFIK_METRICS_DATADOG_ADDRESS):8125

additionalArguments:
  - "--entrypoints.web.http.redirections.entryPoint.to=:443"
  - "--metrics.datadog.addrouterslabels=true"
  - "--providers.kubernetescrd"
  - "--providers.kubernetesingress"
  - "--tracing.jaeger=true"
  - "--tracing.jaeger.samplingParam=0"
  - "--tracing.jaeger.traceContextHeaderName=X-Datadog-Trace-Id"

ports:
  traefik:
    expose: true

service:
  spec:
    externalTrafficPolicy: Local

resources:
  requests:
    memory: 150Mi
    cpu: 0.2
  limits:
    memory: 150Mi

logs:
  general:
    level: ERROR
    format: json
  access:
    enabled: true


podDisruptionBudget:
  enabled: true
  minAvailable: "50%"

tls:
  enabled: true

tlsOptions:
  default:
    minVersion: VersionTLS12
    cipherSuites:
      # TLS 1.3 (Added by default)
      - TLS_CHACHA20_POLY1305_SHA256
      - TLS_AES_256_GCM_SHA384
      - TLS_AES_128_GCM_SHA256
      # TLS 1.2
      - TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
      - TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256
      - TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
      # TLS 1.2 (Weak)
      - TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA
      - TLS_RSA_WITH_AES_256_CBC_SHA
      - TLS_RSA_WITH_AES_256_GCM_SHA384
      - TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA
      - TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256
      - TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256
      - TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA
      - TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384
      - TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305
      - TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256
      - TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA
      - TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256
      - TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305
      - TLS_RSA_WITH_AES_128_CBC_SHA
      - TLS_RSA_WITH_AES_128_CBC_SHA256
      - TLS_RSA_WITH_AES_128_GCM_SHA256

affinity:
  podAntiAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
      - labelSelector:
          matchExpressions:
            - key: app.kubernetes.io/instance
              operator: In
              values:
                - traefik-v2
        topologyKey: kubernetes.io/hostname
