language: php

php:
    - 7.3

# Only build branches starting by einrich- or assets- or AST- or ATR-
branches:
    only:
        - /^(einrich|assets|AST|ATR)-?.*$/

# Extra dependencies
services:
    - docker

sudo: false

# Speed up a bit the process
cache:
    directories:
        - $HOME/.composer/cache/files
        - $HOME/.cache/yarn
        - /tmp/jest
        - docker_images

before_install:
    # Needed to install newer version of Docker (https://docs.travis-ci.com/user/docker/#installing-a-newer-docker-version)
    - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
    - sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
    - sudo apt-get update
    - sudo apt-get -y -o Dpkg::Options::="--force-confnew" install docker-ce

    # Known issue with Docker Registry Mirrors (https://github.com/moby/buildkit/issues/606)
    - echo "{}" | sudo tee /etc/docker/daemon.json
    - sudo service docker restart

    # Based on CircleCI config
    - docker load -i docker_images/images.tar || true
    - make php-image-dev
    - mkdir -p var/tests/phpspec var/tests/csfixer var/logs var/tests/screenshots ~/.cache/yarn ~/.composer
    - sudo chown -R 1000:1000 ../pim-enterprise-dev
    - sudo chown -R 1000:1000 ~/.composer
    - sudo chown -R 1000:1000 ~/.cache/yarn

install:
    - curl --output /dev/null --silent --head --fail https://github.com/akeneo/pim-community-dev/tree/${TRAVIS_BRANCH} && docker-compose run --rm -u www-data:www-data php php /usr/local/bin/composer require "akeneo/pim-community-dev:dev-${TRAVIS_BRANCH}" --no-update || echo "No CE branch $TRAVIS_BRANCH found. I don't touch the composer.json file."
    - make dependencies
    - C='mysql elasticsearch' make up
    - docker/wait_docker_up.sh
    - make check-requirements
    - make assets
    - make javascript-test
    - make javascript-dev
    - sudo chown -R 1000:1000 ../pim-enterprise-dev
    - sudo chmod 777 -R ../pim-enterprise-dev

jobs:
    include:
        - stage: Reference Entities Tests
          if: branch =~ /^einrich-?.*$/
          script:
              - make unit-front
              - make reference-entity-acceptance-front
              - make integration-front
              - make reference-entity-coupling-back
              - make reference-entity-lint-back
              - make reference-entity-unit-back
              - make reference-entity-acceptance-back
              # Start docker services
              - APP_ENV=test C='fpm mysql elasticsearch object-storage' make up
              - docker/wait_docker_up.sh
              - APP_ENV=test make database
              # If CI is left to true, a circleci specific binary is loaded
              - CI=false make reference-entity-integration-back

        - stage: Asset Manager Tests
          if: branch =~ /^(assets|AST|ATR)-?.*$/
          script:
              - make unit-front
              - make asset-manager-acceptance-front
              - make integration-front
              - make asset-manager-coupling-back
              - make asset-manager-static-back
              - make asset-manager-lint-back
              - make asset-manager-unit-back
              - make asset-manager-acceptance-back
              # Start docker services
              - APP_ENV=test C='fpm mysql elasticsearch object-storage' make up
              - docker/wait_docker_up.sh
              - APP_ENV=test make database
              # If CI is left to true, a circleci specific binary is loaded
              - CI=false make asset-manager-integration-back

before_cache:
    - docker save -o docker_images/images.tar akeneo/pim-dev/php:7.3

notifications:
    email: false
