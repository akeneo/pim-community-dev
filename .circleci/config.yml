version: 2.1

orbs:
  slack: circleci/slack@3.4.2

aliases:
  - &envVarsDeployDev
      ENV_NAME: "dev"
      GOOGLE_PROJECT_ID: "akecld-saas-dev"
      GOOGLE_COMPUTE_ZONE: "europe-west3-a"
      CLUSTER_NAME: "europe-west3-a"

  - &dockerCloudDeployer
      docker:
        - image: eu.gcr.io/akeneo-cloud/cloud-deployer:7.7
          auth:
            username: _json_key  # default username when using a JSON key file to authenticate
            password: $GCLOUD_SERVICE_KEY_DEV  # JSON service account you created, do not encode to base64

  - &slack-fail-post-step
      post-steps:
        - slack/status:
            channel: ci
            webhook: $SLACK_NIGHTLY_STATUS
            fail_only: true

  - &slack-post-step
      post-steps:
        - slack/status:
            channel: ci
            webhook: $SLACK_NIGHTLY_STATUS
            fail_only: false


jobs:
  checkout_ee:
    machine:
      image: ubuntu-2004:202101-01
    steps:
      - add_ssh_keys:
          fingerprints:
              - "1f:25:f8:bb:59:52:95:f6:e2:f2:97:2f:30:d4:e9:66"
      - run:
          name: Download EE dev with the SSH key that we added above
          command: |
              export GIT_SSH_COMMAND='ssh -i ~/.ssh/id_rsa_1f25f8bb595295f6e2f2972f30d4e966 -o UserKnownHostsFile=~/.ssh/known_hosts -o IdentitiesOnly=Yes'
              git clone git@github.com:akeneo/pim-enterprise-dev.git /home/circleci/project
      - run:
          name: Checkout EE branch if it exists, or master otherwise
          command: |
            cd /home/circleci/project
            git checkout ${CIRCLE_BRANCH} || git checkout master
            echo "Current commit: $(git rev-parse --short HEAD)"
      - run:
          name: BIG COMMERCE CONNECTOR - Checkout BigCommerce Connector
          command: |
              mkdir -p tmp
              export GIT_SSH_COMMAND='ssh -i ~/.ssh/id_rsa_1f25f8bb595295f6e2f2972f30d4e966 -o UserKnownHostsFile=~/.ssh/known_hosts -o IdentitiesOnly=Yes'
              git clone --branch v0 git@github.com:akeneo/bigcommerce-connector.git tmp/build-connector
      - run:
          name: Require proper dev CE branch
          command: |
            sed -i "s#akeneo/pim-community-dev\": \"dev-master#akeneo/pim-community-dev\": \"dev-${CIRCLE_BRANCH}#" composer.json
            sed -i "s#akeneo/pim-community-dev\": \"dev-master#akeneo/pim-community-dev\": \"dev-${CIRCLE_BRANCH}#" grth/composer.json
      - install_yq
      - run:
          name: Remove MySQL port translation (see BH-664)
          command: yq delete --inplace docker-compose.yml services.mysql.ports
      - run:
          name: Persist default IMAGE_TAG to be the repo last commit SHA1
          command: |
            echo export IMAGE_TAG_SHORTED=$(echo $CIRCLE_SHA1 | cut -c -7) >> persisted_env_vars
            echo export IMAGE_TAG=$CIRCLE_SHA1 >> persisted_env_vars
      - persist_to_workspace:
          root: ~/
          paths:
            - project

  checkout_ce:
    machine:
      image: ubuntu-2004:202101-01
    steps:
      - checkout
      - install_yq
      - run:
          name: Remove MySQL port translation (see BH-664)
          command: yq delete --inplace docker-compose.yml services.mysql.ports
      - persist_to_workspace:
          root: ~/
          paths:
              - project

  build_dev:
    parameters:
        is_ee_built:
            type: boolean
            default: true
        path_to_front_packages:
            type: string
            default: front-packages
    machine:
      image: ubuntu-2004:202101-01
    steps:
      - attach_workspace:
            at: ~/
      - run:
          name: Copy docker-compose.override.yml.dist
          command: cp .circleci/docker-compose.override.yml.dist docker-compose.override.yml
      - when:
            condition: << parameters.is_ee_built >>

            steps:
              - run:
                  name: Creating hash key for PHP Docker image
                  command: |
                      find Dockerfile docker/ -type f -print0 | sort -z | xargs -0 sha1sum | sha1sum > ~/php-docker-image.hash
                      date +%F >> ~/php-docker-image.hash
              - restore_cache:
                  name: Restore PHP docker image cache
                  key: php-docker-image-{{ checksum "~/php-docker-image.hash" }}
              - run:
                  name: Build the latest EE Docker images
                  command: |
                      ls php-pim-image.tar && docker load -i php-pim-image.tar
                      ls php-pim-image.tar || make php-image-dev
                      ls php-pim-image.tar || docker save -o php-pim-image.tar akeneo/pim-dev/php:8.0
              - save_cache:
                  name: Save PHP docker image cache
                  key: php-docker-image-{{ checksum "~/php-docker-image.hash" }}
                  paths:
                      - php-pim-image.tar
      - unless:
            condition: << parameters.is_ee_built >>
            steps:
              - run:
                  name: Save the CE image as a tar
                  command: |
                      docker pull akeneo/pim-php-dev:6.0
                      docker save -o php-pim-image.tar akeneo/pim-php-dev:6.0
      - run:
          name: Setup tests results folder and log folder
          command: mkdir -p var/tests/phpspec var/tests/csfixer var/logs var/tests/screenshots ~/.cache/yarn ~/.cache/Cypress ~/.composer
      - run:
            name: Creating cache key for JS and PHP dependencies
            command: |
                cat yarn.lock > ~/front-dependency.hash && date +%F >> ~/front-dependency.hash
                cat composer.json > ~/back-dependency.hash && date +%F >> ~/back-dependency.hash
      - restore_cache:
            name: Restore cache - yarn and Cypress dependency cache
            keys:
                - frontend-dependency-cache-{{ checksum "~/front-dependency.hash" }}
      - restore_cache:
            name: Restore cache - composer dependency cache
            keys:
                - backend-dependency-cache-{{ checksum "~/back-dependency.hash" }}
      - run:
          name: Change owner on project dir (default user = circleci (1001) and docker needs uid 1000)
          command: |
              sudo chown -R 1000:1000 ../project ~/.composer ~/.cache/
      - run:
          name: Install back and front dependencies
          command: make dependencies
          environment:
            YARN_REGISTRY: "http://registry.yarnpkg.com"
      - run:
          name: Install assets
          command: make assets
      - run:
          name: Build css
          command: make css
      - run:
          name: Create hash for front packages
          # Adding date allows to invalidate the cache each new day, adding front package path avoid conflict between CE build and EE build
          command: |
              find << parameters.path_to_front_packages >>/akeneo-design-system -type f -print0 | sort -z | xargs -0 sha1sum | sha1sum > ~/akeneo-design-system.hash
              find << parameters.path_to_front_packages >>/measurement -type f -print0 | sort -z | xargs -0 sha1sum | sha1sum > ~/measurement.hash
              find << parameters.path_to_front_packages >>/shared -type f -print0 | sort -z | xargs -0 sha1sum | sha1sum > ~/shared.hash
              find << parameters.path_to_front_packages >>/../src/Akeneo/Platform/Job/front/process-tracker -type f -print0 | sort -z | xargs -0 sha1sum | sha1sum > ~/process-tracker.hash
              find << parameters.path_to_front_packages >>/../src/Akeneo/Platform/Bundle/CatalogVolumeMonitoringBundle/front -type f -print0 | sort -z | xargs -0 sha1sum | sha1sum > ~/catalog-volume-monitoring.hash
              echo "$(date +%F) << parameters.path_to_front_packages >>" | tee -a ~/akeneo-design-system.hash ~/measurement.hash ~/shared.hash ~/catalog-volume-monitoring.hash ~/process-tracker.hash
      - run:
          name: Set directories owner to circleci
          command: sudo chown -R 1001:1001 .
      - restore_cache:
            name: Restore front package DSM cache
            key: front-packages-dsm-{{ checksum "~/akeneo-design-system.hash" }}
      - restore_cache:
            name: Restore front package measurement cache
            key: front-packages-measurement-{{ checksum "~/measurement.hash" }}
      - restore_cache:
            name: Restore front package Shared cache
            key: front-packages-shared-{{ checksum "~/shared.hash" }}
      - restore_cache:
            name: Restore micro frontend Process tracker cache
            key: micro-frontend-process-tracker-{{ checksum "~/process-tracker.hash" }}
      - restore_cache:
            name: Restore micro-frontend Catalog Volume Monitoring cache
            key: micro-frontend-catalog-volume-monitoring-{{ checksum "~/catalog-volume-monitoring.hash" }}
      - run:
          name: Set directories owner to docker
          command: sudo chown -R 1000:1000 ../project
      - run:
          name: Build front-packages
          command: make front-packages
      - run:
          name: Build Javascript
          command: make javascript-dev
      - run:
            name: Change owner on project dir after installing when there is no cache
            command: sudo chmod -R 777 ../project ~/.cache ~/.composer
      - save_cache:
            name: Save frontend dependency cache
            paths:
                - ~/.cache
            key: frontend-dependency-cache-{{ checksum "~/front-dependency.hash" }}
      - save_cache:
            name: Save backend dependency cache
            paths:
                - ~/.composer
            key: backend-dependency-cache-{{ checksum "~/back-dependency.hash" }}
      - save_cache:
            name: Save front package DSM cache
            key: front-packages-dsm-{{ checksum "~/akeneo-design-system.hash" }}
            paths:
                - << parameters.path_to_front_packages >>/akeneo-design-system/
      - save_cache:
            name: Save front package measurement cache
            key: front-packages-measurement-{{ checksum "~/measurement.hash" }}
            paths:
                - << parameters.path_to_front_packages >>/measurement/
      - save_cache:
            name: Save front package Shared cache
            key: front-packages-shared-{{ checksum "~/shared.hash" }}
            paths:
                - << parameters.path_to_front_packages >>/shared/
      - save_cache:
            name: Save micro frontend Process Tracker cache
            key: micro-frontend-process-tracker-{{ checksum "~/process-tracker.hash" }}
            paths:
                - << parameters.path_to_front_packages >>/../src/Akeneo/Platform/Job/front/process-tracker
      - save_cache:
            name: Save micro-frontend Catalog Volume Monitoring cache
            key: micro-frontend-catalog-volume-monitoring-{{ checksum "~/catalog-volume-monitoring.hash" }}
            paths:
                - << parameters.path_to_front_packages >>/../src/Akeneo/Platform/Bundle/CatalogVolumeMonitoringBundle/front
      - persist_to_workspace:
          root: ~/
          paths:
            - project

  test_back_static_and_acceptance:
      machine:
          image: ubuntu-2004:202101-01
      steps:
          - attach_workspace:
                at: ~/
          - run:
                name: Change owner on project dir (default user = circleci (1001) and docker needs uid 1000)
                command: sudo chown -R 1000:1000 ../project
          - run:
                name: No legacy translation format
                command: PIM_CONTEXT=test make find-legacy-translations
          - run:
                name: Load archived docker image
                command: docker load -i php-pim-image.tar
          - run:
                name: Static tests
                command: PIM_CONTEXT=test make static-back
          - run:
                name: Analyzes source code to flag programming errors, bugs, stylistic errors, and suspicious constructs
                command: PIM_CONTEXT=test make lint-back
          - run:
                name: Code Coupling Detection
                command: PIM_CONTEXT=test make coupling-back
          - run:
                name: Unit tests
                command: PIM_CONTEXT=test make unit-back
          - run:
                name: Acceptance tests
                command: PIM_CONTEXT=test make acceptance-back
          - store_test_results:
                path: var/tests
          - store_artifacts:
                path: var/tests
          - store_artifacts:
                path: var/logs

  test_back_phpunit:
      machine:
          image: ubuntu-2004:202101-01
      parallelism: 20
      steps:
          - attach_workspace:
                at: ~/
          - run:
                name: Change owner on project dir in order to archive the project into the workspace
                command: sudo chown -R 1000:1000 ../project
          - run:
                name: Start containers
                command: |
                    docker load -i php-pim-image.tar
                    APP_ENV=test C='fpm mysql elasticsearch object-storage pubsub-emulator' make up
                    docker/wait_docker_up.sh
          - run:
                name: Install database
                command: APP_ENV=test make database
          - run:
                name: PhpUnit Integration
                command: PIM_CONTEXT=test make pim-integration-back
          - run:
                name: PhpUnit End to end
                command: PIM_CONTEXT=test make end-to-end-back
          - store_test_results:
                path: var/tests/phpunit
          - store_artifacts:
                path: var/tests/phpunit
          - store_artifacts:
                path: var/logs

  cypress_sanity_checks:
    machine:
      image: ubuntu-1604:201903-01
    resource_class: large
    steps:
      - attach_workspace:
          at: ~/
      - run:
          name: Change owner on project dir in order to archive the project into the workspace
          command: sudo chown -R 1000:1000 ../project
      - run:
          name: Create yarn cache folder
          command: mkdir -p  ~/.cache/yarn
      - run:
          name: Change owner on project dir (default user = circleci (1001) and docker needs uid 1000)
          command: sudo chown -R 1000:1000 ../project ~/.cache/yarn
      - run:
          name: Start containers
          command: |
            docker load -i php-pim-image.tar
            APP_ENV=prod C='fpm mysql elasticsearch httpd object-storage pubsub-emulator' make up
            docker/wait_docker_up.sh
      - run:
          name: Install database
          command: APP_ENV=prod O="--catalog src/Akeneo/Platform/Bundle/InstallerBundle/Resources/fixtures/icecat_demo_dev" make database
      - run:
          name: Launch Cypress
          command: CYPRESS_defaultCommandTimeout=10000 CYPRESS_requestTimeout=15000 CYPRESS_responseTimeout=50000 make end-to-end-front
      - store_artifacts:
          path: cypress/screenshots
      - store_artifacts:
          path: cypress/videos

  marketplace_activate_e2e:
    machine:
      image: ubuntu-2004:202101-01
    steps:
      - attach_workspace:
          at: ~/
      - run:
          name: Change owner on project dir in order to archive the project into the workspace
          command: sudo chown -R 1000:1000 ../project
      - run:
          name: Start containers
          command: |
            docker load -i php-pim-image.tar
            APP_ENV=behat C='fpm mysql elasticsearch httpd object-storage selenium pubsub-emulator' make up
            docker/wait_docker_up.sh
      - run:
          name: Install database
          command: APP_ENV=behat make database
      - run:
          name: End to end Behat tests
          command: PIM_CONTEXT=test make connectivity-connection-activate-e2e
      - store_test_results:
          path: var/tests/behat
      - store_artifacts:
          path: var/tests/behat
      - store_artifacts:
          path: var/logs
      - store_artifacts:
          path: var/tests/screenshots

  test_octopus_code_quality:
    machine:
      image: ubuntu-2004:202101-01
    steps:
      - attach_workspace:
          at: ~/
      - run:
          name: Change owner on project dir (default user = circleci (1001) and docker needs uid 1000)
          command: sudo chown -R 1000:1000 ../project
      - run:
          name: PHP Insights results
          command: make connectivity-connection-insight O='src/Akeneo/Connectivity/Connection/back/Domain src/Akeneo/Connectivity/Connection/back/Application src/Akeneo/Connectivity/Connection/back/Infrastructure'
      - run:
          name: PSALM results
          command: make connectivity-connection-psalm || true
      - run:
          name: Start containers
          command: |
            docker load -i php-pim-image.tar
            APP_ENV=test C='fpm mysql elasticsearch object-storage pubsub-emulator' make up
            docker/wait_docker_up.sh
      - run:
          name: Install database
          command: APP_ENV=test make database
      - run:
          name: Compute code coverage of all tests
          command: PIM_CONTEXT=test make connectivity-connection-coverage
      - store_artifacts:
          path: coverage/Connectivity/Back/Global/

  test_back_behat_legacy:
    machine:
        image: ubuntu-2004:202101-01
    parallelism: 40
    steps:
      - attach_workspace:
          at: ~/
      - run:
          name: Get Behat Suite name to run
          command: |
            TESTSUITE=$(echo $CIRCLE_BRANCH | sed -e 's/^.*-\([^-]*\)$/\1/g')
            if ! [[ $TESTSUITE =~ ^(weasel|chipmunk|raccoon)$ ]] ; then
              TESTSUITE="all"
            fi
            echo "Behat Suite to run: "$TESTSUITE
            echo "export TESTSUITE=$TESTSUITE" >> $BASH_ENV
      - run:
          name: Change owner on project dir in order to archive the project into the workspace
          command: sudo chown -R 1000:1000 ../project
      - run:
          name: Start containers
          command: |
            docker load -i php-pim-image.tar
            APP_ENV=behat C='fpm mysql elasticsearch httpd object-storage selenium pubsub-emulator' make up
            docker/wait_docker_up.sh
      - run:
          name: Install database
          command: APP_ENV=behat make database
      - run:
          name: End to end Behat tests
          command: PIM_CONTEXT=test make end-to-end-legacy SUITE=$TESTSUITE
      - run:
          name: Gather Junit test result files in the same directory to improve the render of failing tests
          command: |
              set -e
              cd var/tests/behat
              sudo chmod -R 777 .
              for subdir in */*; do mv "${subdir}" "${subdir/\//_}"; done
          when: always
      - store_test_results:
          path: var/tests/behat
      - store_artifacts:
          path: var/tests/behat
      - store_artifacts:
          path: var/logs
      - store_artifacts:
          path: var/tests/screenshots

  pull_request_success:
      docker:
          - image: alpine/git
      steps:
          - run:
              name: Success
              command: echo "The build has run with success! Let's merge :)"

  test_front_static_acceptance_and_integration:
      machine:
          image: ubuntu-2004:202101-01
      steps:
        - attach_workspace:
            at: ~/
        - run:
              name: Create yarn cache folder
              command: mkdir -p  ~/.cache/yarn
        - run:
              name: Change owner on project dir (default user = circleci (1001) and docker needs uid 1000)
              command: sudo chown -R 1000:1000 ../project ~/.cache/yarn
        - run:
            name: Front type checking
            command: make javascript-dev-strict
        - run:
            name: Front linter
            command: PIM_CONTEXT=test make lint-front
        - run:
            name: Front unit tests
            command: PIM_CONTEXT=test make unit-front

  test_back_performance:
    machine:
        image: ubuntu-2004:202101-01
    steps:
      - attach_workspace:
          at: ~/
      - run:
          name: Change owner on project dir (default user = circleci (1001) and docker needs uid 1000)
          command: sudo chown -R 1000:1000 ../project
      - run:
          name: Start containers
          command: |
            export ES_JAVA_OPTS='-Xms2g -Xmx2g'
            docker load -i php-pim-image.tar
            APP_ENV=test APP_DEBUG=false C='fpm mysql httpd elasticsearch object-storage blackfire pubsub-emulator' make up
            docker/wait_docker_up.sh
      - run:
          name: Run performance tests
          command: APP_ENV=test .circleci/run_performance_tests.sh
      - store_test_results:
          path: var/tests/phpunit
      - store_artifacts:
          path: var/tests/phpunit
      - store_artifacts:
          path: var/logs

  build_prod:
      parameters:
          is_ee_built:
              type: boolean
              default: true
      environment:
        <<: *envVarsDeployDev
      machine:
          image: ubuntu-2004:202101-01
      resource_class: medium
      working_directory: ~/project
      steps:
          - attach_workspace:
                at: ~/
          - add_ssh_keys:
              fingerprints:
                  - "1f:25:f8:bb:59:52:95:f6:e2:f2:97:2f:30:d4:e9:66"
          - set_gcloud_config_dev
          - restore_persisted_env_vars
          - run:
              name: Define value for next steps
              command: |
                TYPE="srnt"
                TYPE_LONG="serenity"
                IMAGE_TAG=${CIRCLE_SHA1}
                IMAGE_TAG_SHORTED=$(echo ${IMAGE_TAG} | cut -c -7)
                IMAGE_TAG_DATE=$(date +%Y%m%d%H%M%S)
                RELEASE_NAME="v$(date +%Y%m%d%H%M%S)"
                PRODUCT_REFERENCE_TYPE="serenity_instance"
                PRODUCT_REFERENCE_CODE="serenity_${ENV_NAME}"

                echo export TYPE=${TYPE} >> $BASH_ENV
                echo export TYPE_LONG=${TYPE_LONG} >> $BASH_ENV
                echo export IMAGE_TAG=${IMAGE_TAG} >> $BASH_ENV
                echo export IMAGE_TAG_SHORTED=${IMAGE_TAG_SHORTED} >> $BASH_ENV
                echo export IMAGE_TAG_DATE=${IMAGE_TAG_DATE} >> $BASH_ENV
                echo export RELEASE_NAME=${RELEASE_NAME} >> $BASH_ENV
                echo export PRODUCT_REFERENCE_TYPE=${PRODUCT_REFERENCE_TYPE} >> $BASH_ENV
                echo export PRODUCT_REFERENCE_CODE=${PRODUCT_REFERENCE_CODE} >> $BASH_ENV

                echo "Image tag: ${IMAGE_TAG}"
                echo "Serenity release name: ${RELEASE_NAME}"
          - run:
              name: Build the Serenity Edition prod image
              command: make -C deployments/ php-image-prod
          - run:
              name: Push the Serenity Edition prod image on docker registry
              command: make -C deployments/ push-php-image-prod
          - run:
              name: Push Terraform modules to GCS
              command: |
                BOTO_CONFIG=/dev/null gsutil -m cp -r deployments/ gs://akecld-terraform-modules/serenity-edition-dev/${IMAGE_TAG}/
          - run:
              name: Persist env vars for next jobs
              command: |
                echo export TYPE=${TYPE} > persisted_env_vars
                echo export TYPE_LONG=${TYPE_LONG} >> persisted_env_vars
                echo export IMAGE_TAG=${IMAGE_TAG} >> persisted_env_vars
                echo export IMAGE_TAG_SHORTED=${IMAGE_TAG_SHORTED} >> persisted_env_vars
                echo export IMAGE_TAG_DATE=${IMAGE_TAG_DATE} >> persisted_env_vars
                echo export RELEASE_NAME=${RELEASE_NAME} >> persisted_env_vars
                echo export PRODUCT_REFERENCE_TYPE=${PRODUCT_REFERENCE_TYPE} >> persisted_env_vars
                echo export PRODUCT_REFERENCE_CODE=${PRODUCT_REFERENCE_CODE} >> persisted_env_vars
          - persist_to_workspace:
              root: ~/
              paths:
                - project/persisted_env_vars

  test_deploy:
      environment:
        <<: *envVarsDeployDev
      <<: *dockerCloudDeployer
      resource_class: medium
      steps:
          - attach_workspace:
                at: ~/
          - add_ssh_keys:
                fingerprints:
                    - "1f:25:f8:bb:59:52:95:f6:e2:f2:97:2f:30:d4:e9:66"
          - set_gcloud_config_dev
          - restore_persisted_env_vars
          - run:
              name: Define value for next steps
              command: |
                INSTANCE_NAME_PREFIX=pimci
                INSTANCE_NAME=${INSTANCE_NAME_PREFIX}-${IMAGE_TAG_SHORTED}-${CIRCLE_BUILD_NUM}

                echo export INSTANCE_NAME_PREFIX=${INSTANCE_NAME_PREFIX} >> $BASH_ENV
                echo export INSTANCE_NAME=${INSTANCE_NAME} >> $BASH_ENV

                echo "Instance name prefix: ${INSTANCE_NAME_PREFIX}"
                echo "Instance name: ${INSTANCE_NAME}"
                echo "Image tag: ${IMAGE_TAG}"
          - run:
              name: DATADOG deployment Livetail logs page
              command: echo "https://app.datadoghq.eu/logs/livetail?query=kube_namespace%3A${TYPE}-${INSTANCE_NAME}"
          - run:
              name: Deploy PIM on kubernetes
              command: |
                  NS=${TYPE}-${INSTANCE_NAME} PHASE=install bash deployments/bin/deployments_poll_up.sh 2>&1 >> deployment.log &
                  ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts
                  export GIT_SSH_COMMAND='ssh -i ~/.ssh/id_rsa_1f25f8bb595295f6e2f2972f30d4e966 -o UserKnownHostsFile=~/.ssh/known_hosts -o IdentitiesOnly=Yes'
                  make -C deployments/ deploy-instance
                  make -C deployments/ commit-instance
          - run:
              name: Test PIM connexion on kubernetes
              command: make -C deployments/ test-prod
          - run:
              name: Display Deployment Errors
              command: cat deployment.log
              when: on_fail
          - run:
              name: Prepare infrastructure artifacts
              command: make -C deployments/ prepare-infrastructure-artifacts
              when: on_fail
          - store_artifacts:
              path: ~/artifacts/infra
          - store_artifacts:
              path: deployment.log
              destination: test_deploy_srnt_deployment.log
          - persist_to_workspace:
              root: ~/
              paths:
                - upgrades.tfplan.json
          - run:
              name: Remove env on kubernetes
              command: |
                  ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts
                  export GIT_SSH_COMMAND='ssh -i ~/.ssh/id_rsa_1f25f8bb595295f6e2f2972f30d4e966 -o UserKnownHostsFile=~/.ssh/known_hosts -o IdentitiesOnly=Yes'
                  make -C deployments/ uncommit-instance
              when: always

  deploy_pr_environment:
      environment:
          <<: *envVarsDeployDev
      <<: *dockerCloudDeployer
      resource_class: small
      steps:
          - attach_workspace:
                at: ~/
          - add_ssh_keys:
                fingerprints:
                    - "1f:25:f8:bb:59:52:95:f6:e2:f2:97:2f:30:d4:e9:66"
          - set_gcloud_config_dev
          - restore_persisted_env_vars
          - run:
              name: Define value for next steps
              command: |
                INSTANCE_NAME_PREFIX=pimci-pr
                INSTANCE_NAME=${INSTANCE_NAME_PREFIX}-${CIRCLE_PULL_REQUEST##*/}
                ACTIVATE_MONITORING=true

                echo export IMAGE_TAG=${IMAGE_TAG} >> $BASH_ENV
                echo export INSTANCE_NAME_PREFIX=${INSTANCE_NAME_PREFIX} >> $BASH_ENV
                echo export INSTANCE_NAME=${INSTANCE_NAME} >> $BASH_ENV
                echo export PRODUCT_REFERENCE_TYPE=${PRODUCT_REFERENCE_TYPE} >> $BASH_ENV
                echo export PRODUCT_REFERENCE_CODE=${PRODUCT_REFERENCE_CODE} >> $BASH_ENV
                echo export ACTIVATE_MONITORING=${ACTIVATE_MONITORING} >> $BASH_ENV

                echo "Instance name prefix: ${INSTANCE_NAME_PREFIX}"
                echo "Instance name: ${INSTANCE_NAME}"
                echo "Image tag: ${IMAGE_TAG}"
          - run:
              name: DATADOG deployment Livetail logs page
              command: echo "https://app.datadoghq.eu/logs/livetail?query=kube_namespace%3A${TYPE}-${INSTANCE_NAME}"
          - run:
              name: Check Circle CI PR
              command: |
                if [[ ${CIRCLE_PULL_REQUEST##*/} == "" ]]; then echo "ERROR : CIRCLE_PULL_REQUEST is empty."; exit 1;fi
                echo "This environment will be available at https://${INSTANCE_NAME}.dev.cloud.akeneo.com once deployed :)"
          - run:
              name: Deploy PR environment
              command: |
                NS=${TYPE}-${INSTANCE_NAME} PHASE=install bash deployments/bin/deployments_poll_up.sh 2>&1 >> deployment.log &
                ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts
                export GIT_SSH_COMMAND='ssh -i ~/.ssh/id_rsa_1f25f8bb595295f6e2f2972f30d4e966 -o UserKnownHostsFile=~/.ssh/known_hosts -o IdentitiesOnly=Yes'
                make -C deployments/ deploy-instance
                make -C deployments/ commit-instance
          - run:
              name: Persist env vars for next jobs
              command: |
                echo export INSTANCE_NAME_PREFIX=${INSTANCE_NAME_PREFIX} >> persisted_env_vars
                echo export INSTANCE_NAME=${INSTANCE_NAME} >> persisted_env_vars
                echo export ACTIVATE_MONITORING=${ACTIVATE_MONITORING} >> persisted_env_vars
          - persist_to_workspace:
              root: ~/
              paths:
                - project/persisted_env_vars
          - run:
              name: Prepare infrastructure artifacts
              command: make -C deployments/ prepare-infrastructure-artifacts
              when: on_fail
          - store_artifacts:
              path: ~/artifacts/infra
          - run:
              name: Remove env on kubernetes
              command: make -C deployments/ uncommit-instance
              when: on_fail

  delete_pr_environment:
      environment:
          <<: *envVarsDeployDev
      <<: *dockerCloudDeployer
      steps:
          - attach_workspace:
                at: ~/
          - add_ssh_keys:
                fingerprints:
                    - "1f:25:f8:bb:59:52:95:f6:e2:f2:97:2f:30:d4:e9:66"
          - set_gcloud_config_dev
          - restore_persisted_env_vars
          - run:
                name: Delete environments
                no_output_timeout: 30m
                command: |
                    ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts
                    export GIT_SSH_COMMAND='ssh -i ~/.ssh/id_rsa_1f25f8bb595295f6e2f2972f30d4e966 -o UserKnownHostsFile=~/.ssh/known_hosts -o IdentitiesOnly=Yes'

                    make -C deployments/ uncommit-instance

  test_back_missing_structure_migrations:
      machine:
        image: ubuntu-2004:202101-01
      steps:
        -   attach_workspace:
                at: ~/
        -   run:
                name: Load php image
                command: |
                    docker load -i php-pim-image.tar
                    APP_ENV=test C='mysql elasticsearch object-storage pubsub-emulator' make up
                    docker/wait_docker_up.sh
        -   run:
                name: Restore permissions on files
                command: git checkout -- .
        -   run:
                name: Restore permissions on vendor files
                command: |
                    cd vendor/akeneo/pim-community-dev
                    git checkout -- .
        -   run:
                name: Change owner on project dir after restoring cache
                command: sudo chown -R 1000:1000 ../project
        -   run:
                name: Test missing database and index structure migrations
                command: vendor/akeneo/pim-community-dev/.circleci/detect_structure_changes.sh $CIRCLE_BRANCH

  test_back_data_migrations:
      machine:
          image: ubuntu-2004:202101-01
      steps:
          - attach_workspace:
                at: ~/
          - run:
                name: Change owner on project dir in order to archive the project into the workspace
                command: sudo chown -R 1000:1000 ../project
          - run:
                name: Start containers
                command: |
                    docker load -i php-pim-image.tar
                    APP_ENV=test C='fpm mysql elasticsearch object-storage pubsub-emulator' make up
                    docker/wait_docker_up.sh
          - run:
                name: Install database
                command: APP_ENV=test make database
          - run:
                name: PhpUnit Migration
                command: PIM_CONTEXT=test make migration-back
          - store_test_results:
                path: var/tests/phpunit
          - store_artifacts:
                path: var/tests/phpunit
          - store_artifacts:
                path: var/logs

  test_onboarder_bundle:
      machine:
          image: ubuntu-2004:202101-01
      environment:
          FLAG_ONBOARDER_ENABLED: 1
      steps:
          - attach_workspace:
                at: ~/
          - run:
                name: Change owner on project dir in order to archive the project into the workspace
                command: |
                  mkdir -p ~/.cache/yarn ~/.composer
                  sudo chown -R 1000:1000 ../project
                  sudo chown -R 1000:1000 ~/.composer
                  sudo chown -R 1000:1000 ~/.cache/yarn
          - run:
                name: Create an empty service account
                command: |
                    mkdir secret
                    echo "{}" > secret/serviceAccount.json
          - run:
                name: Load php pim image
                command: docker load -i php-pim-image.tar
          - run:
                name: Load make commands
                command: cp vendor/akeneo/pim-onboarder/onboarder.mk make-file/onboarder.mk
          - run:
                name: Require onboarder tests dependencies
                command: PIM_CONTEXT=onboarder make add-bundle-specific-dev-dependencies
          - run:
                name: Composer update for tests dependencies
                command: docker-compose run -u www-data --rm php php -d memory_limit=4G /usr/local/bin/composer update --no-interaction
          - run:
                name: Add configuration files to run the bundle tests from the PIM
                command: |
                    rm -f docker-compose.override.yml
                    PIM_VERSION=master SETUP_FOR_CI=1 PIM_CONTEXT=onboarder make setup-onboarder-parameters
                    PIM_VERSION=master PIM_CONTEXT=onboarder make setup-onboarder-tests
                    docker-compose run --rm php php /usr/local/bin/composer dumpautoload
          - run:
                name: Change owner of PIM as some files have been created with wrong owner
                command: sudo chown -R 1000:1000 ~/project
          - run:
                name: Execute static analysis
                command: PIM_CONTEXT=onboarder make test-static-analysis
          - run:
                name: PHP coupling detector
                command: PIM_CONTEXT=onboarder make test-coupling-detector
          - run:
                name: Start containers
                command: |
                    APP_ENV=test C='mysql elasticsearch object-storage pubsub-emulator' make up
                    docker/wait_docker_up.sh
          - run:
                name: Execute specifications
                command: PIM_CONTEXT=onboarder make test-spec
          - run:
                name: Install Akeneo PIM with Onboarder specific configuration (channel, attribute, ...)
                command: ENVIRONMENT=test SETUP_FOR_CI=1 PIM_CONTEXT=onboarder make onboarder-install
          - run:
                name: Execute acceptance tests
                command: PIM_CONTEXT=onboarder make test-acceptance
          - run:
                name: Execute PHPUnit integration tests
                command: PIM_CONTEXT=onboarder make test-integration
          - run:
                name: Start Apache/FPM and Selenium for End to End tests
                command: PIM_CONTEXT=onboarder make up APP_ENV=behat C='fpm httpd selenium'
          - run:
                name: Execute end-to-end tests
                command: PIM_CONTEXT=onboarder make test-end-to-end
          - run:
              name: Restart FPM with Onboarder feature turned off
              command: PIM_CONTEXT=onboarder make up APP_ENV=behat FLAG_ONBOARDER_ENABLED=0 C='fpm'
          - run:
              name: Execute end-to-end "Onboarder feature disabled" tests
              command: PIM_CONTEXT=onboarder make test-end-to-end-onboarder-disabled
          - store_test_results:
                path: ~/project/pim/var/tests
          - store_artifacts:
                path: ~/project/pim/var/tests
          - store_artifacts:
                path: ~/project/pim/var/logs

  test_database:
      machine:
          image: ubuntu-2004:202010-01
      parallelism: 1
      steps:
          - attach_workspace:
                at: ~/
          - run:
                name: Change owner on project dir in order to archive the project into the workspace
                command: sudo chown -R 1000:1000 ../project
          - run:
                name: Start containers
                command: |
                    docker load -i php-pim-image.tar
                    APP_ENV=test C='fpm mysql elasticsearch object-storage pubsub-emulator' make up
                    docker/wait_docker_up.sh
          - run:
                name: Install database
                command: APP_ENV=dev make database
          - run:
              name: Database test
              command: APP_ENV=dev PIM_CONTEXT=test make test-database-structure

workflows:
  version: 2
  pull_request:
      when:
          not:
              equal: [ scheduled_pipeline, << pipeline.trigger_source >> ]
      jobs:
          - ready_to_build?:
                type: approval
                filters:
                    branches:
                        ignore:
                            - master
          - checkout_ee:
                requires:
                    - ready_to_build?
          - build_dev:
                path_to_front_packages: vendor/akeneo/pim-community-dev/front-packages
                requires:
                    - checkout_ee
          - build_prod:
                requires:
                    - checkout_ee
          - test_deploy:
                requires:
                    - build_prod
          - deploy_pr_environment?:
                type: approval
                filters:
                    branches:
                        ignore:
                            - master
          - deploy_pr_environment:
                requires:
                    - deploy_pr_environment?
                    - build_prod
          - delete_pr_environment?:
                type: approval
                filters:
                    branches:
                        ignore:
                            - master
                requires:
                    - deploy_pr_environment
          - delete_pr_environment:
                requires:
                    - delete_pr_environment?
          - test_database:
                requires:
                    - build_dev
          - test_back_static_and_acceptance:
                requires:
                    - build_dev
          - test_front_static_acceptance_and_integration:
                requires:
                    - build_dev
          - test_back_phpunit:
                requires:
                    - build_dev
          - test_back_performance:
                requires:
                    - build_dev
          - test_onboarder_bundle:
                requires:
                    - build_dev
          - test_back_data_migrations:
                requires:
                    - test_back_static_and_acceptance
                    - test_front_static_acceptance_and_integration
                    - test_back_phpunit
          - test_back_behat_legacy:
                requires:
                    - test_back_static_and_acceptance
                    - test_front_static_acceptance_and_integration
                    - test_back_phpunit
          - ready_to_build_only_ce?:
                type: approval
                filters:
                    branches:
                        ignore:
                            - master
          - checkout_ce:
                requires:
                    - ready_to_build_only_ce?
          - build_dev:
                name: build_dev_ce
                is_ee_built: false
                requires:
                    - checkout_ce
          - cypress_sanity_checks:
                name: cypress_sanity_checks_ce
                requires:
                  - build_dev_ce
          - marketplace_activate_e2e?:
                type: approval
                filters:
                    branches:
                        ignore:
                            - master
          - marketplace_activate_e2e:
                name: marketplace_activate_e2e_ce
                requires:
                  - marketplace_activate_e2e?
                  - build_dev_ce
          - test_back_static_and_acceptance:
                name: test_back_static_and_acceptance_ce
                requires:
                    - build_dev_ce
          - test_front_static_acceptance_and_integration:
                name: test_front_static_acceptance_and_integration_ce
                requires:
                    - build_dev_ce
          - test_back_phpunit:
                name: test_back_phpunit_ce
                requires:
                    - build_dev_ce
          - test_back_data_migrations:
                name: test_back_data_migrations_ce
                requires:
                    - test_back_phpunit_ce
          - test_back_behat_legacy:
                name: test_back_behat_legacy_ce
                requires:
                    - test_back_static_and_acceptance_ce
                    - test_front_static_acceptance_and_integration_ce
                    - test_back_phpunit_ce
          - pull_request_success:
                requires:
                    - test_back_behat_legacy
                    - test_back_performance
                    - test_back_data_migrations
                    - test_onboarder_bundle
                    - test_database
                    - test_back_behat_legacy_ce

  nightly:
      when:
          and:
              - equal: [ scheduled_pipeline, << pipeline.trigger_source >> ]
              - equal: [ "nightly_master", << pipeline.schedule.name >> ]
      jobs:
          - checkout_ce
          - build_dev:
                <<: *slack-fail-post-step
                is_ee_built: false
                requires:
                    - checkout_ce
          - test_back_static_and_acceptance:
                <<: *slack-fail-post-step
                requires:
                    - build_dev
          - test_front_static_acceptance_and_integration:
                <<: *slack-fail-post-step
                requires:
                    - build_dev
          - test_back_phpunit:
                <<: *slack-fail-post-step
                requires:
                    - build_dev
          - test_back_behat_legacy:
                <<: *slack-fail-post-step
                requires:
                    - build_dev
          - test_back_data_migrations:
                <<: *slack-fail-post-step
                requires:
                    - build_dev

  weekly_octopus_code_quality:
    when:
        and:
            - equal: [ scheduled_pipeline, << pipeline.trigger_source >> ]
            - equal: [ "weekly_octopus_code_quality", << pipeline.schedule.name >> ]
    jobs:
      - checkout_ce
      - build_dev:
          is_ee_built: false
          requires:
            - checkout_ce
      - test_octopus_code_quality:
          requires:
            - build_dev

  on_demand:
        when:
            not:
                equal: [ scheduled_pipeline, << pipeline.trigger_source >> ]
        jobs:
          - ready_to_build?:
                type: approval
                filters:
                    branches:
                        only: master
          - checkout_ce:
                requires:
                    - ready_to_build?
          - build_dev:
                is_ee_built: false
                requires:
                    - checkout_ce
          - test_back_static_and_acceptance:
                requires:
                    - build_dev
          - test_front_static_acceptance_and_integration:
                requires:
                    - build_dev
          - test_back_phpunit:
                requires:
                    - build_dev
          - test_back_behat_legacy:
                requires:
                    - build_dev
          - test_back_data_migrations:
                requires:
                    - build_dev

commands:
  set_gcloud_config_dev:
    description: "Authenticate on GCP services and set config and key to be used by other tools that need to authenticate."
    steps:
      - run:
          name: "Set Gcloud Config."
          shell: "/bin/bash -eo pipefail"
          command: |
            echo ${GCLOUD_SERVICE_KEY_DEV} | gcloud auth activate-service-account --key-file=-
            gcloud config set project ${GOOGLE_PROJECT_ID}
            gcloud config set compute/zone ${GOOGLE_COMPUTE_ZONE}
            gcloud container clusters get-credentials ${GOOGLE_COMPUTE_ZONE} --project=${GOOGLE_PROJECT_ID} --zone=${GOOGLE_COMPUTE_ZONE}
            echo ${GCLOUD_SERVICE_KEY_DEV} > ${HOME}/gcloud-service-key.json
            echo 'export GOOGLE_APPLICATION_CREDENTIALS="${HOME}/gcloud-service-key.json"' >> $BASH_ENV
            export GOOGLE_APPLICATION_CREDENTIALS="${HOME}/gcloud-service-key.json"
            gcloud auth configure-docker --quiet

  restore_persisted_env_vars:
    description: "Restore env vars that have been persisted by the previous job."
    steps:
      - run:
          name: Restore persisted env vars
          command: |
            echo "Persisted env vars:"
            cat persisted_env_vars
            cat persisted_env_vars >> $BASH_ENV

  install_yq:
    description: "Install yq"
    steps:
      - run:
          name: Install yq
          command: |
            wget https://github.com/mikefarah/yq/releases/download/3.3.1/yq_linux_386
            sudo mv yq_linux_386 /usr/local/bin/yq
            echo "e7fa464149a450d068311a244f403757408a745b  /usr/local/bin/yq" > /tmp/checksum
            sha1sum -c /tmp/checksum
            sudo chmod +x /usr/local/bin/yq
