workflows:
    ucs:
      when:
          not:
              equal: [ scheduled_pipeline, << pipeline.trigger_source >> ]
      jobs:
          - ready_to_build?:
                type: approval
                filters:
                    branches:
                        only:
                            - /BH-.*/
                            - /PH-.*/
          - checkout:
                requires:
                    - ready_to_build?
          - build_ucs:
                requires:
                    - checkout
          # - test_deploy_ucs_pim:
          #       name: deploy_ucs_auto_pim
          #       PIM_NAMESPACE_PREFIX: "pim-auto"
          #       requires:
          #         - build_ucs
          # - delete_ucs_pim:
          #       name: delete_auto_pim
          #       PIM_NAMESPACE_PREFIX: "pim-auto"
          #       requires:
          #         - deploy_ucs_auto_pim
          - test_deploy_ucs_pim:
                requires:
                    - build_ucs
          - deploy_tenant?:
              type: approval
              filters:
                branches:
                  only:
                    - /BH-.*/
                    - /PH-.*/
              requires:
                - test_deploy_ucs_pim
          - test_deploy_timmy:
                requires:
                    - deploy_tenant?
          - test_deploy_ucs_tenant:
                name: "test_deploy_ucs_tenant"
                requires:
                    - test_deploy_timmy
          - delete_ucs_tenant?:
                type: approval
                filters:
                    branches:
                        only:
                            - /BH-.*/
                            - /PH-.*/
                requires:
                    - test_deploy_ucs_tenant
          - delete_ucs_tenant:
                requires:
                    - delete_ucs_tenant?
          - delete_timmy:
                requires:
                    - delete_ucs_tenant
          - delete_ucs_pim?:
                type: approval
                filters:
                    branches:
                        only:
                            - /BH-.*/
                            - /PH-.*/
                requires:
                    - test_deploy_ucs_pim
          - delete_ucs_pim:
                requires:
                    - delete_ucs_pim?

          - ready_to_build_without_build?:
                type: approval
                filters:
                    branches:
                        only:
                            - /BH-.*/
                            - /PH-.*/
          - checkout:
                name: checkout_without_build
                requires:
                    - ready_to_build_without_build?
          - build_ucs_env_vars:
                name: build_ucs_without_build
                requires:
                    - checkout_without_build
          # - test_deploy_ucs_pim:
          #       name: test_deploy_ucs_pim_auto_without_build
          #       PIM_NAMESPACE_PREFIX: "pim-auto"
          #       requires:
          #         - build_ucs_without_build
          # - delete_ucs_pim:
          #     name: "delete_ucs_pim_auto_without_build"
          #     PIM_NAMESPACE_PREFIX: "pim-auto"
          #     requires:
          #       - test_deploy_ucs_pim_auto_without_build
          - test_deploy_ucs_pim:
                name: test_deploy_ucs_pim_without_build
                requires:
                    - build_ucs_without_build
          - deploy_tenant_without_build?:
              type: approval
              filters:
                branches:
                  only:
                    - /BH-.*/
                    - /PH-.*/
              requires:
                - test_deploy_ucs_pim_without_build
          - test_deploy_timmy:
                name: test_deploy_timmy_without_build
                requires:
                    - deploy_tenant_without_build?
          - test_deploy_ucs_tenant:
                name: "test_deploy_ucs_tenant_without_build"
                requires:
                    - test_deploy_timmy_without_build
          - delete_tenant_without_test_deploy_timmy?:
                type: approval
                filters:
                    branches:
                        only:
                            - /BH-.*/
                            - /PH-.*/
                requires:
                    - test_deploy_ucs_tenant_without_build
          - delete_ucs_tenant:
                name: "delete_tenant_without_test_deploy_timmy"
                requires:
                    - delete_tenant_without_test_deploy_timmy?
          - delete_timmy:
                name: delete_timmy_without_build
                requires:
                    - delete_tenant_without_test_deploy_timmy
          - delete_ucs_pim_without_build?:
                type: approval
                filters:
                    branches:
                        only:
                            - /BH-.*/
                            - /PH-.*/
                requires:
                    - test_deploy_ucs_pim_without_build
          - delete_ucs_pim:
                name: "delete_ucs_pim_without_build"
                requires:
                    - delete_ucs_pim_without_build?

          - ready_to_build_test_infra?:
                type: approval
                filters:
                    branches:
                        only:
                            - /BH-.*/
                            - /PH-.*/
          - checkout:
                name: ready_to_build_test_infra
                requires:
                    - ready_to_build_test_infra?
          - build_ucs_infra:
                name: build_ucs_infra
                requires:
                    - ready_to_build_test_infra

    ucs_pim_dev:
        when:
            not:
                equal: [ scheduled_pipeline, << pipeline.trigger_source >> ]
        jobs:
            - ready_to_build?:
                  type: approval
                  filters:
                      branches:
                          only:
                              - /PH-.*/
            - checkout:
                  requires:
                      - ready_to_build?
            - build_srnt_dev:
                  requires:
                      - checkout

            # Security tests block
            - security-hunter/detect-secrets-in-latest-commits:
                  name: "Scan secrets in PR commits"
                  requires:
                      - ready_to_build?
            - security-hunter/detect-secrets-in-directory:
                  name: "Scan secrets in directory"
                  requires:
                      - checkout
            - security-hunter/scan-iac-files:
                  name: "Scan terraform files"
                  exclude_rules: "google-storage-enable-ubla"
                  requires:
                      - checkout
            - security-hunter/scan-docker-image:
                  name: "Scan docker image"
                  archive_name: "php-pim-image.tar"
                  image_name: "akeneo/pim-dev/php:8.1"
                  requires:
                      - build_srnt_dev
            # End of security tests

            - test_back_static_and_acceptance:
                  requires:
                      - build_srnt_dev
            - test_back_phpunit:
                  requires:
                      - build_srnt_dev
            - pull_request_success:
                  requires:
                      - test_back_phpunit
                      - test_back_static_and_acceptance
