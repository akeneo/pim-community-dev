parameters:
   akeneo_referenceentity.infrastructure.search.elasticsearch.record_indexer.batch_size: 1000

services:
    # Subscribers
    akeneo_referenceentity.infrastructure.search.elasticsearch.record.subscriber.index_record:
        class: Akeneo\ReferenceEntity\Application\Record\Subscribers\IndexRecordSubscriber
        arguments:
            - '@akeneo_referenceentity.infrastructure.search.elasticsearch.record_indexer'
            - '@akeneo_referenceentity.infrastructure.symfony.command.index_by_reference_entity_in_background'
        tags:
            - { name: kernel.event_subscriber }

    akeneo_referenceentity.infrastructure.search.elasticsearch.record.subscriber.remove_record_from_index:
        class: Akeneo\ReferenceEntity\Application\Record\Subscribers\RemoveRecordFromIndexSubscriber
        arguments:
            - '@akeneo_referenceentity.infrastructure.search.elasticsearch.record_indexer'
        tags:
            - { name: kernel.event_subscriber }

    # Query builder
    akeneo_referenceentity.infrastructure.search.elasticsearch.query_builder:
      class: Akeneo\ReferenceEntity\Infrastructure\Search\Elasticsearch\Record\RecordQueryBuilder
      arguments:
        - '@akeneo_referenceentity.infrastructure.persistence.query.find_required_value_key_collection_for_channel_and_locales'
        - '@akeneo_referenceentity.infrastructure.persistence.query.get_value_key_for_attribute_channel_and_locale'
        - '@akeneo_referenceentity.infrastructure.persistence.repository.attribute'
        - '@akeneo_referenceentity.infrastructure.persistence.query.find_identifiers_by_reference_entity_and_codes'

    # Indexers
    akeneo_referenceentity.infrastructure.search.elasticsearch.record_indexer:
        class: Akeneo\ReferenceEntity\Infrastructure\Search\Elasticsearch\Record\RecordIndexer
        arguments:
            - '@akeneo_referenceentity.client.record'
            - '@akeneo_referenceentity.infrastructure.search.elasticsearch.record_normalizer'
            - '%akeneo_referenceentity.infrastructure.search.elasticsearch.record_indexer.batch_size%'

    akeneo_referenceentity.infrastructure.elasticsearch.update_index_mapping:
      class: Akeneo\Tool\Bundle\ElasticsearchBundle\IndexConfiguration\UpdateIndexMappingWrapper
      public: true
      arguments:
        - '@akeneo_elasticsearch.client_builder'
        - '%index_hosts%'
        - '@akeneo_referenceentity.client.record'

    # Normalizers
    akeneo_referenceentity.infrastructure.search.elasticsearch.record_normalizer:
        class: Akeneo\ReferenceEntity\Infrastructure\Search\Elasticsearch\Record\RecordNormalizer
        arguments:
            - '@akeneo_referenceentity.infrastructure.search.elasticsearch.record.query.find_values_to_index_for_channel_and_locale'
            - '@akeneo_referenceentity.infrastructure.search.elasticsearch.record.query.find_searchable_records'
            - '@akeneo_referenceentity.infrastructure.persistence.query.find_value_keys_by_attribute_type'
            - '@akeneo_referenceentity.infrastructure.persistence.query.find_activated_locales'

    # Query function
    akeneo_referenceentity.infrastructure.search.elasticsearch.record.query.find_activated_locales_per_channels:
        class: Akeneo\ReferenceEntity\Infrastructure\Persistence\Sql\Channel\SqlFindActivatedLocalesPerChannels
        arguments:
            - '@database_connection'

    akeneo_referenceentity.infrastructure.search.elasticsearch.record.query.find_identifiers_for_query:
        class: Akeneo\ReferenceEntity\Infrastructure\Search\Elasticsearch\Record\FindIdentifiersForQuery
        arguments:
            - '@akeneo_referenceentity.client.record'
            - '@akeneo_referenceentity.infrastructure.search.elasticsearch.query_builder'

    akeneo_referenceentity.infrastructure.search.elasticsearch.record.query.count_records:
        class: Akeneo\ReferenceEntity\Infrastructure\Search\Elasticsearch\Record\CountRecords
        arguments:
            - '@akeneo_referenceentity.client.record'

    akeneo_referenceentity.infrastructure.search.elasticsearch.record.query.find_values_to_index_for_channel_and_locale:
       class: Akeneo\ReferenceEntity\Infrastructure\Persistence\Sql\Attribute\SqlFindValueKeysToIndexForAllChannelsAndLocales
       arguments:
           - '@database_connection'
           - '@akeneo.referencentity.infrastructure.persistence.cache.query.find_activated_locales_per_channels'

    akeneo_referenceentity.infrastructure.search.elasticsearch.record.query.find_searchable_records:
       class: Akeneo\ReferenceEntity\Infrastructure\Persistence\Sql\Record\SqlFindSearchableRecords
       arguments:
           - '@database_connection'

    # Commands
    akeneo_referenceentity.infrastructure.symfony.command.index_by_reference_entity_in_background:
        class: Akeneo\ReferenceEntity\Infrastructure\Symfony\Command\IndexByReferenceEntityInBackground
        arguments:
            - '@pim_catalog.command_launcher'
